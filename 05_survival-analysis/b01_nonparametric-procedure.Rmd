---
title: "&#128205; PhÃ¢n TÃ­ch Sá»‘ng SÃ³t Trong Quáº§n Thá»ƒ Äá»“ng Nháº¥t"
subtitle: "(PhÆ°Æ¡ng phÃ¡p phi tham sá»‘)"
author: ğŸ‘¦ğŸ» _A.T_
date: "&#x1F4C5; _`r {
if(!file.exists('date_list.rds')){saveRDS(list(), file = 'date_list.rds')}
update=FALSE
filename=knitr::current_input(dir = FALSE)
mylist <- readRDS(file ='date_list.rds')
if(update|!(filename%in%names(mylist))){
mylist[[filename]]<- format(Sys.Date(),format = '%d-%m-%Y')
saveRDS(mylist, file = 'date_list.rds')}
readRDS(file ='date_list.rds')[[filename]]  }`_"
output: 
    bookdown::html_document2:
      fig_caption: yes
      theme: default
      highlight: tango
      toc: true
      toc_float: 
        collapsed: false
      toc_depth: 3
      code_folding: hide
      css: "../00_supp/style.css"
      number_sections: true
      includes:
        in_header: "../00_supp/header.html"
        before_body: "test.html"
fontsize: 12pt
bibliography: ["citation.bib"]
csl: "../00_supp/apa.csl"
link-citations: true
params:
  publish: FALSE
---

```{css, echo = F}
/*----------LOGO above TOC---------*/

#TOC::before {
  content: "";
  display: block;
  height: 200px;
  margin: 2.75em 20px 40px 20px;
  background-image: url("km.png");
  background-size: contain;
  background-position: center center;
  background-repeat: no-repeat;
}
```

```{r  child="../00_supp/general_rmd.Rmd"}
```


```{r, eval=params$publish, echo=FALSE, warning=FALSE, message=FALSE, results='hide'}
file_name = stringr::str_replace(knitr::current_input(),"Rmd$","html")
if(file.exists(paste0("../docs/",file_name))){
  file.copy(file_name, "../docs", overwrite  = TRUE)
} else{
      file.copy(file_name, "../docs")
  }
```

::: {.watermark}
*DRAFT*
:::

<!-- ===================== START FROM HERE ========================== -->

# Ã nghÄ©a toÃ¡n há»c cá»§a cÃ¡c hÃ m sá»‘ Ä‘Æ°á»£c sá»­ dá»¥ng trong phÃ¢n tÃ­ch sá»‘ng sÃ³t

Gá»i $T$ lÃ  má»™t biáº¿n ngáº«u nhiÃªn khÃ´ng Ã¢m Ä‘áº¡i diá»‡n cho khoáº£ng thá»i gian tÃ­nh tá»›i khi bá»‡nh nhÃ¢n tá»­ vong. CÃ³ ba phÆ°Æ¡ng phÃ¡p Ä‘á»ƒ xÃ¡c Ä‘á»‹nh phÃ¢n bá»‘ xÃ¡c suáº¥t cá»§a $T$, Ä‘Ã³ lÃ  thÃ´ng qua _hÃ m tá»“n táº¡i, hÃ m máº­t Ä‘á»™ xÃ¡c suáº¥t_ vÃ  _hÃ m nguy cÆ¡_. 

`r colorize("*HÃ m tá»“n táº¡i*", "tomato")` Ä‘Æ°á»£c Ä‘á»‹nh nghÄ©a dÆ°á»›i phÃ¢n bá»‘ rá»i ráº¡c vÃ  liÃªn tá»¥c bá»Ÿi xÃ¡c suáº¥t cá»§a $T$ lá»›n hÆ¡n giÃ¡ trá»‹ $t$ trong táº­p xÃ¡c Ä‘á»‹nh cá»§a T
$$
H(t) = \P(T>t), \quad 0<t< \infty
$$
dá»… dÃ ng nháº­n tháº¥y $H(t)$ cÃ³ má»‘i quan há»‡ vá»›i hÃ m phÃ¢n bá»‘ tÃ­ch lÅ©y $F(t) = \P(T \le t)$, ta cÃ³ $H(t) = 1 - F(t)$. VÃ¬ tháº¿ $H(t)$ lÃ  má»™t hÃ m khÃ´ng tÄƒng, cÃ³ giá»›i háº¡n pháº£i cá»§a $t$ vá»›i $F(0) = 1$ vÃ  $\lim_{t\to \infty}F(t)=0$.

## Biáº¿n thá»i gian liÃªn tá»¥c

HÃ m máº­t Ä‘á»™ xÃ¡c suáº¥t (PDF) cá»§a $T$ lÃ  
$$
f(t) = -\frac{dF(t)}{dt}
$$
vá»›i TXÄ cá»§a T lÃ  $[0,\infty)$. Ä‘á»ƒ dá»… dÃ ng, ta hÃ£y nhá»› ráº±ng hÃ m $f(t)$ chÃ­nh lÃ  máº­t Ä‘á»™ cá»§a xÃ¡c suáº¥t giá»¯a $t$ vÃ  $t+h$ vá»›i $h \to 0$. Ta cÃ³ thá»ƒ kÃ½ hiá»‡u nhÆ° sau 
$$
f(t)h \approx \P(t \le T < t+h) = S(t) - S(t+h) 
$$
vá»›i $f(t) \ge 0$, $\int_0^{\infty}f(t)dt = 1$, vÃ  
$$
S(t) = \int_t^{\infty}f(s)ds.
$$

`r colorize("*HÃ m nguy cÆ¡*","tomato")` Ä‘Æ°á»£c Ä‘á»‹nh nghÄ©a nhÆ° sau 
$$
\lambda(t) = \lim_{h\to 0^+}\frac{\P(t \le T <t+h|T\ge t)}{h},
(\#eq:eq1)
$$
gá»i lÃ  tá»‘c Ä‘á»™ tá»©c thá»i táº¡i thá»i Ä‘iá»ƒm mÃ  sá»± kiá»‡n xáº£y ra (bá»‡nh nhÃ¢n tá»­ vong), cho ráº±ng bá»‡nh nhÃ¢n Ä‘Ã³ Ä‘Ã£ sá»‘ng tá»›i thá»i gian $t$. HÃ m nguy cÆ¡ cÃ³ má»‘i quan há»‡ vá»›i hÃ m máº­t Ä‘á»™ vÃ  hÃ m sá»‘ng sÃ³t. Tá»« `r lb(eq1)` ta cÃ³ 
$$
\lambda(t) = -\frac{f(t)}{S(t)} = -\frac{d\ln S(t)}{dt}.
$$

Äáº¡o hÃ m hai váº¿ ta cÃ³ 
$$
S(t) = \exp\bigg[-\int_0^t\lambda(s)ds\bigg] = \exp[-\Lambda(t)],
(\#eq:eq2)
$$
vá»›i $\Lambda(t)$ gá»i lÃ  `r colorize("_hÃ m nguy cÆ¡ tÃ­ch lÅ©y_","tomato")`. Náº¿u ta láº¥y Ä‘áº¡o hÃ m hai váº¿ cá»§a `r lb(eq2)` ta Ä‘Æ°á»£c
$$
f(t) = \lambda(t)\exp[-\Lambda(t)].
(\#eq:eq3)
$$

NgoÃ i ra cÃ³ má»™t Ä‘áº¡i lÆ°á»£ng cÅ©ng Ä‘Æ°á»£c sá»­ dá»¥ng nhiá»u trong phÃ¢n tÃ­ch lÃ  `r colorize("_expected residual life_","tomato")` táº¡i thá»i Ä‘iá»ƒm $t$,
$$
r(t) = \E(T-t|T \ge t),
$$
Ä‘áº¡i lÆ°á»£ng nÃ y giáº£i thÃ­ch thá»i gian ká»³ vá»ng cÃ²n láº¡i cá»§a bá»‡nh nhÃ¢n biáº¿t ráº±ng bá»‡nh nhÃ¢n váº«n chÆ°a tá»­ vá»ng táº¡i thá»i Ä‘iá»ƒm $t$. Ta cÃ³ thá»ƒ biáº¿n Ä‘á»•i sau
$$
r(t) = \frac{\int_t^{\infty}(s-t)f(s)ds}{S(t)},
$$
cÃ´ng thá»©c trÃªn cÃ³ thá»ƒ chá»©ng minh thÃ nh 
$$
r(t) = \frac{\int_t^{\infty}S(s)ds}{S(t)},
(\#eq:eq4)
$$
dÆ°á»›i Ä‘iá»u kiá»‡n $\E(T) < \infty$, nghÄ©a lÃ  náº¿u $\E(T) < \infty \Rightarrow \lim_{t \to \infty}tF(t) =0$. 

::::{.blackbox .mathematics}
::: {.center}
Ta xÃ©t $\int_t^{\infty}(s-t)f(s)ds$ tÆ°Æ¡ng Ä‘Æ°Æ¡ng vá»›i 
$$
\begin{aligned}
&= -(s-t)S(s)\bigg|_t^{\infty} + \int_t^{\infty} S(s)ds \\
&= -\lim_{s \to \infty}sS(s) +   \int_t^{\infty} S(s)ds,
\end{aligned}
$$
nhÆ° váº­y náº¿u $\lim_{s \to \infty} sS(s) = 0$ thÃ¬ ta Ä‘Æ°á»£c káº¿t quáº£ `r lb(eq4)`. Pháº§n cÃ²n láº¡i ta cáº§n xem xÃ©t lÃ  vÃ¬ sao $\E(T) < \infty \Rightarrow \lim_{t \to \infty} tS(t) = 0$.

Ta xÃ©t $\int_{t}^{\infty}sS(s)ds$ tÆ°Æ¡ng Ä‘Æ°Æ¡ng vá»›i
$$
\int_0^{\infty}(u+t)f(u+t)d(u+t) = \E(u+t) = \E(u) +t,
$$
vá»›i $u = s-t$. NhÆ° váº­y náº¿u $\E(U) < \infty$ thÃ¬ $\int_{t}^{\infty}sS(s)ds < \infty$, ta tháº¥y ráº±ng tÃ­ch phÃ¢n nÃ y chá»‰ xÃ¡c Ä‘á»‹nh khi $\lim_{s \to \infty} sS(s) < \infty$. Giá»›i háº¡n nÃ y lÃ  dáº¡ng $\infty.0$, nhÆ° váº­y nÃ³ sáº½ báº±ng 0 náº¿u tá»‘c Ä‘á»™ cá»§a $S(s)$ nhanh hÆ¡n tá»‘c Ä‘á»™ cá»§a $s$ khi $s \to \infty$. Ta cÃ³ thá»ƒ viáº¿t giáº£i thÃ­ch nÃ y dÆ°á»›i cÃ´ng thá»©c toÃ¡n há»c lÃ  $S(s) = o(1/s)$.
:::
::::

Náº¿u $t = 0$ ta cÃ³ 
$$
\E(T) = r(0) = \int_0^{\infty}F(s)ds.
(\#eq:eq5)
$$
Tá»« `r lb(eq4)` ta cÃ³ 
$$
\frac{1}{r(t)} = -\frac{d}{dt}\ln\int_t^{\infty}S(s)ds,
$$
láº¥y tÃ­ch phÃ¢n hai váº¿ cáº­n tá»« $0 \rightarrow t$, ta Ä‘Æ°á»£c
$$
\int_0^t\frac{ds}{r(s)} = -\ln\int_t^{\infty}S(s)ds+\ln r(0),
$$
cuá»‘i cÃ¹ng thu Ä‘Æ°á»£c 
$$
S(t) = \frac{r(0)}{r(t)}\exp\bigg[-\int^t_0\frac{du}{r(u)}\bigg]
$$
chÃ­nh lÃ  hÃ m sá»‘ sá»‘ng sÃ³t.

## Biáº¿n thá»i gian rá»i ráº¡c

Náº¿u $T$ lÃ  cá»™t thá»i gian rá»i ráº¡c táº¡i cÃ¡c giÃ¡ trá»‹ $\{a_i\}_{i=1,2,\dots}$ vÃ  ta cÃ³ hÃ m khá»‘i xÃ¡c suáº¥t (probability mass function-PMF) lÃ  
$$
f(a_i)=\P(T=a_i), \quad i = 1,2,\dots
$$
`r colorize("hÃ m sá»‘ng sÃ³t", "tomato")` lÃ 
$$
S(t) = \sum_{j:a_j>t}f(x_j).
$$
HÃ m nguy cÆ¡ lÃ  
$$
\lambda_i = \P(T=a_i|T \ge a_i) = \frac{f(a_i)}{S(a^-_i)}, \quad i = 1,2,\dots
$$
vá»›i $S(a^-) = \lim_{t\to a^-}S(t)$, tÆ°Æ¡ng á»©ng vá»›i `r lb(eq2)` vÃ  `r lb(eq3)` ta cÃ³ 
$$
S(t) = \prod_{j:a_j \le t}(1-\lambda_j),
(\#eq:eq6)
$$
vÃ  
$$
f(a_i) = \lambda_i\prod_{j=1}^{i-1}(1-\lambda_j).
(\#eq:eq7)
$$
Ta cÃ³ thá»ƒ giáº£i thÃ­ch hai phÆ°Æ¡ng trÃ¬nh trÃªn nhÆ° sau: Ä‘á»‘i vá»›i `r lb(eq6)`, ta tháº¥y ráº±ng $S(t)$ chÃ­nh lÃ  xÃ¡c suáº¥t mÃ  bá»‡nh nhÃ¢n tá»­ vong sau má»‘c thá»i gian $t$, nghÄ©a lÃ  $\P(T>t)$. Giáº£ sá»­ $t = a_t$, ta cÃ³ 
$$
\P(T>a_t) = \P(T>a_t|T>a_{t-1})\P(T>a_{t-1})
$$
ta láº¡i cÃ³ $\P(T>a_{t-1}) = \P(T > a_{t-1}|T>a_{t-2})$, nhÆ° váº­y 
$$
\P(T>a_t) = \P(T>a_t|T>a_{t-1})\P(T > a_{t-1}|T>a_{t-2})
$$
biáº¿n Ä‘á»•i theo cÃ¡ch nÃ y ta sáº½ cÃ³ 
$$
\P(T>a_t) = \P(T>a_t|T>a_{t-1})\P(T > a_{t-1}|T>a_{t-2})\dots\P(T>a_1|T>a_0)\P(T>a_0)
$$
ta biáº¿t ráº±ng $\P(T>a_0) = \P(T>0) = 1$, nÃªn 
$$
\P(T>a_t) = \prod^t_{i=1}\P(T>a_i|T>a_{i-1}).
$$
MÃ  ta cÃ³ $1-\lambda_i = \P(T>a_i|T > a_{i-1})$, nÃªn ta suy ra `r lb(eq6)`. Báº±ng cÃ¡ch suy luáº­n tÆ°Æ¡ng tá»± ta cÅ©ng cÃ³ thá»ƒ suy ra `r lb(eq7)`. 

Äá»‘i vá»›i cáº£ hai biáº¿n liÃªn tá»¥c hay rá»i ráº¡c ta Ä‘á»u cÃ³ thá»ƒ suy luáº­n nhÆ° sau: gá»i 
$$
d\Lambda(t) = \lambda(t)dt = \Lambda(t+dt^-)- \Lambda(t^-) = \P(t \le T < t+dt|T \ge t),
$$
ta cÃ³ 
$$
S(t) = \lim_{r \to \infty}\prod_{k=1}^r[1 - d\Lambda(u_k)] = \lim_{r \to \infty}\prod_{k=1}^r\big\{1 - [\Lambda(u_k) -\Lambda(u_{k-1})]\big\},
$$
trong Ä‘Ã³ $0 = u_0<u_1<\dots<u_r=t$. NhÆ° váº­y khi $r \to \infty$ thÃ¬ $(u_i-u_{i-1}) \to 0$. Äá»‘i vá»›i trÆ°á»ng há»£p biáº¿n thá»i gian liÃªn tá»¥c ta cÃ³ thá»ƒ chá»©ng minh ráº±ng 
$$
S(t) = \lim_{r \to \infty}\prod^r_{k =0}[1-d\Lambda(u_{k})] = \exp\bigg[-\int_0^t\lambda(u)du\bigg].
$$

::::{.blackbox .mathematics}
:::{.center}
Láº¥y logarit tá»± nhiÃªn cá»§a 2 váº¿ ta cÃ³ 
$$
\lim_{r \to \infty}\sum_{k=0}^r\ln[1-d\Lambda(u_k)] = -\int_0^t\lambda(u)du
$$
ta cÃ³ $\lim_{x\to 0}\ln(1-x) = -x$, nghÄ©a lÃ  $\ln(1-x\Delta x) = -x\Delta x + o(\Delta x)$. TÆ°Æ¡ng tá»± ta cÃ³ $\ln[1-\lambda(u)\Delta u] = \lambda(u)\Delta u + o(\Delta u)$, náº¿u láº¥y tá»•ng ta sáº½ cÃ³ 
$$
\sum_{k=0}^{\infty}\ln[1-\lambda(u_k)\Delta u_k] = -\sum_{k=0}^{\infty}\lambda(u_k)\Delta u_k + o(\Delta u_k),
$$
chÃ­nh lÃ  xáº¥p xá»‰ cá»§a tÃ­ch phÃ¢n Riemann $\int_0^t \lambda(u)du$. 
:::
::::

Äá»‘i vá»›i biáº¿n thá»i gian rá»i ráº¡c thÃ¬ 
$$
\begin{aligned}
d\Lambda(t) &= \P(t \le T < t+dt|T \ge t) \\
&= \P(t \le T \le t|T \ge t) \\
&= \P(T = t|T \ge t) \\
&= \lambda,
\end{aligned}
$$
vÃ¬ tháº¿ ta suy ra `r lb(eq6)`.
 
# Æ¯á»›c lÆ°á»£ng hÃ m sá»‘ng sÃ³t
 
## Æ¯á»›c lÆ°á»£ng Kaplan-Meier

Ta cÃ³ `r colorize("_hÃ m phÃ¢n bá»‘ cá»±c_","tomato")` (empirical distribution function- EDF) cÃ³ dáº¡ng  
$$
F_n(x) = \frac{\text{Sá»‘ bá»‡nh nhÃ¢n cÃ³ giÃ¡ trá»‹}\le x}{n},
$$
chÃ­nh lÃ  Æ°á»›c lÆ°á»£ng cá»§a CDF $\P(X \le x)$. 

Trong phÃ¢n tÃ­ch sá»‘ng sÃ³t, ráº¥t thÆ°á»ng xuyÃªn hÃ m EDF Ä‘Æ°á»£c sá»­ dá»¥ng Ä‘á»ƒ thá»ƒ hiá»‡n thá»i gian sá»‘ng sÃ³t cá»§a cÃ¡c bá»‡nh nhÃ¢n. Trong trÆ°á»ng há»£p khÃ´ng cÃ³ censor xáº£y ra thÃ¬ hÃ m tá»“n táº¡i sáº½ Ä‘Æ°á»£c biá»ƒu diá»…n thÃ´ng qua CDF, nghÄ©a lÃ  $S(t) = 1 - F(t)$, vÃ  lÃ  má»™t hÃ m báº­c thang giáº£m dáº§n, vá»›i má»—i báº­c giáº£m 1 Ä‘Æ¡n vá»‹. Tuy nhiÃªn trong thá»±c tháº¿ censor gáº§n nhÆ° tá»“n táº¡i trong táº¥t cáº£ cÃ¡c dá»¯ liá»‡u sá»‘ng sÃ³t vÃ¬ tháº¿ ta cáº§n má»™t phÆ°Æ¡ng phÃ¡p Ä‘á»ƒ Æ°á»›c lÆ°á»£ng CDF. 

Äá»ƒ dá»… hÃ¬nh dung ta hÃ£y xem xÃ©t cÃ¡c khoáº£ng thá»i gian $[t_j,t_{j+1})$ vá»›i $j = 0,\dots,k$, cÃ³ táº¥t cáº£ $d_j$ bá»‡nh nhÃ¢n tá»­ vong vÃ  $m_j$ bá»‡nh nhÃ¢n lÃ  censor táº¡i cÃ¡c má»‘c thá»i gian $t_{j1}, t_{j2},\dots,t_{jm_j}$. Ta cÅ©ng láº¥y $n_j = (d_j+m_j)+\dots+(d_k+m_k)$ chÃ­nh lÃ  tá»•ng sá»‘ bá»‡nh nhÃ¢n cÃ³ nguy cÆ¡ ngay trÆ°á»›c má»‘c thá»i gian $t_{j+1}$. XÃ¡c suáº¥t tá»­ vong táº¡i thá»i Ä‘iá»ƒm $t_j$ sáº½ lÃ  
$$
\P(T=t_j) = S(t_j^-)-S(t_j).
$$

Ta cÅ©ng giáº£ sá»­ ráº±ng thá»i gian censor táº¡i $t_{jl}$ lÃ  
$$
\P(T>t_{jl}) = S(t_{jl}).
$$
NhÆ° váº­y, má»—i má»‘c thá»i gian censor $t_{jl}$ chá»‰ cung cáº¥p thÃ´ng tin ráº±ng má»™t bá»‡nh nhÃ¢n nÃ o Ä‘Ã³ váº«n chÆ°a tá»­ vong tá»›i thá»i Ä‘iá»ƒm $t_{jl}$. NhÆ° váº­y giáº£ thuyáº¿t Ä‘á»™c láº­p cá»§a censoring lÃ  há»£p lÃ½. Ta cÃ³ thá»ƒ suy ra hÃ m likelihood lÃ 
$$
L = \prod_{j=1}^k\bigg\{\Big[S(t_j^-)-S(t_j)\Big]^{d_j}\prod_{l=1}^{m_j}S(t_{jl})\bigg\},
$$
Ä‘Ã¢y chÃ­nh lÃ  má»™t hÃ m sá»‘ cá»§a EDF vÃ  Ä‘áº¡t cá»±c Ä‘áº¡i khi $\hat{S} = \arg\max L$.

á» Ä‘Ã¢y ta tháº¥y ráº±ng $\hat{S}(t)$ lÃ  má»™t hÃ m sá»‘ khÃ´ng liÃªn tá»¥c táº¡i cÃ¡c má»‘c thá»i gian tá»­ vong mÃ  ta quan sÃ¡t Ä‘Æ°á»£c. HÆ¡n ná»¯a $t_{jl} > t_j$, nÃªn $S(t_{jl})$ Ä‘áº¡t cá»±c Ä‘áº¡i táº¡i $S(j)$. VÃ¬ tháº¿ $\hat{S}_{MLE}(t)$ Ä‘Æ°á»£c xÃ¡c Ä‘á»‹nh thÃ´ng qua  cÃ¡c $\{\hat{\lambda}_i\}_{i=1,\dots,k}$ táº¡i $\{t_i\}_{i=1,\dots,k}$. Dá»±a vÃ o káº¿t quáº£ tá»« pháº§n trÆ°á»›c ta cÃ³ 
$$
\hat{S}(t_j) = \prod_{l=1}^j(1-\hat{\lambda}_l)
(\#eq:eq10)
$$
vÃ 
$$
\hat{S}(t_j^-) = \prod_{l=1}^{j-1}(1-\hat{\lambda}_l),
(\#eq:eq11)
$$
nhÆ° váº­y cÃ¡c $\hat{\lambda}_l$ Ä‘Æ°á»£c chá»n Ä‘á»ƒ hÃ m sá»‘ sau Ä‘áº¡t cá»±c Ä‘áº¡i
$$
\prod_{j=1}^k\bigg[\lambda_j^{d_j}\prod_{l=1}^{j-1}(1-\lambda_l)^{d_j}\prod_{l=1}^j(1-\lambda_l)^{m_j} \bigg]
$$
ta cÃ³ thá»ƒ rÃºt gá»n cÃ´ng thá»©c trÃªn nhÆ° sau 
$$
\prod_{j=1}^k\bigg[\frac{\lambda_j^{d_j}}{(1-\lambda_j)^{d_j}}\prod_{l=1}^j(1-\lambda_l)^{d_j+m_j} \bigg].
$$

Ta xÃ©t $\prod_{j=1}^k\prod_{l=1}^j(1-\lambda_l)^{d_j+m_j}$, pháº§n nÃ y cÃ³ thá»ƒ chá»‰ ra ráº±ng tÆ°Æ¡ng Ä‘Æ°Æ¡ng vá»›i $\prod_{j=1}^k(1-\lambda_j)^{n_j}$. NhÆ° váº­y phÆ°Æ¡ng trÃ¬nh trÃªn sáº½ tÆ°Æ¡ng Ä‘Æ°Æ¡ng vá»›i 
$$
\prod_{j=1}^k\bigg[\frac{\lambda_j}{(1-\lambda_j)}\bigg]^{d_j}(1-\lambda_j)^{n_j}
(\#eq:eq12)
$$

::::{.blackbox .mathematics}
:::{.center}
Ta khai triá»ƒn $\prod_{j=1}^k\prod_{l=1}^j(1-\lambda_l)^{d_j+m_j}$ vá»›i $k=4$, Ä‘á»ƒ Ä‘Æ¡n giáº£n táº¡m kÃ½ hiá»‡u $(1-\lambda_l) = p_l$, ta sáº½ Ä‘Æ°á»£c 

$$
\begin{aligned}
&j =1: \quad p_1^{d_1+m_1} \\
&j =2: \quad (p_1p_2)^{d_2+m_2} \\
&j=3: \quad (p_1p_2p_3)^{d_3+m_3} \\
&j=4: \quad (p_1p_2p_3p_4)^{d_4+m_4}
\end{aligned}
$$
ta cÃ³ thá»ƒ viáº¿t láº¡i nhÆ° sau 
$$
\begin{aligned}
&p_1^{d_1+m_1+d_2+m_2+d_3+m_3+d_4+m_4} &&= p_1^{n_1} \\
&p_2^{d_2+m_2+d_3+m_3+d_4+m_4} &&=  p_2^{n_2} \\
&p_3^{d_3+m_3+d_4+m_4} &&= p_3^{n_3} \\
&p_4^{d_4+m_4} &&= p_4^{n_4}
\end{aligned}
$$
suy ra 
$$
\prod_{j=1}^4\prod_{l=1}^j(p_l)^{d_j+m_j} =\prod_{j=1}^4p_j^{n_j}
$$
nhÆ° váº­y , thay $p_j = 1-\lambda_j$ vÃ  $4 \rightarrow k$, ta cÃ³ thá»ƒ tháº¥y ráº±ng $\prod_{j=1}^k\prod_{l=1}^j(1-\lambda_l)^{d_j+m_j}$ cÃ³ thá»ƒ viáº¿t thÃ nh $\prod_{j=1}^k(1-\lambda_j)^{n_j}$
:::
::::

Dá»… dÃ ng nháº­n tháº¥y `r lb(eq12)` chÃ­nh lÃ  hÃ m likelihood cá»§a phÃ¢n bá»‘ binomial. vÃ  ta cÃ³ thá»ƒ dá»… dÃ ng xÃ¡c Ä‘á»‹nh ráº±ng 
$$
\hat{\lambda}_{j_{MLE}} = \frac{d_j}{n_j}, \quad j = 1,\dots,k
$$
nhÆ° váº­y ta dá»… dÃ ng tÃ¬m Ä‘Æ°á»£c Æ°á»›c lÆ°á»£ng Kaplan-Meier cá»§a hÃ m sá»‘ng sÃ³t lÃ  
$$
\hat{S}(t) = \prod_{j:t_j\le t}\frac{n_j-d_j}{n_j}
(\#eq:eq13)
$$

NhÆ° váº­y dá»±a vÃ o cÃ´ng thá»©c trÃªn ta cÃ³ thá»ƒ tÃ­nh ra vÃ  váº½ Ä‘á»“ thá»‹ Kaplan-Meier. LÆ°u Ã½ lÃ  cÃ¡i má»‘c thá»i gian xem xÃ©t chÃ­nh lÃ  cÃ¡c má»‘c thá»i gian bá»‡nh nhÃ¢n tá»­ vong, cÃ¡c má»‘c thá»i gian censor sáº½ khÃ´ng Ä‘Æ°á»£c xem xÃ©t. Sau khi tÃ­nh ra Ä‘Æ°á»£c Æ°á»›c lÆ°á»£ng cá»§a hÃ m sá»‘ng sÃ³t táº¡i cÃ¡c má»‘c thá»i gian tá»­ vong vÃ  váº½ biá»ƒu Ä‘á»“ KM, ta Ä‘Ã£ hoÃ n thÃ nh pháº§n thá»‘ng kÃª mÃ´ táº£. Äá»ƒ tiáº¿n Ä‘áº¿n phÃ¢n thá»‘ng kÃª suy luáº­n ta cáº§n hiá»ƒu vá» phÃ¢n bá»‘ cá»§a cÃ¡c Æ°á»›c lÆ°á»£ng dÆ°á»›i cÃ¡i nhÃ¬n tiá»‡m cáº­n hay máº«u lá»›n (asymptotic hay large-sample). 

Ta cÃ³ 
$$
\ln\hat{S}(t) = \sum_{j:t_j \le t} \ln(1-\hat{\lambda}_j),
$$
Ta sá»­ dá»¥ng phÆ°Æ¡ng phÃ¡p Delta Ä‘á»ƒ tÃ¬m phÆ°Æ¡ng sai cá»§a $\ln\hat{S}(t)$, ta cÃ³ 
$$
\hat{\V}[\ln\hat{S}(t)] = \sum_{j:t_j \le t}(1-\hat{\lambda}_j)^{-2}\hat{\V}(1-\hat{\lambda}_j) =  \sum_{j:t_j \le t}\frac{d_j}{n_j(n_j-d_j)}. 
$$

Tá»« Ä‘Ã³ ta cÃ³ thá»ƒ tÃ­nh Ä‘Æ°á»£c phÆ°Æ¡ng sai cá»§a $\hat{S}(t)$ lÃ  
$$
\hat{\V}[\hat{S}(t)] = \hat{S}^2(t)\sum_{j:t_j \le t}\frac{d_j}{n_j(n_j-d_j)}.
(\#eq:eq14)
$$

::::{.blackbox .mathematics}
:::{.center}
Äáº§u tiÃªn ta tháº¥y ráº±ng $\lambda$ Ä‘Ã³ng vai trÃ² nhÆ° má»™t tham sá»‘ xÃ¡c suáº¥t trong phÃ¢n bá»‘ binomial, nghÄ©a lÃ  $d \sim \mathcal{Bin}(n,\lambda)$. Ta sáº½ cÃ³ $\hat{\lambda}_{MLE} = d/n$, nhÆ° váº­y 
$$
\V[1-\hat{\lambda}_{MLE}] = \frac{n\lambda(1-\lambda)}{n^2} = \frac{\lambda(1-\lambda)}{n}
$$
tháº¿ $\lambda = \hat{\lambda}_{MLE}$ ta Ä‘Æ°á»£c
$$
\V[1-\hat{\lambda}_{MLE}] = \frac{d(n-d)}{n^3}
$$

Tiáº¿p theo ta Ã¡p dá»¥ng phÆ°Æ¡ng phÃ¡p Delta Ä‘á»ƒ tÃ¬m phÆ°Æ¡ng sai cá»§a má»™t hÃ m sá»‘ $h(1-\lambda)$. PhÆ°Æ¡ng phÃ¡p nÃ y chÃ­nh lÃ  khai triá»ƒn má»™t hÃ m sá»‘ báº±ng phÆ°Æ¡ng phÃ¡p Taylor táº¡o thÃ nh má»™t phÆ°Æ¡ng trÃ¬nh tuyáº¿n tÃ­nh Ä‘á»ƒ tÃ­nh xáº¥p xá»‰,  rá»“i láº¥y phÆ°Æ¡ng sai cá»§a hai há»‡ thá»©c Ä‘áº§u tiÃªn. NghÄ©a lÃ  ta sáº½ cÃ³ káº¿t quáº£ tá»•ng quÃ¡t sau
$$
\V[g(X)] \approx \bigg\{\frac{dg(X)}{dX}\bigg\}^2\V(X).
$$

ta cáº§n tÃ­nh $\V\big[\ln(1-\hat{\lambda}_{MLE})\big]$, Ã¡p dá»¥ng cÃ´ng thá»©c trÃªn ta cÃ³ 
$$
\begin{aligned}
\V\big[\ln(1-\hat{\lambda}_{MLE})\big] &= (1-\hat{\lambda})^{-2}{\V}(1-\hat{\lambda}) \\
&= \frac{n^2}{(n-d)^2}\frac{d(n-d)}{n^3} \\
&= \frac{d}{n(n-d)}.
\end{aligned}
$$
Káº¿t quáº£ trÃªn giá»‘ng vá»›i káº¿t quáº£ trong `r lb(eq14)`.

Tiáº¿p theo, gá»i $X = \ln[\hat{S}(t)]$, ta tiáº¿p tá»¥c Ã¡p dá»¥ng phÆ°Æ¡ng phÃ¡p Delta Ä‘á»ƒ tÃ­nh $\V(e^X)$, ta cÃ³
$$
\begin{aligned}
\V(e^X) &=  (e^X)^2\V(X)\\
&=\V[\hat{S}(t)] \\
&=  \hat{S}^2(t)\V\big\{\ln[\hat{S}(t)]\big\}\\
&= \hat{S}^2(t)\sum_{j:t_j \le t}\frac{d_j}{n_j(n_j-d_j)},
\end{aligned}
$$
chÃ­nh lÃ  `r lb(eq14)`
:::
::::

Tá»« Ä‘Ã¢y ta cÃ³ thá»ƒ xÃ¢y dá»±ng cÃ¡c _khoáº£ng tin cáº­y (confidence interval-CI)_ cá»§a tá»«ng má»‘c thá»i gian tá»­ vong. Ta sáº½ cÃ³ khoáº£ng tin cáº­y 95% cá»§a $S(t)$ chÃ­nh lÃ  $\hat{S}(t) \pm \Phi(0.975)\hat{V}[\hat{S}(t)]^{1/2}$. Nhá»› ráº±ng táº­p giÃ¡ trá»‹ cá»§a $S(t)$ chÃ­nh lÃ  $[0,1]$, nÃªu náº¿u giÃ¡ trá»‹ cá»§a khoáº£ng tin cáº­y náº±m ngoÃ i táº­p giÃ¡ trá»‹ nÃ y thÃ¬ ta cáº§n chá»n giÃ¡ trá»‹ 0 hoáº·c 1 thay tháº¿. NgoÃ i ra má»™t phÆ°Æ¡ng phÃ¡p nháº±m trÃ¡nh tÃ¬nh tráº¡ng nÃ y xáº£y ra chÃ­nh lÃ  dÃ¹ng má»™t sá»‘ hÃ m sá»‘ one-to-one Ä‘á»ƒ biáº¿n Ä‘á»•i, tÃ¬m khoáº£ng tin cáº­y cá»§a hÃ m sá»‘ Ä‘Ã³, rá»“i láº¥y hÃ m ngÆ°á»£c láº¡i cá»§a khoáº£ng tin cáº­y nÃ y. NghÄ©a lÃ  náº¿u ta cáº§n tÃ¬m khoáº£ng tin cáº­y cá»§a $X$, ta sáº½ tÃ¬m khoáº£ng tin cáº­y cá»§a $h(X)$, sau khi ta cÃ³ khoáº£ng tin cáº­y cá»§a $h(X)$ lÃ  $a$ vÃ  $b$, ta sáº½ suy ra khoáº£ng tin cáº­y cá»§a $X$ chÃ­nh lÃ  $h^{-1}(a)$ vÃ  $h^{-1}(b)$. Hai trong sá»‘ nhá»¯ng hÃ m biáº¿n Ä‘á»•i Ä‘Æ°á»£c sá»­ dá»¥ng phá»• biáº¿n nháº¥t lÃ  hÃ m logarit tá»± nhiÃªn vÃ  hÃ m logarit tá»± nhiÃªn nhÃ¢n Ä‘Ã´i hay cÃ²n gá»i lÃ  hÃ m _log-log_. 

## VÃ­ dá»¥ vá» Æ°á»›c lÆ°á»£ng Kaplan-Meier

Ta xem xÃ©t vÃ­ dá»¥ sau

```{r, echo=F}
dt = read.table("data/Time to discontinuation of the use of an IUD.dat", header = T)
reactable::reactable(dt)
```

Ta sáº½ láº§n lÆ°á»£t tÃ­nh cÃ¡c Æ°á»›c lÆ°á»£ng vÃ  khoáº£ng tin cáº­y cá»§a hÃ m sá»‘ng sÃ³t nhÆ° sau

```{r}
time_int = which(dt$status==1)
nj = map_dbl(time_int, function(i)  nrow(dt[i:nrow(dt),]))%>% c(nrow(dt),.)
dj = rep(1, length(time_int))%>% c(0,.)
result = tibble(time_int = c(0, dt$time[time_int])%>% paste0(.,"-"), dj = dj, nj = nj)%>%
  mutate(prob = (nj-dj)/nj)%>%
  mutate(St = cumprod(prob)%>% round(digits = 4))%>%
  mutate(se = sqrt(St^2*cumsum(dj/(nj*(nj-dj)))) )%>%
  mutate(lower  = St - qnorm(0.975)*se, upper  = St + qnorm(0.975)*se )%>%
  mutate(lower = ifelse(lower <0,0,lower), upper = ifelse(upper >1,1,upper))%>%
  mutate(across(is.numeric, round,digits=3))
gt::gt(result)
```

Ta dÃ¹ng package `survival` Ä‘á»ƒ tÃ­nh 

```{r}
out = survival::survfit(Surv(time,status)~1, data = dt, conf.type = "plain")
broom::tidy(out)%>%
  relocate(conf.low, .before = "conf.high")%>%
  mutate(across(is.numeric, round,digits = 4))%>%
  filter(time %in% c(0,  10,  19,  30,  36,  59,  75,  93,  97, 107))%>%
  gt::gt()
```

NhÆ° váº­y ta thu Ä‘Æ°á»£c hai káº¿t quáº£ nhÆ° nhau. NgoÃ i ra package `survival` cÃ²n há»• trá»£ nhiá»u cÃ´ng cá»¥ dÃ nh riÃªng cho phÃ¢n tÃ­ch sá»‘ng sÃ³t. Äáº§u tiÃªn lÃ  biá»ƒu Ä‘á»“ KM

```{r}
survminer::ggsurvplot(out, risk.table = TRUE, data = dt)
```

Tiáº¿p theo lÃ  káº¿t quáº£ cá»§a trung vá»‹ 

```{r}
broom::glance(out)%>% gt::gt()
```


::::{.blackbox}
MÃ¬nh cÃ³ viáº¿t má»™t hÃ m Ä‘á»ƒ tÃ­nh toÃ¡n táº¥t cáº£ cÃ¡c giÃ¡ trá»‹ cáº§n thiáº¿t, biá»ƒu Ä‘á»“, vÃ  sáº½ tá»± Ä‘á»™ng táº¡o ra má»™t file excel vá»›i format Ä‘Ã£ Ä‘Æ°á»£c Ä‘iá»u chá»‰nh. MÃ¬nh cÅ©ng share á»Ÿ Ä‘Ã¢y 

```{r, eval=FALSE}
library(tidyverse)

func = function(data, strata = NULL, increment = 3,
                tab_number = 1,outcome = "...", grid_remove = FALSE){

 pacman::p_load(survival, tidyverse, magrittr, xlsx)
 stopifnot("time" %in% names(data) & "status" %in% names(data))
 #####
 for_unit_set = function(ddd){
  md_fit = survival::survfit(Surv(time, status) ~ 1, data = ddd)
  res1<-
   md_fit%>%
   broom::glance()%>%
   select(N = n.start, n.events = events,Mean = rmean, SD = rmean.std.error ,Median = median,
          conf.low, conf.high)%>%
   dplyr::mutate(`Mean (SE)` = paste0(round(Mean,2), " (",round(SD,2),")"))%>%
   dplyr:: mutate(`Median survival (95% CI)` = paste0(round(Median)," (", round(conf.low,2),", ",round(conf.high),")"))%>%
   dplyr::mutate(`Number of patients at risk` = round(N,2)%>% paste0(),
                 `Count(%) of patients with event` = paste0(round(n.events,2),
                                                            " (",round(n.events/N*100,2),")"))%>%
   select(`Number of patients at risk`,
          `Count(%) of patients with event`,
          `Median survival (95% CI)`,
          `Mean (SE)`

   )%>%
   pivot_longer( cols = everything(),names_to = "Statistic", values_to = "Overall" )%>%
    add_row(Statistic = "Descriptive statistics", .before = 1)

  a = summary(md_fit, times = seq(0,228,increment))

  res2 = tibble(Statistic = paste0(a$time), `Overall` = paste0(round(a$surv,2)," (",
                                                               round(a$lower,2),", ",
                                                               round(a$upper,2),")"  ))%>%
    add_row(Statistic = "Kaplan-Meier estimates", .before = 1 )
  res = bind_rows(res1,res2)
  return(res)
 }
 #######
 ######
 ######
 group = list(
  Overall = rep("overall",nrow(data))
 )

 if(!is.null(strata)){
  stopifnot(sum(strata%in% names(data)) ==length(strata))

  group2 = map(strata%>% purrr::set_names(), ~pull(data,{{.}}))
  group = append(group, group2)
 }
 group = map(group, as.character)

 d = map(group, ~{group_nest(data, cluster = .)%>%
  mutate(data = `names<-`(data, cluster))})%>%
  reduce(bind_rows)

 r = mutate(d, stats = map(data,for_unit_set))%>%
  mutate(stats = imap(stats, ~`names<-`(.x, c("statistic",.y))))

 if(!is.null(strata)){
  my_formula = map(strata%>% purrr::set_names(),~paste0("Surv(time,status)~",.))

  my_pv<-
   imap(my_formula, ~ {
    survival::survdiff(formula = as.formula(.x), data = data)%>%
     broom::glance()%>%
     select(p.value)%>%
    mutate(term = .y, .before =1)%>%
     dplyr::mutate(across(p.value,~ ifelse(.<0.001, "< 0.001", paste0(round(.,3)))))
   })
  my_pv<-
  imap(my_pv,~{
   if(nrow(.x)>1){
    mutate(.x, term = str_remove(term, .y) )
   } else .x
  })
  my_pv<-
   imap(my_pv, ~ switch((nrow(.x)>1)+1,., add_row(.x, term = .y, p.value = NA, .before = 1)))%>%
   reduce(bind_rows)%>%
   rename(statistic = term, overall = p.value)%>%
   add_row(statistic = "P.values", overall = NA, .before = 1)

  result = reduce(r$stats,inner_join, by = "statistic")%>%
   full_join(my_pv, by = c("statistic","overall"))
 }else {
  result = reduce(r$stats,inner_join, by = "statistic")
 }
 ###### plotting#########################

 group = c("1")%>% `names<-`("overall")
 group = switch((is.null(strata))+1,c(group,strata%>% purrr::set_names()),group )
 my_plot<-
 purrr::map(group, function(i){

  my_f = paste0("Surv(time,status)~",i) %>% as.formula()

   out = survival::survfit(formula=  my_f, data = data)
   out$call$formula<- my_f
   km = survminer::ggsurvplot(out, risk.table = TRUE, data = data)
   return(km)
 })
 ####################### extract sets to excel file ##########################
 result<- purrr::modify(result,~ifelse(is.na(.),"",.))
 wb = xlsx::createWorkbook(type = "xlsx") # create wookbook

 TITLE_STYLE <- xlsx::CellStyle(wb)+
   xlsx::Font(wb,  heightInPoints=16, color="blue", isBold=TRUE, underline=1) # make title style

 TABLE_COLNAMES_STYLE <- xlsx::CellStyle(wb) +  # make column style
   xlsx::Font(wb, isBold=TRUE) + xlsx::Alignment(wrapText=TRUE, horizontal="ALIGN_CENTER") +
   xlsx::Border(color="black", position=c("TOP", "BOTTOM"),pen=c("BORDER_THICK", "BORDER_THICK"))

 CELL_STYLE =  xlsx::CellStyle(wb)+ xlsx::Font(wb, isBold = TRUE)+ # cell style
   xlsx::Border(color="black", position=c("TOP"), pen=c("BORDER_THICK"))
 CELL_STYLE2 =  xlsx::CellStyle(wb)+ xlsx::Font(wb, isBold = FALSE)+ # cell style
   xlsx::Border(color="black", position=c("BOTTOM"), pen=c("BORDER_THICK"))
 #---------------------------------------------------------------------------------
 # create a sheet
 sheet = xlsx::createSheet(wb, sheetName = "Sheet 1" )
 # add title ---------
 xlsx.addTitle<-function(sheet, rowIndex, title, titleStyle){
   rows <- xlsx::createRow(sheet,rowIndex=rowIndex)
   sheetTitle <-xlsx::createCell(rows, colIndex=1)
   xlsx::setCellValue(sheetTitle[[1,1]], title)
   xlsx::setCellStyle(sheetTitle[[1,1]], titleStyle)
 }

my_title = paste0("Table ",tab_number,": Time to event analysis of ", outcome)
xlsx.addTitle(sheet, rowIndex=1, title=my_title, titleStyle = TITLE_STYLE)

 # add table --------------
 xlsx::addDataFrame(result, sheet, startRow=3, startColumn=1, colnamesStyle = TABLE_COLNAMES_STYLE)

 # Change column width
 xlsx::setColumnWidth(sheet, colIndex= 2, colWidth = 30)
 xlsx::setColumnWidth(sheet, colIndex= 3:(ncol(result)+1), colWidth = 17)

 # add cell style
 row_ind = which(result$statistic %in% c("Descriptive statistics","Kaplan-Meier estimates","P.values"))
 rows <- xlsx::getRows(sheet, rowIndex=row_ind+3 )  # get rows
 cells <- xlsx::getCells(rows, 1:ncol(result)+1)
 purrr::walk(cells,~xlsx::setCellStyle(.,CELL_STYLE))
 # for last row
 row2 = xlsx::getRows(sheet, rowIndex=nrow(result)+3 )
 cells2 <- xlsx::getCells(row2, 1:ncol(result)+1)
 purrr::walk(cells2,~xlsx::setCellStyle(.,CELL_STYLE2))

 for(i in 1:length(my_plot)){
   filename = paste0(names(my_plot)[i],".png")
   png(filename, height=900, width=1300, res=140, pointsize=2)
   print(my_plot[[i]])
   dev.off()

   xlsx::addPicture(filename, sheet, scale = 1, startRow = 3+35*(i-1),
                    startColumn = ncol(result)+4)
   res<- file.remove(filename)
 }
xlsx::saveWorkbook(wb,"Time-to-event-analysis.xlsx")
if(grid_remove){
   wb <- openxlsx::loadWorkbook(file ="Time-to-event-analysis.xlsx")
   openxlsx::showGridLines(wb,"Sheet 1", showGridLines = FALSE)
   openxlsx::saveWorkbook(wb,"Time-to-event-analysis.xlsx", overwrite = T)
}
##########################################################################
return(list("table" = result,"plot" = my_plot))
}

```

MÃ¬nh sáº½ thá»­ cháº¡y hÃ m trÃªn vá»›i dá»¯ liá»‡u `cancer` trong package `survival` nhÆ° sau 

```{r, eval=FALSE}
r = func(data = survival::cancer, increment = 40, strata = c("sex"))
```

káº¿u quáº£ thu Ä‘Æ°á»£c lÃ  file excel nhÆ° sau 

```{r, echo=FALSE}
knitr::include_graphics(rep("excel.PNG"))
```
::::

# So sÃ¡nh cÃ¡c biá»ƒu Ä‘á»“ sá»‘ng sÃ³t

Trong cÃ¡c á»©ng dá»¥ng vá» clinial trial ta thÆ°á»ng hay so sÃ¡nh hiá»‡u quáº£ cá»§a hai Ä‘áº¿n nhiá»u phÆ°Æ¡ng phÃ¡p Ä‘iá»u trá»‹ vá»›i nhau. DÆ°á»›i gÃ³c nhÃ¬n cá»§a thá»‘ng kÃª thÃ¬ Ä‘Ã¢y lÃ  bÃ i toÃ¡n so sÃ¡nh CDF cá»§a hai quáº§n thá»ƒ khÃ¡c nhau. Trong pháº§n nÃ y ta sáº½ bÃ n vá» cÃ¡c phÆ°Æ¡ng phÃ¡p kiá»ƒm Ä‘á»‹nh thÆ°á»ng Ä‘Æ°á»£c sá»­ dá»¥ng trong phÃ¢n tÃ­ch sá»‘ng sá»‘t. Ta váº«n tiáº¿p tá»¥c xem xÃ©t cÃ¡c quáº§n thá»ƒ Ä‘á»“ng nháº¥t, nghÄ©a lÃ  ta bá» qua cÃ¡c biáº¿n phÃ¢n nhÃ³m, vÃ­ dá»¥ nhÆ° tuá»•i, giá»›i tÃ­nh, cÃ¢n náº·ng... táº¥t cáº£ nhá»¯ng Ä‘áº·c tÃ­nh khÃ¡c nhau nÃ y cá»§a tá»«ng bá»‡nh nhÃ¢n Ä‘á»u khÃ´ng Ä‘Æ°á»£c xem xÃ©t. 

## So sÃ¡nh hiá»‡u quáº£ cá»§a hai phÆ°Æ¡ng phÃ¡p Ä‘iá»u trá»‹

### Kiá»ƒm Ä‘á»‹nh Wilcoxon suy rá»™ng cá»§a Gehan

Gá»i $\{x_i,\delta_{1i}\}_{i=1}^{n_1}$ lÃ  thá»i gian bá»‡nh nhÃ¢n tá»­ vong hay censor cá»§a nhÃ³m Ä‘iá»u trá»‹ I, vÃ  $\{y_i,\delta_{2i}\}_{i=1}^{n_2}$ lÃ  thá»i gian bá»‡nh nhÃ¢n tá»­ vong hay censor cá»§a nhÃ³m Ä‘iá»u trá»‹ II. Trong Ä‘Ã³ $\delta=0$ lÃ  censor vÃ  $1$ lÃ  tá»­ vong. Tiáº¿p theo ta gá»i $r_1$ lÃ  tá»•ng sá»‘ bá»‡nh nhÃ¢n tá»­ vong cá»§a nhÃ³m Ä‘iá»u trá»‹ I vÃ  $r_2$ lÃ  sá»‘ bá»‡nh nhÃ¢n tá»­ vong cá»§a nhÃ³m Ä‘iá»u trá»‹ II, tá»©c lÃ  
$$
r_g = \sum_{j=1}^{n_g}\I(\delta_{gj}=1), \quad g = 1,2.
$$
Äá»ƒ dá»… hiá»ƒu ta sáº½ láº¥y vÃ­ dá»¥ sau, ta cÃ³ group I cÃ³ cÃ¡c thá»i gian lÃ  
$$
\begin{aligned}
&x = 23, 16,18,20,24 \\
&\delta_1 = 1,0,0,0,0
\end{aligned}
$$
group II lÃ  
$$
\begin{aligned}
&x = 15,18,19,19,20 \\
&\delta_1 = 1,1,1,1,1
\end{aligned}
$$

```{r}
d1 = dplyr::tibble(time = c(23,16,18,20,24,15,18,19,19,20),
                   status = c(1,0,0,0,0,1,1,1,1,1),
                   trt = rep(c("active","control"), c(5,5))
                   )
```

__PhÆ°Æ¡ng phÃ¡p Gehan Ä‘Æ°á»£c tiáº¿n hÃ nh nhÆ° sau__

Má»‡nh Ä‘á» kiá»ƒm Ä‘á»‹nh lÃ  
$$
\begin{aligned}
&H_0: S_1 = S_2 \quad \text{(cáº£ hai phÆ°Æ¡ng phÃ¡p Ä‘iá»u trá»‹ Ä‘áº¡t hiá»‡u quáº£ nhÆ° nhau)} \\
&H_1: S_1 > S_2 \quad \text{(NhÃ³m Ä‘iá»u trá»‹ I Ä‘áº¡t hiá»‡u quáº£ tá»‘t hÆ¡n nhÃ³m Ä‘iá»u trá»‹ II)}
\end{aligned}
$$

 Äáº§u tiÃªn ta trá»™n táº¥t cáº£ cÃ¡c thá»i gian tá»­ vong vÃ  censor cá»§a 2 nhÃ³m, ta $n_1+n_2 = 5+5 = 10$ quan sÃ¡t

```{r fig1, fig.cap="Táº­p dá»¯ liá»‡u minh há»a"}
d1 %<>% dplyr::arrange(time)
draw_table(d1)
```

Vá»›i má»—i quan sÃ¡t thá»© $i$ ta sáº½ so sÃ¡nh vá»›i $n_1+n_2-1$ quan sÃ¡t cÃ²n láº¡i, gá»i giÃ¡ trá»‹ Ä‘Ã³ lÃ  $U_{ij}$, ta cÃ³
$$
U_{ij} = \cases{
+1 \quad if \quad t_i > t_j \text{ hoáº·c } t_i^+ \ge t_j \\
-1 \quad if \quad t_i < t_j \text{ hoáº·c } t_i \le t_j^+ \\
0 \quad \text{cÃ¡c trÆ°á»ng há»£p khÃ¡c}
}
$$
vÃ  
$$
U_i = \sum_{j=1}^{n_1+n_2}U_{ij}
$$
chÃ­nh lÃ  sá»‘ quan sÃ¡t nhá» hÆ¡n $t_i$ _trá»«_ sá»‘ quan sÃ¡t lá»›n hÆ¡n $t_i$. NgoÃ i ra ta giáº£ sá»­ ráº±ng censor luÃ´n xáº£y ra sau tá»­ vong, nÃªn náº¿u $t_i = 18^+$ vÃ  $t_j= 18$ thÃ¬ ta cá»™ng thÃªm $1$ vÃ o $U_i$. VÃ  statistic Gehan Ä‘Æ°á»£c Ä‘á»‹nh nghÄ©a lÃ 
$$
U = \sum_{i=1}^{n_1+n_2}U_i\I(i\text{ thuá»™c nhÃ³m I})
$$
nhÆ° váº­y cÃ³ táº¥t cáº£ 
$$
n_1 +n_2 \choose n_1
$$
cÃ¡ch Ä‘á»ƒ chá»n $n_1$ trong sá»‘ $n_1+n_2$ quan sÃ¡t, tá»©c lÃ  biáº¿n ngáº«u nhiÃªn $U$ sáº½ cÃ³ $n_1 +n_2 \choose n_1$ giÃ¡ trá»‹. VÃ¬ tháº¿ ta cÃ³ Æ°á»›c lÆ°á»£ng phÆ°Æ¡ng sai cá»§a $U$ lÃ  
$$
\hat{\V}(U) = \frac{n_1n_2}{(n_1+n_2)(n_1+n_2-1)}\sum_{i = 1}^{n_1+n_2}U^2_i
$$
DÆ°á»›i Ä‘iá»u kiá»‡n cá»§a tiá»‡m cáº­n thÃ¬ statistic $U \sim \mathcal{N}(0,\hat{\V}(U))$, nhÆ° váº­y láº¥y $Z = U/[\hat{\V}(U)]^{1/2} \sim \mathcal{N}(0,1)$. 

PhÆ°Æ¡ng phÃ¡p trÃªn cÃ³ thá»ƒ tiáº¿n hÃ nh theo 2 bÆ°á»›c 
















<!-- ====================== END ====================================== -->

<!-- # *References* {.unnumbered} -->
