---
title: "&#128205;Propensity Score I"
subtitle: "&#128205;Tá»•ng Quan vá» Propensity Score vÃ  PhÆ°Æ¡ng PhÃ¡p Weighting"
author: ğŸ‘¦ $\mathcal{An}$
date: "&#x1F4C5; _`r {
if(!file.exists('date_list.rds')){saveRDS(list(), file = 'date_list.rds')}
update=FALSE
filename=knitr::current_input(dir = FALSE)
mylist <- readRDS(file ='date_list.rds')
if(update|!(filename%in%names(mylist))){
mylist[[filename]]<- format(Sys.Date(),format = '%d-%m-%Y')
saveRDS(mylist, file = 'date_list.rds')}
readRDS(file ='date_list.rds')[[filename]]  }`_"
abstract: |
  Propensity score lÃ  phÆ°Æ¡ng phÃ¡p Ä‘Æ°á»£c sá»­ dá»¥ng nhiá»u trong cÃ¡c nghiÃªn cá»©u Ä‘Ã¡nh giÃ¡ áº£nh hÆ°á»Ÿng cá»§a sáº£n pháº§m (hay phÆ°Æ¡ng phÃ¡p Ä‘iá»u trá»‹ hoáº·c can thiá»‡p trong clinical trials). NÃ³ cho phÃ©p ta Ä‘iá»u chá»‰nh Ä‘á»™ nhiá»…u gÃ¢y ra bá»Ÿi cÃ¡c biáº¿n Ä‘iá»u kiá»‡n trÆ°á»›c can thiá»‡p khi ta Ä‘Ã¡nh giÃ¡ hiá»‡u quáº£ cá»§a cÃ¡c can thiá»‡p. Propensity score Ä‘Æ°á»£c giáº£i thÃ­ch lÃ  xÃ¡c suáº¥t mÃ  má»™t bá»‡nh nhÃ¢n Ä‘Æ°á»£c xáº¿p vÃ o nhÃ³m treatment (nhÃ³m cÃ²n láº¡i lÃ  control) dÆ°á»›i má»™t Ä‘iá»u kiá»‡n nÃ o Ä‘Ã³ (tuá»•i, giá»›i tÃ­nh, chiá»u cao,...). Nhá»¯ng Ä‘iá»u kiá»‡n nÃ y gá»i lÃ  Ä‘iá»u kiá»‡n trÆ°á»›c can thiá»‡p (pretreatments). DÆ°á»›i má»™t táº­p propensity score cho tá»«ng bá»‡nh nhÃ¢n, áº£nh hÆ°á»Ÿng cá»§a cÃ¡c can thiá»‡p lÃªn bá»‡nh nhÃ¢n sáº½ Ä‘Æ°á»£c so sÃ¡nh má»™t cÃ¡ch chÃ­nh xÃ¡c hÆ¡n. Trong pháº§n nÃ y ta sáº½ láº§n lÆ°á»£t lÃ m quen vá»›i cÃ¡c phÆ°Æ¡ng phÃ¡p tÃ¬m propensity score cho má»™t observational data. 
output: 
    bookdown::html_document2:
      fig_caption: yes
      theme: default
      highlight: tango
      toc: true
      toc_float: 
        collapsed: false
      toc_depth: 3
      code_folding: hide
      css: "../00_supp/style.css"
      number_sections: true
      includes:
        in_header: "../00_supp/header.html"
        before_body: "test.html"
        after_body: "../00_supp/mycomment.html"
fontsize: 12pt
bibliography: ["citation.bib"]
csl: "../00_supp/apa.csl"
link-citations: true
editor_options: 
  chunk_output_type: console
---


```{css, echo = F}
/*----------LOGO above TOC---------*/

#TOC::before {
  content: "";
  display: block;
  height: 200px;
  margin: 2.75em 20px 40px 20px;
  background-image: url("casual.jpg");
  background-size: contain;
  background-position: center center;
  background-repeat: no-repeat;
}
```

```{r child="../00_supp/general_rmd.Rmd"}
```

# Giá»›i thiá»‡u  

NÃ³i Ä‘áº¿n suy luáº­n nhÃ¢n quáº£, hiá»‡n táº¡i cÃ³ ba trÆ°á»ng phÃ¡i lÃ  

1. TrÆ°á»ng phÃ¡i cá»§a Rubin, sá»­ dá»¥ng lÃ½ thuyáº¿t counterfactual.
2. TrÆ°á»ng phÃ¡i Pearl, phÃ¡t triá»ƒn tá»« lÃ½ thuyáº¿t cá»§a graphical models.
3. TrÆ°á»ng phÃ¡i cá»§a Dawid, dá»±a trÃªn thuyáº¿t quyáº¿t Ä‘á»‹nh (decision theory). 

Trong ná»™i dung bÃ i nÃ y ta sáº½ tiáº¿p cáº­n váº¥n Ä‘á» theo trÆ°á»ng phÃ¡i cá»§a Rubin.

TrÆ°á»›c tiÃªn ta hÃ£y nháº¯c láº¡i cÃ¡c kÃ½ hiá»‡u sáº½ Ä‘Æ°á»£c sá»­ dá»¥ng trong bÃ i nhÆ° sau 

- potential outcomes: $Y_i(0)$ vÃ  $Y_i(1)$ chÃ­nh lÃ  káº¿t quáº£ cá»§a bá»‡nh nhÃ¢n $i$ láº§n lÆ°á»£t thuá»™c nhÃ³m control vÃ  treatment.
- observed outcomes: $Y_{i|1}$ vÃ  $Y_{i|0}$ hoáº·c $Y_i|T=1$ vÃ  $Y_i|T=0$ lÃ  káº¿t quáº£ quan sÃ¡t Ä‘Æ°á»£c cá»§a bá»‡nh nhÃ¢n $i$ thuá»™c nhÃ³m treatment HOáº¶C control. LÆ°u Ã½ vá»›i má»—i má»™t bá»‡nh nhÃ¢n ta chá»‰ cÃ³ thá»ƒ quan sÃ¡t Ä‘Æ°á»£c má»™t trong hai giÃ¡ trá»‹. 
- nhÃ³m Ä‘iá»u trá»‹: $T=0$ vÃ  $T=1$ Ä‘áº¡i diá»‡n cho hai nhÃ³m Ä‘iá»u trá»‹ control vÃ  treatment
- pre-treatments, confounders, baseline characteristics: Ä‘Æ°á»£c kÃ½ hiá»‡u $\bf{X}_i$, $\bf{X}$ Ä‘Æ°á»£c in Ä‘áº­m Ä‘áº¡i diá»‡n cho má»™t vector thay vÃ¬ má»™t scalar, vÃ¬ má»—i má»™t bá»‡nh nhÃ¢n sáº½ cÃ³ nhiá»u biáº¿n confounders nhÆ° tuá»•i, giá»›i tÃ­nh, dÃ¢n tá»™c,...

NhÆ° Ä‘Ã£ giáº£i thÃ­ch á»Ÿ pháº§n trÆ°á»›c, áº£nh hÆ°á»Ÿng cá»§a cÃ¡c can thiá»‡p thÆ°á»ng bá»‹ nhiá»…u bá»Ÿi cÃ¡c Ä‘iá»u kiá»‡n trÆ°á»›c can thiá»‡p, nhiá»…u lÃ  nguyÃªn nhÃ¢n chÃ­nh ngÄƒn cáº£n sá»± Ä‘Ã¡nh giÃ¡ vá» hiá»‡u quáº£ cá»§a can thiá»‡p Ä‘Ã³. NÃ³i cÃ¡ch khÃ¡c náº¿u ta nhÃ¬n vÃ o 2 nhÃ³m treatment vÃ  control thÃ¬ sá»± phÃ¢n bá»‘ cá»§a cÃ¡c confounders nhÆ° tuá»•i, giá»›i tÃ­nh, chiá»u cao, cÃ¢n náº·ng cá»§a cÃ¡c bá»‡nh nhÃ¢n sáº½ khÃ´ng Ä‘á»u nhau. Äiá»u nÃ y xáº£y ra á»Ÿ táº¥t cáº£ cÃ¡c nghiÃªn cá»©u sá»­ dá»¥ng observational data (khÃ¡c vá»›i randomized controlled trial), bá»Ÿi vÃ¬ Ä‘a sá»‘ ta dá»±a trÃªn cÃ¡c Ä‘iá»u kiá»‡n nhÆ° tuá»•i, giá»›i tÃ­nh, chiá»u cao... Ä‘á»ƒ xáº¿p bá»‡nh nhÃ¢n vÃ o má»™t trong hai nhÃ³m treatment hay control. Giáº£ sá»­ ta muá»‘n Ä‘Ã¡nh giÃ¡ hiá»‡u quáº£ Ä‘iá»u trá»‹ cá»§a má»™t loáº¡i thuá»‘c má»›i, ta sáº½ tiáº¿n hÃ nh thÃ­ nghiá»‡m báº±ng cÃ¡ch cho má»™t sá»‘ ngÆ°á»i sá»­ dá»¥ng loáº¡i thuá»‘c má»›i trong khi nhá»¯ng ngÆ°á»i cÃ²n láº¡i sáº½ Ä‘Æ°á»£c sá»­ dá»¥ng giáº£ dÆ°á»£c (placebo). Trong Ä‘iá»u kiá»‡n lÃ½ tÆ°á»Ÿng, khÃ´ng nhiá»…u, tá»©c lÃ  2 nhÃ³m Ä‘iá»u trá»‹ nÃ y cÃ³ cÃ¡c Ä‘iá»u kiá»‡n trÆ°á»›c khi tham gia vÃ o nghiÃªn cá»©u lÃ  tÆ°Æ¡ng tá»± nhau, ta cÃ³ thá»ƒ dá»… dÃ ng so sÃ¡nh káº¿t quáº£ cá»§a 2 nhÃ³m bá»‡nh nhÃ¢n nÃ y (xáº£y ra khi cÃ³ sá»± hiá»‡n diá»‡n cá»§a randomization). Tuy nhiÃªn, káº¿t luáº­n sáº½ bá»‹ lá»‡ch náº¿u nhÆ° hai nhÃ³m bá»‡nh nhÃ¢n nÃ y cÃ³ sá»± phÃ¢n bá»‘ cá»§a cÃ¡c confouders khÃ´ng Ä‘á»“ng Ä‘á»u. NÃ³i cÃ¡ch khÃ¡c lÃ  Ä‘iá»u kiá»‡n ban Ä‘áº§u cá»§a 2 nhÃ³m nÃ y khÃ¡c nhau. 
VÃ­ dá»¥ dá»… tháº¥y lÃ  trong sá»‘ nhá»¯ng bá»‡nh nhÃ¢n thuá»™c nhÃ³m treatment cÃ³ tá»‰ lá»‡ trÃªn 50 tuá»•i lÃ  80% trong khi nhá»¯ng ngÆ°á»i thuá»™c nhÃ³m cÃ²n láº¡i thÃ¬ cÃ³ Ä‘áº¿n 80% sá»‘ bá»‡nh nhÃ¢n dÆ°á»›i 30 tuá»•i. NhÆ° váº­y náº¿u nhÆ° káº¿t quáº£ phÃ¢n tÃ­ch cuá»‘i cÃ¹ng cho tháº¥y treatment khÃ´ng hiá»‡u quáº£ khi so sÃ¡nh vá»›i control. Váº­y ta pháº£i Ä‘áº·c cÃ¢u há»i lÃ  _"liá»‡u nhÃ³m bá»‡nh nhÃ¢n thuá»™c nhÃ³m control Ä‘áº¡t káº¿t quáº£ tá»‘t hÆ¡n bá»‡nh nhÃ¢n thuá»™c nhÃ³m treatment lÃ  do treatment khÃ´ng hiá»‡u quáº£ báº±ng control hay do kháº£ nÄƒng phá»¥c há»“i cá»§a nhá»¯ng bá»‡nh nhÃ¢n trÃªn 50 tháº¥p hÆ¡n nhá»¯ng bá»‡nh nhÃ¢n dÆ°á»›i 30 tuá»•i?"_ hoÃ n toÃ n cÃ³ kháº£ nÄƒng lÃ  treatment tháº­t sá»± hiá»‡u quáº£ nhÆ°ng vÃ¬ Ä‘á»™ tuá»•i Ä‘Ã£ áº£nh hÆ°á»Ÿng vÃ  lÃ m lá»‡ch Ä‘i káº¿t quáº£ Ä‘Ãºng. NhÆ° váº­y solution cho váº¥n Ä‘á» nÃ y lÃ  ta cáº§n pháº£i cÃ¢n báº±ng láº¡i tá»‰ lá»‡ tuá»•i cá»§a 2 nhÃ³m Ä‘iá»u trá»‹. NghÄ©a lÃ  tá»‰ lá»‡ sá»‘ tuá»•i cá»§a bá»‡nh nhÃ¢n trÃªn 50 vÃ  dÆ°á»›i 30 cá»§a 2 nhÃ³m pháº£i xáº¥p xá»‰ nhau. 

Náº¿u ta giáº£ sá»­ ráº±ng má»—i má»™t bá»‡nh nhÃ¢n Ä‘á»u cÃ³ 2 káº¿t quáº£ song song tÆ°Æ¡ng á»©ng vá»›i tá»«ng can thiá»‡p. trong Ä‘iá»u kiá»‡n nÃ y thÃ¬ cÃ¡c biáº¿n trÆ°á»›c Ä‘iá»u trá»‹ khÃ´ng áº£nh hÆ°á»Ÿng vÃ¬ cáº£ 2 nhÃ³m treatment vÃ  control Ä‘á»u cÃ³ cÃ¡c Ä‘iá»u kiá»‡n ban Ä‘áº§u nhÆ° nhau (má»—i bá»‡nh nhÃ¢n Ä‘á»u cho 2 káº¿t quáº£ tÆ°Æ¡ng á»©ng vá»›i 2 phÆ°Æ¡ng phÃ¡p Ä‘iá»u trá»‹). Tuy nhiÃªn, trong thá»±c táº¿, Ä‘iá»u nÃ y hoÃ n toÃ n khÃ´n thá»ƒ xáº£y ra bá»Ÿi vÃ¬ má»—i bá»‡nh nhÃ¢n chá»‰ Ä‘Æ°á»£c dÃ¹ng Ä‘Ãºng 1 loáº¡i thuá»‘c vÃ  cho duy nháº¥t má»™t káº¿t quáº£ tÆ°Æ¡ng á»©ng vá»›i loáº¡i thuá»‘c Ä‘Ã³. 

Ta láº¥y $Y_i(T)$ lÃ  kÃ½ hiá»‡u cá»§a káº¿t quáº£ Ä‘iá»u trá»‹ sau khi sá»­ dá»¥ng phÆ°Æ¡ng phÃ¡p Ä‘iá»u trá»‹ $T$, trong Ä‘Ã³ $T = 1$ lÃ  treatment vÃ  $T = 0$ lÃ  control. Trong thá»±c táº¿ ta chá»‰ cÃ³ thá»ƒ quan sÃ¡t Ä‘Æ°á»£c má»™t trong hai giÃ¡ trá»‹ $Y(1)$ HOáº¶C lÃ  $Y(0)$, tÃ¹y vÃ o bá»‡nh nhÃ¢n Ä‘Ã³ thuá»™c nhÃ³m nÃ o. NhÆ° váº­y, so sÃ¡nh hiá»‡u quáº£ cá»§a hai loáº¡i can thiá»‡p nÃ y sáº½ khÃ´ng thá»±c hiá»‡n Ä‘Æ°á»£c báº±ng cÃ¡c phÆ°Æ¡ng phÃ¡p thá»‘ng kÃª thÃ´ng thÆ°á»ng. 

Nháº¯c láº¡i ráº±ng Ä‘áº¡i lÆ°á»£ng Ä‘á»ƒ Ä‘Ã¡nh giÃ¡ hiá»‡u quáº£ lÃ  $\E[Y(1) - Y(0)]$, chÃ­nh lÃ  expectation (ká»³ vá»ng) cá»§a  hai potential outcomes tÆ°Æ¡ng á»©ng hai nhÃ³m Ä‘iá»u trá»‹. Náº¿u nhÆ° cÃ¡c bá»‡nh nhÃ¢n tham gia vÃ o nghiÃªn cá»©u Ä‘Æ°á»£c _**ngáº«u nhiÃªn**_ phÃ¢n vÃ o má»™t trong hai nhÃ³m Ä‘iá»u trá»‹, thÃ¬ ta cÃ³

$$
\E[Y_i(t)] = \E[Y_i|T=t],~~~~1\le i\le n.
(\#eq:1)
$$

Äá»ƒ chá»©ng minh `r lb(eq,'1')`, ta hÃ£y xem yáº¿u tá»‘ randomization Ä‘Æ°á»£c thá»±c hiá»‡n thÃ´ng qua chá»n lá»±a bá»‡nh nhÃ¢n vÃ o má»™t trong hai nhÃ³m Ä‘iá»u trá»‹ báº±ng cÃ¡ch tung má»™t Ä‘á»“ng xu. Náº¿u nhÆ° Ä‘á»“ng xu cho ra máº·t hÃ¬nh thÃ¬ bá»‡nh nhÃ¢n vÃ o nhÃ³m treatment $(T=1)$, ngÆ°á»£c láº¡i sáº½ vÃ o nhÃ³m control $(T=0)$ _(scenario 1)_. CÃ¢u há»i Ä‘áº·c ra lÃ  náº¿u ta lÃ m ngÆ°á»£c láº¡i, nghÄ©a lÃ  náº¿u Ä‘á»“ng xu máº·t hÃ¬nh ta sáº½ cho bá»‡nh nhÃ¢n vÃ o nhÃ³m control $(T=0)$ ngÆ°á»£c láº¡i lÃ  nhÃ³m treatment $(T=1)$ _(scenario 2)_, thÃ¬ káº¿t quáº£ cÃ³ thay Ä‘á»•i hay khÃ´ng?! cÃ¢u tráº£ lá»i lÃ  khÃ´ng, bá»Ÿi vÃ¬ ta luÃ´n cÃ³ 

$$
\cases{
\E[Y(1)|T=1] = \E[Y(1)|T=0] = \E[Y(1)],  \\
\E[Y(0)|T=1] = \E[Y(0)|T=0] = \E[Y(0)].}
(\#eq:eq1)
$$
cÃ³ nghÄ©a lÃ  $Y(1),Y(0)$ Ä‘á»™c láº­p vá»›i $T$, vÃ  `r lb(eq1)` Ä‘Æ°á»£c gá»i lÃ  _exchangeability_. 


:::: {.blackbox .brainstorm}
::: {.center }
`r colorize('_Ta cÃ³ thá»ƒ nghÄ© ráº±ng potential outcome Y(1) vÃ  Y(0) Ä‘Ã£ cÃ³ tá»« trÆ°á»›c khi can thiá»‡p, quÃ¡ trÃ¬nh can thiá»‡p chá»‰ Ä‘á»ƒ xÃ¡c Ä‘á»‹nh potential outcome nÃ o cá»§a má»—i bá»‡nh nhÃ¢n sáº½ trá»Ÿ thÃ nh observed outcome. VÃ¬ quÃ¡ trÃ¬nh can thiá»‡p diá»…n ra ngáº«u nhiÃªn mÃ  khÃ´ng phá»¥ thuá»™c lÃªn báº¥t ká»³ má»™t confounders hay potential outcomes nÃ o, nÃªn $T \\indep Y(0), Y(1))$_.',color = "grey")`
:::
Tuy nhiÃªn, Ä‘á»ƒ giáº£i thÃ­ch chÃ­nh xÃ¡c vá» Ã½ nghÄ©a cá»§a _randomization (quÃ¡ trÃ¬nh ngáº«u nhiÃªn)_, thÃ¬ ta sáº½ mÆ°á»£n vÃ­ dá»¥ cá»§a @ros2010 nhÆ° sau

vÃ­ dá»¥ ta cÃ³ 5 bá»‡nh nhÃ¢n, má»—i bá»‡nh nhÃ¢n  sáº½ cÃ³ 2 potential outcomes, kÃ½ hiá»‡u lÃ  $$\{Y_i(t):t=0 \lor t=1, i=1,\dots,n\},$$ tÆ°Æ¡ng á»©ng vá»›i 2 nhÃ³m treatments lÃ  active vÃ  control. NhÆ° váº­y xáº¿p _ngáº«u nhiÃªn_ bá»‡nh nhÃ¢n vÃ o 1 trong 2 nhÃ³m Ä‘iá»u trá»‹ tá»©c lÃ  $T  = \{t_i:i = 1,\dots,5\}$ sáº½ Ä‘Æ°á»£c chá»n ngáº«u nhiÃªn, má»—i láº§n chá»n vá»›i xÃ¡c suáº¥t lÃ  $\frac{1}{2^5} = 0.03125$. XÃ¡c suáº¥t Ä‘Æ°á»£c tÃ­nh báº±ng cÃ¡ch sau: cÃ³ táº¥t cáº£ $5$ $T$'s má»—i $T$ cÃ³ 2 giÃ¡ trá»‹ Ä‘á»ƒ chá»n lÃ  $0$ vÃ  $1$, nÃªn cÃ³ táº¥t cáº£ lÃ  $2^5 = 32$ cÃ¡ch. LÆ°u Ã½ khi chá»n má»™t giÃ¡ trá»‹ cho $T$ nghÄ©a lÃ  ta sáº½ chá»n ngáº«u nhiÃªn cÃ¹ng lÃºc $5$ $t$'s. VÃ­ dá»¥ ta cÃ³ thá»ƒ nÃ©m cÃ¹ng lÃºc 5 Ä‘á»“ng xu Ä‘á»ƒ tÃ¬m giÃ¡ trá»‹ $T$. NÃ³i má»™t cÃ¡ch Ä‘Æ¡n giáº£n thÃ¬ ta dÃ¹ng Ä‘á»“ng xu Ä‘á»ƒ thiáº¿t láº­p phÃ¢n bá»‘ cá»§a biáº¿n ngáº«u nhiÃªn $T$. Tháº­t ra Ä‘iá»u nÃ y chÆ°a tháº­t sá»± Ä‘Ãºng. quÃ¡ trÃ¬nh ngáº«u nhiÃªn pháº£i Ä‘Æ°á»£c xem xÃ©t tá»« khÃ­a cáº¡nh Ä‘á»™c láº­p cá»§a cÃ¡c thÃ´ng tin liÃªn quan. NghÄ©a lÃ  thÃ´ng tin $Y(T)$ hay $X$ mang láº¡i vÃ´ hiá»‡u Ä‘á»ƒ dá»± Ä‘oÃ¡n $T$, hay ngÆ°á»£c láº¡i. NghÄ©a lÃ  Ä‘á»“ng xu Ä‘Æ°á»£c sá»­ dá»¥ng khÃ´ng thá»ƒ nháº­n diá»‡n Ä‘Æ°á»£c cÃ¡c thÃ´ng tin khÃ¡c, ngay cáº£ khi cÃ¡c Ä‘áº·c tÃ­nh cá»§a tá»«ng bá»‡nh nhÃ¢n nhÆ° giá»›i tÃ­nh, tuá»•i tÃ¡c, chiá»u cao... cÃ³ thá»ƒ xÃ¡c Ä‘á»‹nh, tháº­m chÃ­ ta biáº¿t Ä‘Æ°á»£c káº¿t quáº£ cá»§a tá»«ng bá»‡nh nhÃ¢n, thÃ¬ Ä‘á»“ng xu váº«n khÃ´ng thá»ƒ sá»­ dá»¥ng nguá»“n thÃ´ng tin Ä‘Ã³, mÃ  nÃ³ chá»‰ lÃ m má»™t viá»‡c Ä‘Æ¡n giáº£n lÃ  "vÃ´ tÆ°" xáº¿p 5 bá»‡nh nhÃ¢n vÃ o má»™t trong hai nhÃ³m Ä‘iá»u trá»‹. VÃ¬ tháº¿ ta cÃ³ thá»ƒ viáº¿t lÃ  

$$
\P[T|Y(0),Y(1)] = \frac{1}{2^n}, ~~~\color{grey}{\text{(náº¿u Ä‘á»“ng xu Ä‘á»“ng cháº¥t)}} 
$$
vá»›i $n$ lÃ  sá»‘ bá»‡nh nhÃ¢n tham gia nghiÃªn cá»©u. NghÄ©a lÃ  dÆ°á»›i Ä‘iá»u kiá»‡n thÃ´ng tin Ä‘Æ°á»£c cho trÆ°á»›c, $Y(0)$ vÃ  $Y(1)$, thÃ¬ táº¥t cáº£ $2^n$ lá»±a chá»n sáº½ cÃ³ xÃ¡c suáº¥t báº±ng nhau, tá»©c lÃ  ta khÃ´ng sá»­ dá»¥ng thÃ´ng tin tá»« $\big[Y(0),Y(1)\big]$ hay $X$ Ä‘á»ƒ dá»± Ä‘oÃ¡n $T$. ChÃºng ta cÃ³ thá»ƒ viáº¿t cÃ´ng thá»©c trÃªn á»Ÿ dáº¡ng tá»•ng quÃ¡t hÆ¡n khi Ä‘á»“ng xu khÃ´ng Ä‘á»“ng cháº¥t, nghÄ©a lÃ  $p\ne 1/2$. Ta cÃ³ 

$$
\P[T|Y(0),Y(1)] = p^{n_t}(1-p)^{n_c}
(\#eq:eq1001)
$$
trong Ä‘Ã³ $n_t+n_c=n$. `r lb(eq1001)` Ä‘Æ°á»£c gá»i lÃ  _Bernoulli trials_.

NhÃ¬n vÃ o cÃ´ng thá»©c trÃªn ta tháº¥y ráº±ng xÃ¡c suáº¥t cá»§a $T$ chá»‰ phá»¥ thuá»™c vÃ o sá»‘ lÆ°á»£ng bá»‡nh nhÃ¢n trong 2 nhÃ³m Ä‘iá»u trá»‹ Ä‘Ã£ Ä‘Æ°á»£c xÃ¡c Ä‘á»‹nh trÆ°á»›c Ä‘Ã³ vÃ  hoÃ n toÃ n Ä‘á»™c láº­p vá»›i $Y(t)$ vá»›i $t \in\{0,1\}$. Ta nÃ³i ráº±ng $T \indep Y(0),Y(1)$. BÃ¢y giá» ta hÃ£y hÃ¬nh dung cÃ³ 2 bá»‡nh nhÃ¢n trong Ä‘Ã³ bá»‡nh nhÃ¢n sá»‘ 1 thuá»™c khÃ´ng gian $head~(H)$, káº¿t quáº£ Ä‘Æ°á»£c kÃ½ hiá»‡u lÃ  $Y_H$ bá»‡nh nhÃ¢n sá»‘ 2 thuá»™c khÃ´ng gian $tail~(T)$, kÃ½ hiá»‡u lÃ  $Y_T$, cáº£ hai khÃ´ng gian nÃ y Ä‘á»u lÃ  khÃ´ng gian cá»§a interventional tá»©c lÃ  khÃ´ng gian Ä‘Æ°á»£c can thiá»‡p nÃªn má»—i khÃ´ng gian chá»‰ chá»©a duy nháº¥t má»™t thuá»™c tÃ­nh $T$ hay thuá»™c tÃ­nh $H$. NhÆ° váº­y Ä‘áº·c tÃ­nh exchangeability sáº½ báº£o Ä‘áº£m ráº±ng cáº£ 2 bá»‡nh nhÃ¢n thuá»™c hai khÃ´ng gian nÃ y Ä‘á»u cÃ³ ká»³ vá»ng $\E[Y|T=t]$ nhÆ° nhau nghÄ©a lÃ  
$$
\cases{
\E[Y_H|T=1] = \E[Y_T|T=1], \\ \E[Y_H|T=0] = \E[Y_T|T=0].}
$$
Quay láº¡i vÃ­ dá»¥ vá» Ä‘á»“ng xu, ta cÃ³ thá»ƒ nÃ³i ráº±ng 

:::{.col-darkred}
> __Äáº·c tÃ­nh exchangeability Ä‘Ã£ báº£o Ä‘áº£m ráº±ng dÃ¹ Ä‘á»“ng xu tÆ°Æ¡ng á»©ng vá»›i má»™t bá»‡nh nhÃ¢n nÃ o Ä‘Ã³ lÃ  _H_ hay _T_ thÃ¬ káº¿t quáº£ ká»³ vá»ng cá»§a bá»‡n nhÃ¢n Ä‘Ã³ `r colorize('_náº¿u Ä‘Æ°á»£c Ä‘iá»u trá»‹ (náº¿u khÃ´ng Ä‘Æ°á»£c Ä‘iá»u trá»‹)_', color = 'darkred')` sáº½ khÃ´ng Ä‘á»•i, báº±ng kÃ½ hiá»‡u cá»§a xÃ¡c suáº¥t ta cÃ³ thá»ƒ trÃ¬nh bÃ y nhÆ° trong `r lb(eq1)`.__ 
:::

Äiá»u nÃ y cÅ©ng dá»… hiá»ƒu vÃ¬ náº¿u nhÆ° má»™t bá»‡nh nhÃ¢n nÃ o Ä‘Ã³ mÃ  cÃ³ biá»ƒu hiá»‡n khÃ´ng Ä‘á»“ng nháº¥t vá»›i cÃ¡c bá»‡nh nhÃ¢n khÃ¡c thÃ¬ ta cÃ³ thá»ƒ suy luáº­n ráº±ng Ä‘Ã£ cÃ³ má»™t Ä‘áº·c tÃ­nh nÃ o Ä‘Ã³ áº£nh hÆ°á»ng lÃªn káº¿t quáº£ mÃ  ta Ä‘Ã£ bá» qua. 

XÃ©t má»™t vÃ­ dá»¥ khÃ¡c nhÆ° sau, $A$ lÃ  má»™t phÆ°Æ¡ng phÃ¡p Ä‘iá»u trá»‹ cÃ³ hiá»‡u quáº£ vá»›i bá»‡nh $D$, nghÄ©a lÃ  $Y(A) =1$ vÃ  $Y(A^C) =0$ nhÆ° váº­y káº¿t quáº£ ta mong muá»‘n Ä‘Ã³ lÃ  náº¿u bá»‡nh nhÃ¢n sá»‘ 1 thuá»™c nhÃ³m Ä‘iá»u trá»‹ thÃ¬ bá»‡nh nhÃ¢n 1 sáº½ cho káº¿t quáº£ phá»¥c há»“i $Y_1(A)=1$, cÃ²n bá»‡nh nhÃ¢n sá»‘ 2 thuá»™c nhÃ³m khÃ´ng Ä‘iá»u trá»‹ sáº½ cho káº¿t quáº£ khÃ´ng phá»¥c há»“i $Y_2(A^C)=0$, ta cÃ³ 
$$
Y_1(A) - Y_2(A^C) = 1.
$$
á» trÆ°á»ng há»£p ngÆ°á»£c láº¡i, náº¿u bá»‡nh nhÃ¢n sá»‘ 1 thuá»™c nhÃ³m khÃ´ng Ä‘iá»u trá»‹ thÃ¬ káº¿t quáº£ cÅ©ng pháº£i lÃ  khÃ´ng phá»¥c há»“i, $Y_1(A^C)=0$, vÃ  bá»‡nh nhÃ¢n sá»‘ 2 láº§n nÃ y thuá»™c nhÃ³m Ä‘iá»u trá»‹ pháº£i cho káº¿t quáº£ phá»¥c há»“i, $Y_2(A)=1$, ta cÃ³ 
$$
Y_2(A) - Y_1(A^C) =1.
$$
Náº¿u ta thu Ä‘Æ°á»£c má»™t trong hai káº¿t quáº£ trÃªn thÃ¬ ta káº¿t luáº­n thuá»‘c $A$ cÃ³ hiá»‡u quáº£ vá»›i bá»‡nh $D$, giá»‘ng nhÆ° nhá»¯ng gÃ¬ ta mong Ä‘á»£i trÆ°á»›c Ä‘Ã³. NhÆ°ng náº¿u nhÆ° bá»‡nh nhÃ¢n sá»‘ 1 trong trÆ°á»ng há»£p thá»© 2 cÅ©ng cho káº¿t quáº£ phá»¥c há»“i tá»©c lÃ  $Y_1(A^C) =1$, thÃ¬ 
$$
Y_2(A) - Y_1(A^C) =0,
$$
Káº¿t quáº£ nÃ y sáº½ Ä‘Æ°a Ä‘áº¿n káº¿t luáº­n ráº±ng thuá»‘c $A$ khÃ´ng cÃ³ hiá»‡u quáº£ vá»›i bá»‡nh $D$, vÃ  káº¿t luáº­n nÃ y ngÆ°á»£c láº¡i vá»›i káº¿t quáº£ Ä‘Ãºng ban Ä‘áº§u. 
::::

NhÆ° váº­y dá»±a vÃ o `r lb(eq1)` ta cÃ³ thá»ƒ chá»©ng minh Ä‘Æ°á»£c `r lb(eq,'1')` nhÆ° sau 

$$
\begin{split}
\E[Y_i(t)] &= \E[Y_i(t)|T=t] \\
&= \E[Y_i|T=t], ~~~ \small\text{(Ä‘áº·c tÃ­nh consistency)}
\end{split}
$$ 
_(tham kháº£o vá» consistency [táº¡i Ä‘Ã¢y](https://ngoitruocgioxuan.github.io/goctuhoc/02_causal-inference/01_potential-outcomes.html))._ 
`r rs("\\square")`

NhÆ° váº­y $\E[Y|T=t]$ cÅ©ng sáº½ khÃ´ng Ä‘á»•i khi ta trÃ¡o Ä‘á»•i hÆ°á»›ng Ä‘iá»u trá»‹ cá»§a bá»‡nh nhÃ¢n dá»±a trÃªn hai máº·t Ä‘á»“ng xu. NÃ³i má»™t cÃ¡ch khÃ¡c, dÆ°á»›i Ä‘iá»u kiá»‡n cá»§a randomization thÃ¬ _causation_ vÃ  _association_ lÃ  Ä‘á»“ng nháº¥t, nghÄ©a lÃ   

$$
\P[Y(t)] = \P[Y|T=t].
(\#eq:eq2)
$$

Äá»ƒ chá»©ng minh `r lb(eq2)` trÆ°á»›c tiÃªn ta pháº£i xem xÃ©t khÃ¡i niá»‡m gá»i lÃ  _covariate balance_, nghÄ©a lÃ  phÃ¢n bá»‘ cá»§a cÃ¡c biáº¿n trÆ°á»›c khi can thiá»‡p cá»§a hai nhÃ³m Ä‘iá»u trá»‹ lÃ  giá»‘ng nhau. NghÄ©a lÃ  

$$
\P[X|T=1] \stackrel{d}{=} \P[X|T=0],
(\#eq:eq3)
$$
lÃ½ do lÃ  vÃ¬ khi cÃ¡c bá»‡nh nhÃ¢n Ä‘Æ°á»£c lá»±a chá»n ngáº«u nhiÃªn vÃ o má»™t trong hai nhÃ³m Ä‘iá»u trá»‹ thÃ¬ ta khÃ´ng xem xÃ©t táº¥t cáº£ thÃ´ng tin cá»§a cÃ¡c covariates $X$ ngoáº¡i trá»« yáº¿u tá»‘ can thiá»‡p $T$. VÃ­ dá»¥ ta dÃ¹ng má»™t Ä‘á»“ng xu Ä‘á»ƒ quyáº¿t Ä‘á»‹nh nhÃ³m Ä‘iá»u trá»‹ cho tá»«ng bá»‡nh nhÃ¢n thÃ¬ yáº¿u tá»‘ duy nháº¥t quyáº¿t Ä‘á»‹nh má»™t bá»‡nh nhÃ¢n $i$ nÃ o Ä‘Ã³ Ä‘Æ°á»£c xáº¿p vÃ o nhÃ³m treatment hay control chÃ­nh lÃ  Ä‘á»“ng xu Ä‘Ã³. Dá»±a vÃ o `r lb(eq3)` ta cÃ³ thá»ƒ chá»©ng minh Ä‘Æ°á»£c `r lb(eq2)` nhÆ° sau 

$$
\begin{split}
\P[Y(t)] &= \P[Y(t)|T], ~~~ \textit{(Y(1) and Y(0) are independent of T)} \\
&= \sum_x\P[Y(t)|T,X]\P(X) \\
&= \sum_x\frac{\P[Y|T,X]\P(T|X)\P(x)}{\P[T|X]} ~~~\textit{(consistency)}\\
&=\sum_x \frac{\P(Y,T,X)}{\P(T)} ~~~ {(X \indep T \textit{ mentioned above})} \\
&= \sum_x\frac{\P(Y,X|T)\P(T)}{\P(T)} \\
&= \P(Y|T)
\end{split}
$$
`r rs("\\square")`

NhÆ° váº­y, dÆ°á»›i Ä‘iá»u kiá»‡n randomization (ngáº«u nhiÃªn), $\E[Y_i(t)]$ cÃ³ thá»ƒ Ä‘Æ°á»£c xÃ¡c Ä‘á»‹nh báº±ng cÃ¡c Ä‘áº¡i lÆ°á»£ng cÃ³ thá»ƒ quan sÃ¡t cá»§a má»—i bá»‡nh nhÃ¢n vÃ  Ä‘á»“ng thá»i kháº³ng Ä‘á»‹nh tÃ­nh Ä‘á»“ng nháº¥t cá»§a causation vÃ  assiciation, Ä‘Ã¢y chÃ­nh lÃ  Ä‘iá»u kiá»‡n máº¥u chá»‘t lÃ m cho má»™t nghiÃªn cá»©u dá»±a trÃªn randomized controlled trials (RCTs) trá»Ÿ thÃ nh chá»n lá»±a tiÃªu chuáº©n Ä‘á»ƒ tiáº¿n hÃ nh thÃ­ nghiá»‡m. 

Tuy nhiÃªn, hiá»‡n nay Ä‘iá»u kiá»‡n tiÃªu chuáº©n nÃ y trá»Ÿ nÃªn cá»±c ká»³ khan hiáº¿m trong nhá»¯ng nghiÃªn cá»©u vá» thuá»‘c, bá»Ÿi vÃ¬ Ä‘á»ƒ cÃ³ Ä‘Æ°á»£c má»™t data Ä‘áº¡t tiÃªu chuáº©n nhÆ° tháº¿, Ä‘Ã²i há»i ráº¥t nhiá»u thá»i gian vÃ  tÃ i chÃ­nh cÅ©ng nhÆ° cÃ¡c váº¥n Ä‘á» vá» Ä‘áº¡o Ä‘á»©c. Trong trÆ°á»ng há»£p khÃ´ng Ä‘áº¡t Ä‘Æ°á»£c Ä‘iá»u kiá»‡n tiÃªu chuáº©n nhÆ° trÃªn, ta cáº§n pháº£i xem xÃ©t tá»›i cÃ¡c váº¥n Ä‘á»ƒ gÃ¢y nhiá»…u, vÃ  má»™t trong nhá»¯ng phÆ°Æ¡ng phÃ¡p Ä‘Ã³ lÃ  sá»­ dá»¥ng propensity scores, má»™t trong nhá»¯ng cÃ´ng cá»¥ Ä‘Æ°á»£c dÃ¹ng phá»• biáº¿n Ä‘á»ƒ má»¥c tiÃªu nÃ y. 

# Äá»‹nh nghÄ©a

Sá»­ dá»¥ng cÃ¹ng má»™t kÃ½ hiá»‡u nhÆ° bÃ i trÆ°á»›c, ta cÃ³ $X$ Ä‘áº¡i diá»‡n cho Ä‘iá»u kiá»‡n cá»§a bá»‡nh nhÃ¢n trÆ°á»›c khi can thiá»‡p (confounders), vÃ­ dá»¥ nhÆ° tuá»•i, giá»›i tÃ­nh, dÃ¢n tá»™c v.v... $T$ lÃ  phÆ°Æ¡ng phÃ¡p Ä‘iá»u trá»‹ (treatments), thÃ´ng thÆ°á»ng thÃ¬ chÃºng ta chá»‰ xem xÃ©t $T = \{0,1\}$. Tiáº¿p theo $Y$ Ä‘áº¡i diá»‡n cho káº¿t quáº£ cá»§a bá»‡nh nhÃ¢n sau khi Ä‘Ã£ can thiá»‡p. ChÃºng ta cÅ©ng cáº§n nháº¯c láº¡i sá»± khÃ¡c nhau giá»¯a $Y|T=t$ vÃ  $Y(t)$, trong khi cÃ¡i Ä‘áº§u tiÃªn chÃ­nh lÃ  cÃ¡i ta quan sÃ¡t Ä‘Æ°á»£c, tá»©c lÃ  thá»±c chá»©ng (factual) thÃ¬ cÃ¡i sau chÃ­nh lÃ  potential outcomes, vÃ  ta chá»‰ cÃ³ thá»ƒ quan sÃ¡t Ä‘Æ°á»£c hoáº·c lÃ  $Y(0)$ hoáº·c lÃ  $Y(1)$. cÃ¡i quan sÃ¡t Ä‘Æ°á»£c lÃ  factual thÃ¬ cÃ¡i khÃ´ng quan sÃ¡t Ä‘Æ°á»£c chÃ­nh lÃ  counterfactual. 

Dá»±a trÃªn quy Æ°á»›c _unconfoundedness_ ta cÃ³ 

$$
(Y_i(1),Y_i(0)) \indep T_i|\bf{X}_i
(\#eq:2)
$$
lÆ°u Ã½ $\bf{X}_i = (X_{i1}, X_{i2},\dots,X_{ip})^{\top}$ Ä‘áº¡i diá»‡n cho cÃ¡c Ä‘iá»u kiá»‡n cá»§a bá»‡nh nhÃ¢n $i$, vÃ­ dá»¥ nhÆ° $\bf{X}_i = (\text{tuá»•i, giá»›i tÃ­nh,dÃ¢n tá»™c})^{\top}$, náº¿u $p=3$. NhÆ° váº­y ta cÃ³ 

$$
\begin{split}
\E[Y_i(1)-Y_i(0)|\bf{X}_i] &= \E[Y_i(1)-Y_i(0)|T_i,\bf{X}_i] \\
&= \E[Y_i|T_i=1,\bf{X}_i] - \E[Y_i|T_i=0,\bf{X}_i] 
\end{split}
(\#eq:3)
$$

NhÆ° váº­y máº·c dÃ¹ viá»‡c chá»n treatment $T$ cho tá»«ng bá»‡nh nhÃ¢n trong nghiÃªn cá»©u xáº£y ra khÃ´ng ngáº«u nhiÃªn nhÆ°ng trong cÃ¹ng má»™t nhÃ³m cÃ¡c bá»‡nh nhÃ¢n cÃ³ Ä‘iá»u kiá»‡n giá»‘ng nhau (Ä‘Æ°á»£c phÃ¢n biá»‡t báº±ng cÃ¡c confounders $\bf{X}$) thÃ¬ treatment láº¡i Ä‘Æ°á»£c chá»n ngáº«u nhiÃªn. VÃ¬ tháº¿ náº¿u nhÆ° sample size (kÃ­ch cá»¡ máº«u) cá»§a má»—i nhÃ³m Ä‘á»§ lá»›n thÃ¬ ta hoÃ n toÃ n cÃ³ thá»ƒ xÃ¡c Ä‘á»‹nh $\E[Y_i(1)]$ vÃ  $\E[Y_i(0)]$ báº±ng sample mean (trung bÃ¬nh máº«u) trong tá»«ng nhÃ³m. NhÆ° tháº¿, hiá»‡u quáº£ tá»•ng há»£p cá»§a treatments Ä‘Æ°á»£c tÃ­nh báº±ng weighted mean (bÃ¬nh quÃ¢n gia quyá»n) cá»§a nhá»¯ng giÃ¡ trá»‹ means trong tá»«ng nhÃ³m. káº¿t quáº£ nÃ y sáº½ khÃ´ng chÃ­nh xÃ¡c náº¿u nhÆ° quy Æ°á»›c _positivity_ khÃ´ng thá»a, nghÄ©a lÃ  náº¿u cÃ³ báº¥t ká»³ 1 nhÃ³m nÃ o Ä‘Ã³ chá»‰ Ä‘Æ°á»£c Ä‘iá»u trá»‹ báº±ng má»™t phÆ°Æ¡ng phÃ¡p duy nháº¥t. CÅ©ng nhÆ° Ä‘Ã£ Ä‘á» cáº­p, nguy cÆ¡ quy Æ°á»›c nÃ y khÃ´ng thá»a sáº½ cÃ ng cao náº¿u nhÆ° sample size cÃ ng nhá». 


:::: {.blackbox .important data-latex=""}
::: {.center data-latex=""}
**Äá»‹nh nghÄ©a**
:::

__*Propensity score (PS)*__ Ä‘Æ°á»£c Ä‘á»‹nh nghÄ©a nhÆ° sau

$$
e(\bf{X}_i) = \P(T_i=1|\bf{X}_i)
(\#eq:4)
$$
xÃ¡c suáº¥t mÃ  má»™t bá»‡nh nhÃ¢n Ä‘Æ°á»£c xáº¿p vÃ o nhÃ³m treatment biáº¿t ráº±ng bá»‡nh nhÃ¢n nÃ y cÃ³ Ä‘iá»u kiá»‡n trÆ°á»›c can thiá»‡p lÃ  $\bf{X}$. 
::::

Dá»±a trÃªn quy Æ°á»›c _confoundedness_ thÃ¬ $\E[Y_i|T_i = 1,\bf{X}_i] = \E[Y_i|\bf{X}_i]$, vÃ  ta cÅ©ng cÃ³ thá»ƒ dá»±a trÃªn $e(\bf{X}_i)$ Ä‘á»ƒ káº¿t luáº­n tÆ°Æ¡ng tá»± nhÆ° sau

:::: {.blackbox .important data-latex=""}
::: {.center data-latex=""}
 
:::
$$
\E[Y_i|T_i = 1,e(\bf{X}_i)] = \E[Y_i|e(\bf{X}_i)]
(\#eq:5)
$$
::::

Tháº­t ra \@ref(eq:5) lÃ  há»‡ quáº£ náº¿u nhÆ° $T_i \indep Y_i(0),Y_i(1)|e(\bf{X}_i)$ Ä‘Ãºng, vÃ  Ä‘á»ƒ chá»©ng minh sá»± Ä‘á»™c láº­p giá»¯a treatment assignment vÃ  potential outcomes dÆ°á»›i Ä‘iá»u kiá»‡n cá»§a propensity score cáº§n chá»©ng minh Ä‘Æ°á»£c ráº±ng $\P[T_i =1|Y_i(0),Y_i(1),e(\bf{X}_i)] = \P[T_i =1|e(\bf{X}_i)]$. Ta sáº½ chá»©ng minh qua 2 bÆ°á»›c

:::: {.blackbox .mathematics data-latex=""}
::: {.center data-latex=""}
 mathy!!! (cÃ³ thá»ƒ bá» qua)
:::
**Chá»©ng minh** 
$$
\P[T_i =1|Y_i(0),Y_i(1),e(\bf{X}_i)] = \P[T_i =1|e(\bf{X}_i)]
(\#eq:6)
$$

Äáº§u tiÃªn ta cáº§n chá»©ng minh ráº±ng 
$$
T_i \indep \bf{X}_i|e(\bf{X}_i)
$$
nghÄ©a lÃ  ta sáº½ chá»©ng minh $\P[T_i=1|\bf{X}_i,e(\bf{X}_i)] = \P[T_i=1|e(\bf{X}_i)]$. Ta cÃ³ 

$$
VT = \P[T_i=1|\bf{X}_i,e(\bf{X}_i)] = \P[T_i=1|\bf{X}_i] = e(\bf{X}_i)
$$
dáº¥u báº±ng Ä‘áº§u tiÃªn xáº£y ra vÃ¬ $e(\bf{X}_i)$ lÃ  má»™t hÃ m sá»‘ cá»§a $\bf{X}_i$, dáº¥u báº±ng thá»© hai lÃ  Ä‘á»‹nh nghÄ©a cá»§a propensity score. 

$$
\begin{split}
VP = \P[T_i=1|e(\bf{X}_i)] &\stackrel{(1)}{=} \E[T_i=1|e(\bf{X}_i)] \\
&\stackrel{(2)}{=} \E\big[\E\big(T_i=1|e(\bf{X}_i),\bf{X}_i\big)|e(\bf{X}_i)\big] \\
&\stackrel{(3)}{=} \E[e(\bf{X}_i)|e(\bf{X}_i)]\\
&= e(\bf{X}_i)
\end{split}
$$

- (1): $T_i$ lÃ  má»™t phÃ¢n bá»‘ nhá»‹ phÃ¢n, vÃ  náº¿u $X \sim Bin(1,p)$, ta cÃ³ $\E(X) = p$.
- (2): sá»­ dá»¥ng cÃ´ng thá»©c $\E(X) = \E[\E(X|Y)]$.
- (3): expectation bÃªn trong ngoáº·c vuÃ´ng chÃ­nh lÃ  Ä‘á»‹nh nghÄ©a cá»§a propensity score

Tiáº¿p theo ta sáº½ chá»©ng minh \@ref(eq:6):

::::{.scroll-w }
$$
\begin{split}
\P[T_i =1|Y_i(0),Y_i(1),e(\bf{X}_i)] &\stackrel{(1)}{=} \E[T_i =1|Y_i(0),Y_i(1),e(\bf{X}_i)] \\
&\stackrel{(2)}{=} \E\big[\E\big(T_i|Y_i(0),Y_i(1),\bf{X}_i,e(\bf{X}_i)\big)|Y_i(0),Y_i(1),e(\bf{X}_i)\big]\\
&\stackrel{(3)}{=}\E\big[\E\big(T_i|\bf{X}_i,e(\bf{X}_i)\big)|Y_i(0),Y_i(1),e(\bf{X}_i)\big] \\
&\stackrel{(4)}{=} \E\big[\E\big(T_i|e(\bf{X}_i))|Y_i(0),Y_i(1),e(\bf{X}_i) \big] \\
&\stackrel{(5)}{=} \E\big(T_i|e(\bf{X}_i)\big)\E\big[1|Y_i(0),Y_i(1),e(\bf{X}_i)\big] \\
&=  \E\big(T_i|e(\bf{X}_i)\big) \\
&= \P[T_i=1|e(\bf{X}_i)]
\end{split}
$$
::::

- (1): treatment $T$ thuá»™c Bernoulli vá»›i tham sá»‘ $p = \P(T=1)$, nhá»› ráº±ng náº¿u $X\sim \mathcal{Ber}(p) \Rightarrow \P(X=1) = \E(X)$.
- (2): sá»­ dá»¥ng cÃ´ng thá»©c total expectation: $\E(X) = \E[\E(X|Y)]$.
- (3): sá»­ dá»¥ng quy Æ°á»›c confoundedness
- (4): sá»­ dá»¥ng káº¿t quáº£ chá»©ng minh á»Ÿ bÆ°á»›c 1.
- (5): vÃ¬ $\E(X|X=x) =x$
::::

# Suy luáº­n nhÃ¢n quáº£ dá»±a trÃªn Propensity score (PS)

PhÆ°Æ¡ng trÃ¬nh \@ref(eq:5) lÃ  ná»n táº£ng Ä‘á»ƒ ta cÃ³ thá»ƒ Ã¡p dá»¥ng PS trong suy luáº­n nhÃ¢n quáº£, nÃ³ cho phÃ©p 2 treatments cÃ³ thá»ƒ so sÃ¡nh trá»±c tiáº¿p dÆ°á»›i má»™t táº­p PS. CÃ³ nhiá»u cÃ¡ch sá»¯ dá»¥ng PS nháº±m lÃ m giáº£m Ä‘á»™ lá»‡ch cá»§a 2 nhÃ³m treatments, ta sáº½ láº§n lÆ°á»£t lÃ m quen vá»›i tá»«ng phÆ°Æ¡ng phÃ¡p. 

## CÃ¢n báº±ng hai nhÃ³m Ä‘iá»u trá»‹ dá»±a vÃ o Propensity score

Trong ráº¥t nhiá»u nghiÃªn cá»©u sá»­ dá»¥ng observational data, ta thÆ°á»ng gáº·p sá»‘ bá»‡nh nhÃ¢n thuá»™c nhÃ³m Ä‘iá»u trá»‹ (nhÃ³m active) Ã­t hÆ¡n ráº¥t nhiá»u so vá»›i nhÃ³m khÃ´ng Ä‘Æ°á»£c Ä‘iá»u trá»‹ (nhÃ³m control). Má»™t vÃ­ dá»¥ Ä‘iá»ƒn hÃ¬nh lÃ  má»™t nhÃ  váº­t lÃ½ trá»‹ liá»‡u cÃ³ má»™t data tá»« bá»‡nh viá»‡n, trong táº­p data nÃ y ghi nháº­n nhá»¯ng bá»‡nh nhÃ¢n Ä‘Æ°á»£c Ä‘iá»u trá»‹ bá»‡nh nhÆ°ng láº¡i khÃ´ng cÃ³ báº¥t ká»³ sá»‘ liá»‡u nÃ o cá»§a nhá»¯ng ngÆ°á»i thuá»™c nhÃ³m control. Trong trÆ°á»ng há»£p nÃ y, há» thÆ°á»ng tÃ¬m kiáº¿m cÃ¡c bá»‡nh nhÃ¢n thuá»™c nhÃ³m control tá»« má»™t kháº£o sÃ¡t vá»›i quy mÃ´ lá»›n. Trong trÆ°á»ng há»£p mÃ  nhÃ³m cÃ¡c bá»‡nh nhÃ¢n control nhiá»u hÆ¡n nhÃ³m active ráº¥t nhiá»u thÃ¬ ta cÃ³ thá»ƒ chá»n á»©ng viÃªn trong nhÃ³m control cho tá»«ng bá»‡nh nhÃ¢n trong nhÃ³m Ä‘iá»u trá»‹. quÃ¡ trÃ¬nh nÃ y Ä‘Æ°á»£c thá»±c hiá»‡n qua 4 bÆ°á»›c [@stu2010] nhÆ° sau 

1. chá»n Ä‘áº¡i lÆ°á»£ng Ä‘á»ƒ tÃ­nh khoáº£ng cÃ¡ch giá»¯a cÃ¡c units. 
2. sau khi Ä‘Ã£ xÃ¡c Ä‘á»‹nh Ä‘Æ°á»£c Ä‘áº¡i lÆ°á»£ng khoáº£ng cÃ¡ch, tiáº¿n hÃ nh matching 
3. Ä‘Ã¡nh giÃ¡ káº¿t quáº£, bÆ°á»›c 1-2 cÃ³ thá»ƒ thá»±c hiá»‡n láº¡i nhiá»u láº§n Ä‘á»ƒ tÃ¬m káº¿t quáº£ tá»‘t nháº¥t
4. tiáº¿n hÃ nh phÃ¢n tÃ­ch outcomes and estimate hiá»‡u quáº£ cá»§a treatments

BÆ°á»›c (1) chia lÃ m 2 bÆ°á»›c nhá» hÆ¡n lÃ  chá»n biáº¿n pretreatments vÃ  liÃªn káº¿t cÃ¡c biáº¿n Ä‘Æ°á»£c chá»n thÃ nh 1 Ä‘áº¡i lÆ°á»£ng duy nháº¥t. Táº¡i sao pháº£i chá»n pretreatments? trong nhiá»u trÆ°á»ng há»£p data Ä‘Æ°á»£c sá»­ dá»¥ng chá»©a nhiá»u biáº¿n pretreatments hÆ¡n sá»‘ units, nhÆ° váº­y ta khÃ´ng thá»ƒ chá»n táº¥t cáº£ cÃ¡c biáº¿n Ä‘Ã³, mÃ  chá»‰ chá»n nhá»¯ng biáº¿t tháº­t sá»± quan trá»ng. CÃ³ nhiá»u tÃ i liá»‡u bÃ n luáº­n vá» phÆ°Æ¡ng phÃ¡p chá»n biáº¿n, nhÆ°ng nhÃ¬n chung váº«n chÆ°a Ä‘Æ°a ra Ä‘Æ°á»£c má»™t phÆ°Æ¡ng phÃ¡p nÃ o thuyáº¿t phá»¥c, vÃ  nhá»¯ng phÆ°Æ¡ng phÃ¡p Ä‘Ã³ cÃ³ thá»ƒ cho ra nhá»¯ng káº¿t quáº£ ráº¥t khÃ¡c nhau. BÃªn cáº¡nh Ä‘Ã³, viá»‡c chá»n biáº¿n phÃ¹ há»£p Ä‘á»ƒ phÃ¢n tÃ­ch cÃ²n phá»¥ thuá»™c ráº¥t nhiá»u vÃ o kiáº¿n thá»©c ná»n cá»§a ngÆ°á»i nghiÃªn cá»©u, ta khÃ´ng thá»ƒ chá»‰ dá»±a vÃ o cÃ¡c hypothesis tests Ä‘Æ¡n thuáº§n Ä‘á»ƒ káº¿t luáº­n. Tuy nhiÃªn ta cÅ©ng nÃ³i sÆ¡ qua vá» phÆ°Æ¡ng phÃ¡p _stepwise_ Ä‘Æ°á»£c Ä‘á» cáº­p bá»Ÿi @vij2015. Trong tÃ i liá»‡u nÃ y, tÃ¡c giáº£ Ä‘Ã£ Ä‘Æ°a ra 3 bÆ°á»›c tiáº¿n hÃ nh chá»n biáº¿n, thá»© nháº¥t lÃ  chá»n ra cÃ¡c biáº¿n quan trá»ng dá»±a vÃ o kiáº¿n thá»©c chuyÃªn ngÃ nh cá»§a ngÆ°á»i nghiÃªn cá»©u. BÆ°á»›c 2, sá»­ dá»¥ng stepwise Ä‘á»ƒ chá»n ra nhá»¯ng biáº¿n cÃ²n láº¡i trong sá»‘ cÃ¡c biáº¿n chÆ°a Ä‘Æ°á»£c chá»n dá»±a vÃ o Ä‘áº¡i lÆ°á»£ng likelihood ratio vÃ  hypothesis test. BÆ°á»›c 3, sau khi cÃ¡c biáº¿n báº­c 1 Ä‘Ã£ Ä‘Æ°á»£c chá»n ta tiáº¿p tá»¥c chá»n ra biáº¿n báº­c 2 vÃ  biáº¿n tÆ°Æ¡ng tÃ¡c, phÆ°Æ¡ng phÃ¡p váº«n nhÆ° bÆ°á»›c 2. QuÃ¡ trÃ¬nh nÃ y Ä‘Æ°á»£c thá»±c hiá»‡n Ä‘áº¿n khi tÃ¬m ra Ä‘Æ°á»£c táº­p biáº¿n phÃ¹ há»£p. Tuy váº­y @stu2010 cÅ©ng Ä‘Ã£ kháº³ng Ä‘á»‹nh trong bÃ i bÃ¡o lÃ  phÆ°Æ¡ng phÃ¡p stepwise khÃ´ng tháº­t sá»± há»¯u Ã­ch vÃ¬ trong khi má»¥c tiÃªu cá»§a ta lÃ  tÃ¬m ra PS sao cho phÃ¢n bá»‘ cá»§a cÃ¡c confounders giá»¯a 2 nhÃ³m Ä‘iá»u trá»‹ tÆ°Æ¡ng tá»± nhau, thÃ¬ phÆ°Æ¡ng phÃ¡p stepwise láº¡i dá»±a trÃªn treatments. TÃ¬m hiá»ƒu chi tiáº¿t táº¡i @vij2015 vÃ  @stu2010.

BÆ°á»›c (2) ta xÃ¡c Ä‘á»‹nh Ä‘áº¡i lÆ°á»£ng Ä‘á»ƒ tÃ­nh khoáº£ng cÃ¡ch giá»¯a cÃ¡c units, nÃ³i cÃ¡ch khÃ¡c lÃ  má»©c Ä‘á»™ giá»‘ng nhau cá»§a 2 units. Theo @stu2010 thÃ¬ cÃ³ bá»‘n phÆ°Æ¡ng phÃ¡p cÄƒn báº£n Ä‘á»ƒ Ä‘á»‹nh nghÄ©a khoáº£ng cÃ¡ch $D_{ij}$ giá»¯a bá»‡nh nhÃ¢n $i$ vÃ  bá»‡nh nhÃ¢n $j$ lÃ  

1. Exact: 
$$
D_{ij} = \cases{0, \text{ if } X_i = X_j\\
\infty, \text{ if } X_i \ne X_j
}
$$
2. Mahalanobis: 
$$
D_{ij} = (X_i-X_j)^{\top}\Sigma^{-1}(X_i - X_j)
$$
trong Ä‘Ã³, $\Sigma$ chÃ­nh lÃ  covariance matrix cá»§a $X$. 
3. Propensity score :
$$
D_{ij} = |e_i-e_j|
$$
trong Ä‘Ã³ $e_k$ chÃ­nh lÃ  PS cá»§a bá»‡nh nhÃ¢n thá»© $k$. 
4. Linear PS:
$$
D_{ij} = |logit(e_i) - logit(e_j)|
$$

Tuy nhiÃªn ta chá»‰ táº­p trung vÃ o 2 phÆ°Æ¡ng phÃ¡p cuá»‘i vÃ¬ nÃ³ liÃªn quan tá»›i PS. ÄÃ´i khi ta cÃ³ thá»ƒ káº¿t há»£p giá»¯a phÆ°Æ¡ng phÃ¡p sá»‘ (2) vÃ  sá»‘ (3), nhÆ° váº­y ta cÃ³
$$
D_{ij} \cases{(Z_i-Z_j)^{\top}\Sigma^{-1}(Z_i-Z_j), \text{ if } |logit(e_i)-logit(e_j)|\le c\\
\infty, \text{ if } |logit(e_i)-logit(e_j)| > c
}
$$
trong Ä‘Ã³ $c$ gá»i lÃ  caliper vÃ  $Z$ lÃ  táº­p há»£p cÃ¡c biáº¿n pretreatment quan trá»ng. 

Sau khi Ä‘Ã£ cÃ³ táº­p biáº¿n pretreatment, ta tiáº¿n hÃ nh estimate propensity score. Bá»Ÿi vÃ¬ theo Ä‘á»‹nh nghÄ©a thÃ¬ propensity score chÃ­nh lÃ  xÃ¡c suáº¥t Ä‘Æ°á»£c xáº¿p vÃ o nhÃ³m treatment dÆ°á»›i má»™t Ä‘iá»u kiá»‡n cho trÆ°á»›c cá»§a confounders $\P[T=1|X]$. Ta cÅ©ng biáº¿t ráº±ng $T \sim \mathcal{Ber}(p)$, nÃªn táº¥t cáº£ cÃ¡c models Ä‘Æ°á»£c sá»­ dá»¥ng vá»›i cho outcome dÆ°á»›i Ä‘á»‹nh dáº¡ng nhá»‹ phÃ¢n (binary) Ä‘á»u cÃ³ thá»ƒ sá»­ dá»¥ng, phá»• biáº¿n nháº¥t lÃ  logistic. LÆ°u Ã½ ráº±ng khi ta xÃ¢y dá»±ng logistic model, má»¥c tiÃªu cá»§a ta khÃ´ng pháº£i suy luáº­n vá» outcomes mÃ  Ä‘á»ƒ xÃ¡c Ä‘á»‹nh propensity score , vÃ¬ tháº¿ váº¥n Ä‘á» ta quan tÃ¢m khÃ´ng náº±m á»Ÿ cÃ¡c parameters cá»§a model mÃ  lÃ  cÃ¡c biáº¿n pretreatment cÃ³ cÃ¢n báº±ng hay khÃ´ng. 

Tiáº¿p theo lÃ  ta báº¯t Ä‘áº§u matching sau khi Ä‘Ã£ xÃ¡c Ä‘á»‹nh Ä‘Æ°á»£c cÃ¡c PS. CÅ©ng cÃ³ ráº¥t nhiá»u cÃ¡c phÆ°Æ¡ng phÃ¡p Ä‘á»ƒ matching, ta sáº½ khÃ¡i quÃ¡t cÃ¡c phÆ°Æ¡ng phÃ¡p Ä‘Æ°á»£c Ä‘á» cáº­p trong má»™t sá»‘ tÃ i liá»‡u vÃ  sau Ä‘Ã³ lÃ  Ä‘i sÃ¢u vÃ o 1 phÆ°Æ¡ng phÃ¡p Ä‘ang Ä‘Æ°á»£c sá»­ dá»¥ng rá»™ng rÃ£i. 

### Matching vá»›i Ä‘Æ¡n vá»‹ gáº§n nháº¥t

ÄÆ°á»£c biáº¿t nhÆ° lÃ  phÆ°Æ¡ng phÃ¡p _matching Ä‘Æ¡n vá»‹ gáº§n nháº¥t $k:1$_, dáº¡ng Ä‘Æ¡n giáº£n nháº¥t cá»§a loáº¡i matching nÃ y lÃ  matching $1:1$, nghÄ©a lÃ  má»—i má»™t Ä‘Æ¡n vá»‹ trong nhÃ³m treatment sáº½ Ä‘Æ°á»£c match vá»›i má»™t Ä‘Æ¡n vá»‹ trong nhÃ³m control. Má»™t váº¥n Ä‘á» cÃ³ thá»ƒ phÃ¡t sinh lÃ  bá»Ÿi vÃ¬ cÃ³ quÃ¡ nhiá»u Ä‘Æ¡n vá»‹ trong nhÃ³m control bá»‹ loáº¡i bá» (vÃ¬ PS cá»§a nÃ³ quÃ¡ xa vá»›i cÃ¡c Ä‘Æ¡n vá»‹ trong nhÃ³m active), nÃªn sáº½ lÃ m giáº£m Ä‘á»™ tin cáº­y khi phÃ¢n tÃ­ch. Tuy nhiÃªn viá»‡c giáº£m Ä‘á»™ tin cáº­y nÃ y chiáº¿m tá»‰ lá»‡ ráº¥t nhá» vÃ¬ 2 lÃ½ do. Thá»© nháº¥t, Trong so sÃ¡nh giÃ¡ trá»‹ mean cá»§a 2 samples, thÃ¬ Ä‘á»™ tin cáº­y khi phÃ¢n tÃ­ch Ä‘Æ°á»£c quyáº¿t Ä‘á»‹nh pháº§n nhiá»u bá»Ÿi sample cÃ³ kÃ­ch cá»¡ nhá» hÆ¡n. VÃ¬ tháº¿ má»™t khi kÃ­ch cá»¡ nhÃ³m active khÃ´ng Ä‘á»•i thÃ¬ sáº½ khÃ´ng cÃ³ quÃ¡ nhiá»u thÃ´ng tin bá»‹ máº¥t. Thá»© hai, má»™t khi 2 nhÃ³m treatments tÆ°Æ¡ng Ä‘á»“ng nhau thÃ¬ Ä‘á»™ tin cáº­y sáº½ tÄƒng. 

### Subclassification, Full matching vÃ  Weighting 

Ba phÆ°Æ¡ng phÃ¡p nÃ y cÃ² 1 Ä‘áº·c tÃ­nh vÆ°á»£t trá»™i hÆ¡n so vá»›i phÆ°Æ¡ng phÃ¡p trÆ°á»›c Ä‘Ã³ lÃ  ta cÃ³ thá»ƒ sá»­ dá»¥ng táº¥t cáº£ cÃ¡c units cÃ³ trong data mÃ  khÃ´ng pháº£i loáº¡i bá» Ä‘i báº¥t cá»© units nÃ o náº¿u nhÆ° Ä‘áº¡i lÆ°á»£ng khoáº£ng cÃ¡ch khÃ´ng thá»a mÃ£n.

#### Subclassification

NhÆ° Ä‘Ã£ trÃ¬nh bÃ y á»Ÿ trÃªn, vÃ¬ phÆ°Æ¡ng phÃ¡p PS matching chá»‰ chá»n má»™t pháº§n cá»§a cÃ¡c units náº±m trong nhÃ³m control, ta cÃ³ quyá»n nghi ngá» vá» Ä‘á»™ tin cáº­y trong phÃ¢n tÃ­ch. VÃ¬ tháº¿, Ä‘á»ƒ háº¡n cháº¿ Ä‘iá»u nÃ y ta cÃ³ thá»ƒ sá»­ dá»¥ng phÆ°Æ¡ng phÃ¡p subclassification hay cÃ²n gá»i lÃ  stratification. NhÆ° váº­y cÃ¡c units sáº½ Ä‘Æ°á»£c phÃ¢n cá»¥m dá»±a trÃªn giÃ¡ trá»‹ PS tÆ°Æ¡ng á»©ng. VÃ­ dá»¥ ta kÃ½ hiá»‡u $0 = c_0 < c_1 < \dots <c_m =1$ Ä‘áº¡i diá»‡n cho $m$ cá»¥m tÆ°Æ¡ng á»©ng vá»›i $m$ khoáº£ng trÃªn vector cÃ¡c giÃ¡ trá»‹ PS, nhÆ° tháº¿ nhÃ³m thá»© $k$ sáº½ bao gá»“m cÃ¡c units mÃ  giÃ¡ trá»‹ PS tÆ°Æ¡ng á»©ng cá»§a nÃ³ náº±m trong khoáº£ng $I_k = (c_{k-1},c_k]$. NhÆ° váº­y trong má»—i má»™t nhÃ³m ta cÃ³ thá»ƒ tÃ­nh Ä‘Æ°á»£c hiá»‡u quáº£ Ä‘iá»u trá»‹ cá»§a treatments lÃ  $\E[Y_{i|1} - Y_{i|0}|e_i = e]$, bá»Ÿi vÃ¬ Ä‘áº¡i lÆ°á»£ng nÃ y phá»¥ thuá»™c trÃªn $e$, ta cÃ³ thá»ƒ xem lÃ  má»™t hÃ m sá»‘ cá»§a $e$. Theo lÃ½ thuyáº¿t ta cÅ©ng cÃ³ 

$$
\E[Y_{i|j}|e_i \in I_k] \approx \E[Y_{i|j}|T_i=j,e_i \in I_k]
$$
vá»›i $k = 1,2,\dots,m; j = 1,2$.

NhÆ° váº­y, trong má»—i má»™t cá»¥m tÆ°Æ¡ng á»©ng vá»›i khoáº£ng $I_k$, ta cÃ³ thá»ƒ tÃ­nh Ä‘Æ°á»£c 

$$
\hat{\E}(Y_{i|1}|e_i \in I_k) = 
\frac{\sum_{e_i\in I_k,T_i=1}Y_{i|1}}{n_{k|1}}; ~~~~
\hat{\E}(Y_{i|0}|e_i \in I_k) =  \frac{\sum_{e_i\in I_k,T_i=0}Y_{i|0}}{n_{k|0}}
$$
trong Ä‘Ã³ $n_{k|1}$ vÃ  $n_{k|0}$ láº§n lÆ°á»£t lÃ  kÃ­ch cá»¡ máº«u cá»§a 2 nhÃ³m Ä‘iá»u trá»‹ trong cá»¥m $k$. NhÆ° váº­y ta cÃ³ thá»ƒ Ä‘Ã¡nh giÃ¡ Ä‘Æ°á»£c ká»³ vá»ng hiá»‡u quáº£ Ä‘iá»u trá»‹ lÃ  

$$
\hat{\E}[Y_{i|1}|e_i \in I_k] - \hat{\E}[Y_{i|0}|e_i \in I_k]
(\#eq:7)
$$

VÃ¬ ta cÃ³ táº¥t cáº£ lÃ  $m$ cá»¥m Ä‘Æ°á»£c chia theo $m$ khoáº£ng cá»§a PS, ta cÃ³ thá»ƒ tÃ­nh tá»•ng há»£p hiá»‡u quáº£ Ä‘iá»u trá»‹ qua cÃ¡c cá»¥m lÃ  

$$
\sum_{k=1}^m\Big[\E(Y_{i|1}|e_i\in I_k) - \E(Y_{i_0}|e_i\in I_k)  \Big]\P(e_i \in I_k)
$$

vá»›i 
$$
\P(e \in I_k) = \frac{n_{k|1}+n_{k|0}}{n}
$$ 
trong Ä‘Ã³ $n$ lÃ  kÃ­ch cá»¡ máº«u.

:::: {.blackbox .mathematics data-latex=""}
::: {.center data-latex=""}
a little mathy!!! (cÃ³ thá»ƒ bá»)
:::
Ta cÃ³ thá»ƒ viáº¿t phÆ°Æ¡ng trÃ¬nh trÃªn á»Ÿ dáº¡ng tá»•ng quÃ¡t, nghÄ©a lÃ  ta cÃ³ táº¥t cáº£ $n$ giÃ¡ trá»‹ $e$ vÃ  $n \rightarrow \infty$. NghÄ©a lÃ  tá»« \@ref(eq:7) ta suy ra 
$$
\int \Big[\E(Y_{i|1}|e_i=e) -  \E(Y_{i|0}|e_i=e)\Big]f(e)de
$$
trong Ä‘Ã³

:::: {.scroll-w}
$$\int_{c_{k-1}}^{c_k}\E(Y_{i|j}|e_i=e)f(e)de = \E(Y_{i|j}|e_i \in I_k)\int_{c_{k-1}}^{c_k}f(e)de = \E(Y_{i|j}|e_i \in I_k)\P(e_i \in I_k)$$
::::
::::

Váº¥n Ä‘á» cÃ²n láº¡i lÃ  ta pháº£i chia khoáº£ng cho cÃ¡c giÃ¡ trá»‹ cá»§a PS $e_i$, $i=1,2,\dots,n$ nhÆ° tháº¿ nÃ o cho phÃ¹ há»£p. Äá»ƒ Ä‘Æ¡n giáº£n ta cÃ³ thá»ƒ chia thÃ nh $5-10$ cá»¥m lÃ  phÃ¹ há»£p. Tuy nhiÃªn Ä‘á»‘i vá»›i nhÃ³m cÃ³ kÃ­ch cá»¡ nhá», ta cÃ³ thá»ƒ dá»±a vÃ o phÃ¢n vá»‹ cá»§a PS Ä‘á»ƒ chia cá»¥m. 

NgoÃ i ra, @vij2015 Ä‘Ã£ giá»›i thiá»‡u Ä‘áº¿n má»™t phÆ°Æ¡ng phÃ¡p sá»­ dá»¥ng mÃ¡y Ä‘á»ƒ cháº¡y thuáº­t toÃ¡n nháº±m phÃ¢n chia cÃ¡c cá»¥m sao cho Ä‘áº¡t káº¿t quáº£ tá»‘t nháº¥t. BÃªn cáº¡nh Ä‘Ã³ tÃ¡c giáº£ cÅ©ng Ä‘á» nghá»‹ ta kiá»ƒm tra tÃ­nh Ä‘á»™c láº­p giá»¯a treatment vÃ  cÃ¡c biáº¿n pretretments trong má»—i má»™t cá»¥m, nghÄ©a lÃ  $T_i \indep X_i|e(x_i)$. ÄÃ¢y cÅ©ng chÃ­nh lÃ  phÆ°Æ¡ng phÃ¡p _full matching_. VÃ¬  nhá»¯ng phÆ°Æ¡ng phÃ¡p ká»ƒ trÃªn Ã­t Ä‘Æ°á»£c sá»­ dá»¥ng nÃªn ta chá»‰ nÃ³i sÆ¡ qua Ä‘á»ƒ ta cÃ³ cÃ¡i nhÃ¬n tá»•ng quÃ¡t vá» cÃ¡c phÆ°Æ¡ng phÃ¡p sá»­ dá»¥ng PS trong suy luáº­n nhÃ¢n quáº£. PhÆ°Æ¡ng phÃ¡p sá»­ dá»¥ng PS khÃ¡ phá»• biáº¿n hiá»‡n nay lÃ  phÆ°Æ¡ng phÃ¡p weighting, sáº½ Ä‘Æ°á»£c tÃ¬m hiá»ƒu á»Ÿ pháº§n tiáº¿p theo. 

#### PhÆ°Æ¡ng phÃ¡p weighting 

 chÃºng ta biáº¿t báº±ng má»—i má»™t PS chÃ­nh lÃ  xÃ¡c suáº¥t bá»‡nh nhÃ¢n Ä‘Æ°á»£c xáº¿p vÃ o nhÃ³m active, $e \in (0,1)$, nhÆ° váº­y náº¿u nhÆ° PS cá»§a má»™t bá»‡nh nhÃ¢n nÃ o Ä‘Ã³ lÃ  $e = 0.1$ thÃ¬ giÃ¡ trá»‹ nÃ y cho ta biáº¿t cÃ³ táº¥t cáº£ $1/e = 10$ bá»‡nh nhÃ¢n  thuá»™c nhÃ³m active cÃ³ Ä‘iá»u kiá»‡n giá»‘ng nhau. TÆ°Æ¡ng tá»±, sáº½ cÃ³ táº¥t cáº£ $1/(1-0.1) =1.1$ bá»‡nh nhÃ¢n thuá»™c nhÃ³m control cÃ³ cÃ¹ng Ä‘iá»u kiá»‡n. VÃ¬ tháº¿ ta chá»‰ cáº§n nhÃ¢n giÃ¡ trá»‹ cáº§n tÃ­nh cho $1/e$ hay $1/(1-e)$ tÃ¹y thuá»™c vÃ o bá»‡nh nhÃ¢n Ä‘Ã³ náº¯m trong nhÃ³m Ä‘iá»u trá»‹ nÃ o. $1/e$ vÃ  $1/(1-e)$ Ä‘Æ°á»£c gá»i _inverse probability weighting (IPW)_, ta cÃ³ thá»ƒ biá»ƒu diá»…n IPW á»Ÿ dáº¡ng tá»•ng quÃ¡t nhÆ° sau 
$$
w_i  = \frac{T_i}{e_i} + \frac{1-T_i}{1-e_i}.
$$
Ä‘Ã¢y cÅ©ng Ä‘Æ°á»£c gá»i lÃ  Æ°á»›c lÆ°á»£ng Horvitz-Thompson. DÆ°á»›i quy Æ°á»›c _unconfoundedness_ ta cÃ³ 

$$
\E\Big[\frac{T_iY_i}{e_i}\Big] = \E[Y_i(1)],~~~\text{and }~~~~ \E\Big[\frac{(1-T_i)Y_i}{1-e_i}\Big] = \E[Y_i(0)]
(\#eq:8)
$$

:::: {.blackbox .mathematics data-latex=""}
::: {.center data-latex=""}
(cÃ³ thá»ƒ bá» qua)
:::
**Chá»©ng minh ráº±ng:**
$$
\E\Big[\frac{T_iY_i}{e_i}\Big] = \E[Y_i(1)]
(\#eq:9)
$$
Ta chá»‰ xem xÃ©t trÆ°á»ng há»£p khi $T_i=1$, vÃ¬ khi $T_i=0$ thÃ¬ \@ref(eq:8) sáº½ báº±ng $0$. Ta cÃ³ $\Big[\frac{Y_i}{e_i}\Big|T_i=1\Big] = \Big[\frac{Y_i(1)}{e_i}\Big|T_i=1\Big]$, nÃªn
$$
\E\Big[\frac{T_iY_i}{e_i}\Big] = \E\Big[\frac{T_iY_i(1)}{e_i}\Big].
(\#eq:10)
$$

Sá»­ dá»¥ng _total of expectation_, ta cÃ³
$$
\E\Big[\frac{T_iY_i(1)}{e_i}\Big] = \E\Big[\E\Big(\frac{T_iY_i(1)}{e_i}\Big|X_i\Big)\Big]
(\#eq:11)
$$
ta cÅ©ng biáº¿t ráº±ng dÆ°á»›i Ä‘iá»u kiá»‡n  cá»§a biáº¿n pretreatment $X$ thÃ¬ can thiá»‡p $T$ vÃ  káº¿t quáº£ $Y$ Ä‘á»™c láº­p, vÃ¬ tháº¿ $\E(TY) = \E(T)\E(Y)$, sá»­ dá»¥ng tÃ­nh Ä‘á»™c láº­p nÃ y ta cÃ³ 

$$
\E\Big[\frac{T_iY_i(1)}{e_i}\Big|X_i\Big] = \frac{\E(T_i|X_i)\E(Y_i(1)|X_i)}{e_i} = \frac{e_i\E(Y_i(1)|X_i)}{e_i} = \E(Y_i(1)|X_i)
(\#eq:12)
$$
lÆ°u Ã½ $e_i = e(X_i)$ lÃ  má»™t hÃ m cá»§a $X_i$, vÃ¬ tháº¿ $\E(e(X_i)|X_i=x_i) = e(x_i)$. NhÆ° váº­y tá»« \@ref(eq:11) vÃ  \@ref(eq:12) ta cÃ³ \@ref(eq:9). Chá»©ng minh tÆ°Æ¡ng tá»± cho trÆ°á»ng há»£p cÃ²n láº¡i cá»§a \@ref(eq:8).
::::

Tá»« \@ref(eq:8) ta cÃ³ thá»ƒ Æ°á»›c lÆ°á»£ng tá»« sá»‘ máº«u nhÆ° sau 

$$
\hat{\E}(Y_i(1)) = \frac{1}{n}\sum_{i=1}^n\frac{T_iY_{i|T}}{e_i}~~~ and ~~~ \hat{\E}(Y_i(0)) = \frac{1}{n}\sum_{i=1}^n\frac{(1-T_i)Y_{i|T}}{1- e_i}
(\#eq:13)
$$
NhÆ° váº­y ta cÃ³ thá»ƒ Æ°á»›c lÆ°á»£ng Ä‘Æ°á»£c giÃ¡ trá»‹ cá»§a Ä‘áº¡i lÆ°á»£ng Ä‘áº¡i diá»‡n cho hiá»‡u quáº£ cá»§a hai nhÃ³m bá»‡nh nhÃ¢n lÃ  $\hat{\tau} = \E[Y_i(1)] - \E[Y_0(0)]$ tá»« \@ref(eq:13). 

NhÆ° Ä‘Ã£ nÃ³i, trong thá»±c táº¿ ta khÃ´ng biáº¿t Ä‘Æ°á»£c giÃ¡ trá»‹ Ä‘Ãºng cá»§a cÃ¡c $e_i$ nhÆ°ng ta cÃ³ thá»ƒ Æ°á»›c lÆ°á»£ng chÃºng báº±ng cÃ¡ch fit nhá»¯ng models mÃ  biáº¿n outcome thuá»™c Ä‘á»‹nh dáº¡ng nhá»‹ phÃ¢n (binary), vÃ­ dá»¥ tiÃªu biá»ƒu lÃ  logistic model. NhÆ° váº­y, sau khi Ä‘Ã£ tÃ¬m Ä‘Æ°á»£c Æ°á»›c lÆ°á»£ng cá»§a $e_i$ lÃ  $\hat{e}_i$ ta sáº½ sá»­ dá»¥ng $\hat{e}_i$ trong cÃ´ng thá»©c \@ref(eq:13) vÃ  sau Ä‘Ã³ tÃ­nh $\hat{\tau} = \E[Y_i(1)] - \E[Y_0(0)]$. 

Má»™t Ä‘iá»ƒm ná»¯a cáº§n nháº¯c tá»›i, Náº¿u nhÆ° cáº£ biáº¿n káº¿t quáº£ $Y$ cÅ©ng lÃ  biáº¿n binary, thÃ¬ ta sáº½ cÃ³ má»™t sá»‘ Ä‘áº¡i lÆ°á»£ng thÆ°á»ng Ä‘Æ°á»£c sá»­ dá»¥ng Ä‘á»ƒ thá»ƒ hiá»‡n tÃ­nh hiá»‡u quáº£ cá»§a can thiá»‡p. á» trÃªn ta nháº¯c tá»›i $\tau = \E(Y(1) - Y(0))$, trong trÆ°á»ng há»£p nhá»‹ phÃ¢n, thÃ¬ cÃ´ng thá»©c nÃ y Ä‘Æ°á»£c gá»i lÃ  _risk difference_, ngoÃ i ra cÃ³ 2 Ä‘áº¡i lÆ°á»£ng khÃ¡c cÅ©ng Ä‘Æ°á»£c sá»­ dá»¥ng phá»• biáº¿n lÃ  _risk ratio_ vÃ  _odd ratio_. Ta sáº½ cÃ³ má»™t bÃ i riÃªng nÃ³i vá» cÃ¡c Ä‘áº¡i lÆ°á»£ng phÃ¢n tÃ­ch nÃ y. Trong pháº¡m vi bÃ i nÃ y, náº¿u ta muá»‘n Ä‘Ã¡nh giÃ¡ hiá»‡u quáº£ thÃ´ng qua Ä‘áº¡i lÆ°á»£ng odd ratio, ta sáº½ fit model báº±ng cÃ´ng thá»©c 

$$
Y_{i|T} = \alpha+\tau T_i +\epsilon_i
$$
model nÃ y Ä‘Æ°á»£c fit báº±ng weighted least squares. 

# Kiá»ƒm Tra Äá»™ CÃ¢n Báº±ng cá»§a PS

TrÆ°á»›c khi Æ°á»›c lÆ°á»£ng $\{\hat{e}_i:i=1,2,\dots,n\}$ cá»§a PS Ä‘Æ°á»£c sá»­ dá»¥ng trong quÃ¡ trÃ¬nh phÃ¢n tÃ­ch thÃ¬ ta cáº§n cÃ³ má»™t Ä‘áº¡i lÆ°á»£ng Ä‘á»ƒ Ä‘Ã¡nh giÃ¡ sá»± Ä‘á»™ cÃ¢n báº±ng cá»§a cÃ¡c confounders $\bf{X}$. NÃ³i cÃ¡ch khÃ¡c ta muá»‘n xem xÃ©t Ä‘á»™ khÃ¡c biá»‡t cá»§a cÃ¡c biáº¿n confounders sau khi sá»­ dá»¥ng PS. Theo @aus2011 ta sá»­ dá»¥ng Ä‘áº¡i lÆ°á»£ng _standardized difference_ nhÆ° bÃªn dÆ°á»›i Ä‘á»ƒ Ä‘o Ä‘á»™ khÃ¡c biá»‡t

$$
d = \frac{\bar{x}_1 - \bar{x}_0 }{\sqrt{\frac{s^2_1 + s^2_0}{2}}}
(\#eq:14)
$$
sá»­ dá»¥ng cho biáº¿n liÃªn tá»¥c trong Ä‘Ã³ $\bar{x}_1, s^2_1$ vÃ  $\bar{x}_0,s^2_0$  láº§n lÆ°á»£t lÃ  weighted mean vÃ  weighted variance cá»§a 2 nhÃ³m treatment vÃ  control. VÃ  

$$
d = \frac{\hat{p}_1 - \hat{p}_0}{\sqrt{\frac{\hat{p}_1(1-\hat{p}_1)+\hat{p}_0(1-\hat{p}_0)}{2}}}
$$
sá»­ dá»¥ng cho biáº¿n rá»i ráº¡c, trong Ä‘Ã³ $\hat{p}_1$ vÃ  $\hat{p}_0$ láº§n lÆ°á»£t lÃ  tá»‰ lá»‡ cá»§a tá»«ng sá»± kiá»‡n cá»§a 1 biáº¿n confounders. Hai trá»‹ sá»‘ nÃ y cÅ©ng Ä‘Æ°á»£c tÃ­nh báº±ng weighted proportion. 

Trong quÃ¡ trÃ¬nh bÃ¡o cÃ¡o, ta pháº£i sá»­ dá»¥ng 2 Ä‘áº¡i lÆ°á»£ng Ä‘á»ƒ tÃ­nh Ä‘á»™ khÃ¡c biá»‡t cá»§a cÃ¡c biáº¿n confounders trÆ°á»›c vÃ  sau khi sá»­ dá»¥ng PS Ä‘á»ƒ tháº¥y Ä‘Æ°á»£c sá»± thay Ä‘á»•i trong cáº¥u trÃºc phÃ¢n bá»‘ cá»§a tá»«ng confounders trong má»—i nhÃ³m Ä‘iá»u trá»‹. Ta sáº½ Ä‘á» cáº­p Ä‘áº¿n váº¥n Ä‘á» nÃ y sÃ¢u hÆ¡n á»Ÿ cÃ¡c pháº§n sau. 

# VÃ­ dá»¥ minh há»a 

CÃ³ 2 `R` packages Ä‘Æ°á»£c sá»­ dá»¥ng khÃ¡ phá»• biáº¿n hiá»‡n nay Ä‘Ã³ Ä‘Ã³ `MatchIt` vÃ  `WeightIt`. Trong Ä‘Ã³ `MacthIt` cung cáº¥p nhá»¯ng phÆ°Æ¡ng phÃ¡p matching khÃ³ cá»• Ä‘iá»ƒn Ä‘Ã£ Ä‘Æ°á»£c Ä‘á» cáº·p nhÆ° _exact_, _subclassification_, _nearest_, v.v... tÃ i liá»‡u tham kháº£o cÃ³ thá»ƒ tÃ¬m tháº¥y báº±ng link nÃ y [MatchIt](https://cran.r-project.org/web/packages/MatchIt/MatchIt.pdf), vÃ  vÃ­ dá»¥ minh hoáº¡ cÃ³ thá»ƒ tÃ¬m tháº¥y á»Ÿ Ä‘Ã¢y [VÃ­ dá»¥ minh hoáº¡ cho MatchIt](https://sejdemyr.github.io/r-tutorials/statistics/tutorial8.html). 

package `WeightIt` offers nhiá»u phÆ°Æ¡ng phÃ¡p má»›i hÆ¡n, trong Ä‘Ã³ pháº§n Æ°á»›c lÆ°á»£ng PS cÃ³ thá»ƒ thá»±c hiá»‡n báº±ng nhiá»u phÆ°Æ¡ng phÃ¡p trong machine learning. Trong khi `MatchIt` khÃ´ng cung cáº¥p phÆ°Æ¡ng phÃ¡p weighting, thÃ¬ `WeightIt` cung cáº¥p khÃ¡ Ä‘áº§y Ä‘á»§ cÃ¡c hÃ m Ä‘á»ƒ thá»±c hiá»‡n  phÆ°Æ¡ng phÃ¡p weighting. Báº¡n Ä‘á»c cÃ³ thá»ƒ tÃ¬m hiá»ƒu táº¡i Ä‘Ã¢y [WeightIt](https://cran.r-project.org/web/packages/WeightIt/WeightIt.pdf), vÃ­ dá»¥ minh hoáº¡ táº¡i Ä‘Ã¢y [VÃ­ dá»¥ minh hoáº¡ cho WeightIt](https://cran.r-project.org/web/packages/WeightIt/vignettes/WeightIt.html). 

Trong pháº§n sau ta sáº½ Ä‘i tÃ¬m hiá»ƒu ká»¹ hÆ¡n vá» package `WeightIt` cÅ©ng nhÆ° má»™t sá»‘ phÆ°Æ¡ng phÃ¡p thuá»™c nhÃ³m weighting báº±ng propensity score. Trong packages nÃ y, nhiá»u phÆ°Æ¡ng phÃ¡p weighting mang tÃ­nh cháº¥t khÃ¡i quÃ¡t Ä‘Æ°á»£c Ä‘á» cáº­p, vÃ¬ tháº¿ Ä‘á»ƒ sá»­ dá»¥ng ta cáº§n hiá»ƒu má»™t vÃ i khÃ¡i niá»‡m cÄƒn báº£n dá»±a trÃªn @li2017.

<!-- ################################################################################################### -->
<!-- :::: {.blackbox data-latex=""} -->
<!-- ::: {.center data-latex=""} -->
<!-- **Proof:** -->
<!-- ::: -->
<!-- over here -->
<!-- :::: -->
# ğŸ“ _**References**_ {-}