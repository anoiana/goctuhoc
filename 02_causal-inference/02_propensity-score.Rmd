---
title: "&#128205;Propensity Score I"
subtitle: "&#128205;T·ªïng Quan v·ªÅ Propensity Score v√† Ph∆∞∆°ng Ph√°p Weighting"
author: üë¶ $\mathcal{An}$
date: "&#x1F4C5; _`r {
if(!file.exists('date_list.rds')){saveRDS(list(), file = 'date_list.rds')}
update=FALSE
filename=knitr::current_input(dir = FALSE)
mylist <- readRDS(file ='date_list.rds')
if(update|!(filename%in%names(mylist))){
mylist[[filename]]<- format(Sys.Date(),format = '%d-%m-%Y')
saveRDS(mylist, file = 'date_list.rds')}
readRDS(file ='date_list.rds')[[filename]]  }`_"
abstract: |
  Propensity score l√† ph∆∞∆°ng ph√°p ƒë∆∞·ª£c s·ª≠ d·ª•ng nhi·ªÅu trong c√°c nghi√™n c·ª©u ƒë√°nh gi√° ·∫£nh h∆∞·ªüng c·ªßa s·∫£n ph·∫ßm (hay ph∆∞∆°ng ph√°p ƒëi·ªÅu tr·ªã ho·∫∑c can thi·ªáp trong clinical trials). N√≥ cho ph√©p ta ƒëi·ªÅu ch·ªânh ƒë·ªô nhi·ªÖu g√¢y ra b·ªüi c√°c bi·∫øn ƒëi·ªÅu ki·ªán tr∆∞·ªõc can thi·ªáp khi ta ƒë√°nh gi√° hi·ªáu qu·∫£ c·ªßa c√°c can thi·ªáp. Propensity score ƒë∆∞·ª£c gi·∫£i th√≠ch l√† x√°c su·∫•t m√† m·ªôt b·ªánh nh√¢n ƒë∆∞·ª£c x·∫øp v√†o nh√≥m treatment (nh√≥m c√≤n l·∫°i l√† control) d∆∞·ªõi m·ªôt ƒëi·ªÅu ki·ªán n√†o ƒë√≥ (tu·ªïi, gi·ªõi t√≠nh, chi·ªÅu cao,...). Nh·ªØng ƒëi·ªÅu ki·ªán n√†y g·ªçi l√† ƒëi·ªÅu ki·ªán tr∆∞·ªõc can thi·ªáp (pretreatments). D∆∞·ªõi m·ªôt t·∫≠p propensity score cho t·ª´ng b·ªánh nh√¢n, ·∫£nh h∆∞·ªüng c·ªßa c√°c can thi·ªáp l√™n b·ªánh nh√¢n s·∫Ω ƒë∆∞·ª£c so s√°nh m·ªôt c√°ch ch√≠nh x√°c h∆°n. Trong ph·∫ßn n√†y ta s·∫Ω l·∫ßn l∆∞·ª£t l√†m quen v·ªõi c√°c ph∆∞∆°ng ph√°p t√¨m propensity score cho m·ªôt observational data. 
output: 
    bookdown::html_document2:
      fig_caption: yes
      theme: default
      highlight: tango
      toc: true
      toc_float: 
        collapsed: false
      toc_depth: 3
      code_folding: hide
      css: "../00_supp/style.css"
      number_sections: true
      includes:
        in_header: "../00_supp/header.html"
        before_body: "test.html"
        after_body: "../00_supp/mycomment.html"
fontsize: 12pt
bibliography: ["citation.bib"]
csl: "../00_supp/apa.csl"
link-citations: true
editor_options: 
  chunk_output_type: console
---


```{css, echo = F}
/*----------LOGO above TOC---------*/

#TOC::before {
  content: "";
  display: block;
  height: 200px;
  margin: 2.75em 20px 40px 20px;
  background-image: url("casual.jpg");
  background-size: contain;
  background-position: center center;
  background-repeat: no-repeat;
}
```

```{r child="../00_supp/general_rmd.Rmd"}
```

# Gi·ªõi thi·ªáu  

N√≥i ƒë·∫øn suy lu·∫≠n nh√¢n qu·∫£, hi·ªán t·∫°i c√≥ ba tr∆∞·ªùng ph√°i l√† 

1. Tr∆∞·ªùng ph√°i c·ªßa Rubin, s·ª≠ d·ª•ng l√Ω thuy·∫øt counterfactual.
2. Tr∆∞·ªùng ph√°i Pearl, ph√°t tri·ªÉn t·ª´ l√Ω thuy·∫øt c·ªßa graphical models.
3. Tr∆∞·ªùng ph√°i c·ªßa Dawid, d·ª±a tr√™n thuy·∫øt quy·∫øt ƒë·ªãnh (decision theory). 

Trong n·ªôi dung b√†i n√†y ta s·∫Ω ti·∫øp c·∫≠n v·∫•n ƒë·ªÅ theo tr∆∞·ªùng ph√°i c·ªßa Rubin.

Tr∆∞·ªõc ti√™n ta h√£y nh·∫Øc l·∫°i c√°c k√Ω hi·ªáu s·∫Ω ƒë∆∞·ª£c s·ª≠ d·ª•ng trong b√†i nh∆∞ sau 

- potential outcomes: $Y_i(0)$ v√† $Y_i(1)$ ch√≠nh l√† k·∫øt qu·∫£ c·ªßa b·ªánh nh√¢n $i$ l·∫ßn l∆∞·ª£t thu·ªôc nh√≥m control v√† treatment.
- observed outcomes: $Y_{i|1}$ v√† $Y_{i|0}$ ho·∫∑c $Y_i|T=1$ v√† $Y_i|T=0$ l√† k·∫øt qu·∫£ quan s√°t ƒë∆∞·ª£c c·ªßa b·ªánh nh√¢n $i$ thu·ªôc nh√≥m treatment HO·∫∂C control. L∆∞u √Ω v·ªõi m·ªói m·ªôt b·ªánh nh√¢n ta ch·ªâ c√≥ th·ªÉ quan s√°t ƒë∆∞·ª£c m·ªôt trong hai gi√° tr·ªã. 
- nh√≥m ƒëi·ªÅu tr·ªã: $T=0$ v√† $T=1$ ƒë·∫°i di·ªán cho hai nh√≥m ƒëi·ªÅu tr·ªã control v√† treatment
- pre-treatments, confounders, baseline characteristics: ƒë∆∞·ª£c k√Ω hi·ªáu $\bf{X}_i$, $\bf{X}$ ƒë∆∞·ª£c in ƒë·∫≠m ƒë·∫°i di·ªán cho m·ªôt vector thay v√¨ m·ªôt scalar, v√¨ m·ªói m·ªôt b·ªánh nh√¢n s·∫Ω c√≥ nhi·ªÅu bi·∫øn confounders nh∆∞ tu·ªïi, gi·ªõi t√≠nh, d√¢n t·ªôc,...

Nh∆∞ ƒë√£ gi·∫£i th√≠ch ·ªü ph·∫ßn tr∆∞·ªõc, ·∫£nh h∆∞·ªüng c·ªßa c√°c can thi·ªáp th∆∞·ªùng b·ªã nhi·ªÖu b·ªüi c√°c ƒëi·ªÅu ki·ªán tr∆∞·ªõc can thi·ªáp, nhi·ªÖu l√† nguy√™n nh√¢n ch√≠nh ngƒÉn c·∫£n s·ª± ƒë√°nh gi√° v·ªÅ hi·ªáu qu·∫£ c·ªßa can thi·ªáp ƒë√≥. N√≥i c√°ch kh√°c n·∫øu ta nh√¨n v√†o 2 nh√≥m treatment v√† control th√¨ s·ª± ph√¢n b·ªë c·ªßa c√°c confounders nh∆∞ tu·ªïi, gi·ªõi t√≠nh, chi·ªÅu cao, c√¢n n·∫∑ng c·ªßa c√°c b·ªánh nh√¢n s·∫Ω kh√¥ng ƒë·ªÅu nhau. ƒêi·ªÅu n√†y x·∫£y ra ·ªü t·∫•t c·∫£ c√°c nghi√™n c·ª©u s·ª≠ d·ª•ng observational data (kh√°c v·ªõi randomized controlled trial), b·ªüi v√¨ ƒëa s·ªë ta d·ª±a tr√™n c√°c ƒëi·ªÅu ki·ªán nh∆∞ tu·ªïi, gi·ªõi t√≠nh, chi·ªÅu cao... ƒë·ªÉ x·∫øp b·ªánh nh√¢n v√†o m·ªôt trong hai nh√≥m treatment hay control. Gi·∫£ s·ª≠ ta mu·ªën ƒë√°nh gi√° hi·ªáu qu·∫£ ƒëi·ªÅu tr·ªã c·ªßa m·ªôt lo·∫°i thu·ªëc m·ªõi, ta s·∫Ω ti·∫øn h√†nh th√≠ nghi·ªám b·∫±ng c√°ch cho m·ªôt s·ªë ng∆∞·ªùi s·ª≠ d·ª•ng lo·∫°i thu·ªëc m·ªõi trong khi nh·ªØng ng∆∞·ªùi c√≤n l·∫°i s·∫Ω ƒë∆∞·ª£c s·ª≠ d·ª•ng gi·∫£ d∆∞·ª£c (placebo). Trong ƒëi·ªÅu ki·ªán l√Ω t∆∞·ªüng, kh√¥ng nhi·ªÖu, t·ª©c l√† 2 nh√≥m ƒëi·ªÅu tr·ªã n√†y c√≥ c√°c ƒëi·ªÅu ki·ªán tr∆∞·ªõc khi tham gia v√†o nghi√™n c·ª©u l√† t∆∞∆°ng t·ª± nhau, ta c√≥ th·ªÉ d·ªÖ d√†ng so s√°nh k·∫øt qu·∫£ c·ªßa 2 nh√≥m b·ªánh nh√¢n n√†y (x·∫£y ra khi c√≥ s·ª± hi·ªán di·ªán c·ªßa randomization). Tuy nhi√™n, k·∫øt lu·∫≠n s·∫Ω b·ªã l·ªách n·∫øu nh∆∞ hai nh√≥m b·ªánh nh√¢n n√†y c√≥ s·ª± ph√¢n b·ªë c·ªßa c√°c confouders kh√¥ng ƒë·ªìng ƒë·ªÅu. N√≥i c√°ch kh√°c l√† ƒëi·ªÅu ki·ªán ban ƒë·∫ßu c·ªßa 2 nh√≥m n√†y kh√°c nhau. 
V√≠ d·ª• d·ªÖ th·∫•y l√† trong s·ªë nh·ªØng b·ªánh nh√¢n thu·ªôc nh√≥m treatment c√≥ t·ªâ l·ªá tr√™n 50 tu·ªïi l√† 80% trong khi nh·ªØng ng∆∞·ªùi thu·ªôc nh√≥m c√≤n l·∫°i th√¨ c√≥ ƒë·∫øn 80% s·ªë b·ªánh nh√¢n d∆∞·ªõi 30 tu·ªïi. Nh∆∞ v·∫≠y n·∫øu nh∆∞ k·∫øt qu·∫£ ph√¢n t√≠ch cu·ªëi c√πng cho th·∫•y treatment kh√¥ng hi·ªáu qu·∫£ khi so s√°nh v·ªõi control. V·∫≠y ta ph·∫£i ƒë·∫∑c c√¢u h·ªèi l√† _"li·ªáu nh√≥m b·ªánh nh√¢n thu·ªôc nh√≥m control ƒë·∫°t k·∫øt qu·∫£ t·ªët h∆°n b·ªánh nh√¢n thu·ªôc nh√≥m treatment l√† do treatment kh√¥ng hi·ªáu qu·∫£ b·∫±ng control hay do kh·∫£ nƒÉng ph·ª•c h·ªìi c·ªßa nh·ªØng b·ªánh nh√¢n tr√™n 50 th·∫•p h∆°n nh·ªØng b·ªánh nh√¢n d∆∞·ªõi 30 tu·ªïi?"_ ho√†n to√†n c√≥ kh·∫£ nƒÉng l√† treatment th·∫≠t s·ª± hi·ªáu qu·∫£ nh∆∞ng v√¨ ƒë·ªô tu·ªïi ƒë√£ ·∫£nh h∆∞·ªüng v√† l√†m l·ªách ƒëi k·∫øt qu·∫£ ƒë√∫ng. Nh∆∞ v·∫≠y solution cho v·∫•n ƒë·ªÅ n√†y l√† ta c·∫ßn ph·∫£i c√¢n b·∫±ng l·∫°i t·ªâ l·ªá tu·ªïi c·ªßa 2 nh√≥m ƒëi·ªÅu tr·ªã. Nghƒ©a l√† t·ªâ l·ªá s·ªë tu·ªïi c·ªßa b·ªánh nh√¢n tr√™n 50 v√† d∆∞·ªõi 30 c·ªßa 2 nh√≥m ph·∫£i x·∫•p x·ªâ nhau. 

N·∫øu ta gi·∫£ s·ª≠ r·∫±ng m·ªói m·ªôt b·ªánh nh√¢n ƒë·ªÅu c√≥ 2 k·∫øt qu·∫£ song song t∆∞∆°ng ·ª©ng v·ªõi t·ª´ng can thi·ªáp. trong ƒëi·ªÅu ki·ªán n√†y th√¨ c√°c bi·∫øn tr∆∞·ªõc ƒëi·ªÅu tr·ªã kh√¥ng ·∫£nh h∆∞·ªüng v√¨ c·∫£ 2 nh√≥m treatment v√† control ƒë·ªÅu c√≥ c√°c ƒëi·ªÅu ki·ªán ban ƒë·∫ßu nh∆∞ nhau (m·ªói b·ªánh nh√¢n ƒë·ªÅu cho 2 k·∫øt qu·∫£ t∆∞∆°ng ·ª©ng v·ªõi 2 ph∆∞∆°ng ph√°p ƒëi·ªÅu tr·ªã). Tuy nhi√™n, trong th·ª±c t·∫ø, ƒëi·ªÅu n√†y ho√†n to√†n kh√¥n th·ªÉ x·∫£y ra b·ªüi v√¨ m·ªói b·ªánh nh√¢n ch·ªâ ƒë∆∞·ª£c d√πng ƒë√∫ng 1 lo·∫°i thu·ªëc v√† cho duy nh·∫•t m·ªôt k·∫øt qu·∫£ t∆∞∆°ng ·ª©ng v·ªõi lo·∫°i thu·ªëc ƒë√≥. 

Ta l·∫•y $Y_i(T)$ l√† k√Ω hi·ªáu c·ªßa k·∫øt qu·∫£ ƒëi·ªÅu tr·ªã sau khi s·ª≠ d·ª•ng ph∆∞∆°ng ph√°p ƒëi·ªÅu tr·ªã $T$, trong ƒë√≥ $T = 1$ l√† treatment v√† $T = 0$ l√† control. Trong th·ª±c t·∫ø ta ch·ªâ c√≥ th·ªÉ quan s√°t ƒë∆∞·ª£c m·ªôt trong hai gi√° tr·ªã $Y(1)$ HO·∫∂C l√† $Y(0)$, t√πy v√†o b·ªánh nh√¢n ƒë√≥ thu·ªôc nh√≥m n√†o. Nh∆∞ v·∫≠y, so s√°nh hi·ªáu qu·∫£ c·ªßa hai lo·∫°i can thi·ªáp n√†y s·∫Ω kh√¥ng th·ª±c hi·ªán ƒë∆∞·ª£c b·∫±ng c√°c ph∆∞∆°ng ph√°p th·ªëng k√™ th√¥ng th∆∞·ªùng. 

Nh·∫Øc l·∫°i r·∫±ng ƒë·∫°i l∆∞·ª£ng ƒë·ªÉ ƒë√°nh gi√° hi·ªáu qu·∫£ l√† $\E[Y(1) - Y(0)]$, ch√≠nh l√† expectation (k·ª≥ v·ªçng) c·ªßa  hai potential outcomes t∆∞∆°ng ·ª©ng hai nh√≥m ƒëi·ªÅu tr·ªã. N·∫øu nh∆∞ c√°c b·ªánh nh√¢n tham gia v√†o nghi√™n c·ª©u ƒë∆∞·ª£c _**ng·∫´u nhi√™n**_ ph√¢n v√†o m·ªôt trong hai nh√≥m ƒëi·ªÅu tr·ªã, th√¨ ta c√≥

$$
\E[Y_i(t)] = \E[Y_i|T=t],~~~~1\le i\le n.
(\#eq:1)
$$

ƒê·ªÉ ch·ª©ng minh `r lb(eq,'1')`, ta h√£y xem y·∫øu t·ªë randomization ƒë∆∞·ª£c th·ª±c hi·ªán th√¥ng qua ch·ªçn l·ª±a b·ªánh nh√¢n v√†o m·ªôt trong hai nh√≥m ƒëi·ªÅu tr·ªã b·∫±ng c√°ch tung m·ªôt ƒë·ªìng xu. N·∫øu nh∆∞ ƒë·ªìng xu cho ra m·∫∑t h√¨nh th√¨ b·ªánh nh√¢n v√†o nh√≥m treatment $(T=1)$, ng∆∞·ª£c l·∫°i s·∫Ω v√†o nh√≥m control $(T=0)$ _(scenario 1)_. C√¢u h·ªèi ƒë·∫∑c ra l√† n·∫øu ta l√†m ng∆∞·ª£c l·∫°i, nghƒ©a l√† n·∫øu ƒë·ªìng xu m·∫∑t h√¨nh ta s·∫Ω cho b·ªánh nh√¢n v√†o nh√≥m control $(T=0)$ ng∆∞·ª£c l·∫°i l√† nh√≥m treatment $(T=1)$ _(scenario 2)_, th√¨ k·∫øt qu·∫£ c√≥ thay ƒë·ªïi hay kh√¥ng?! c√¢u tr·∫£ l·ªùi l√† kh√¥ng, b·ªüi v√¨ ta lu√¥n c√≥ 

$$
\cases{
\E[Y(1)|T=1] = \E[Y(1)|T=0] = \E[Y(1)],  \\
\E[Y(0)|T=1] = \E[Y(0)|T=0] = \E[Y(0)].}
(\#eq:eq1)
$$
c√≥ nghƒ©a l√† $Y(1),Y(0)$ ƒë·ªôc l·∫≠p v·ªõi $T$, v√† `r lb(eq1)` ƒë∆∞·ª£c g·ªçi l√† _exchangeability_. 


:::: {.blackbox .brainstorm}
::: {.center }
`r colorize('_Ta c√≥ th·ªÉ nghƒ© r·∫±ng potential outcome Y(1) v√† Y(0) ƒë√£ c√≥ t·ª´ tr∆∞·ªõc khi can thi·ªáp, qu√° tr√¨nh can thi·ªáp ch·ªâ ƒë·ªÉ x√°c ƒë·ªãnh potential outcome n√†o c·ªßa m·ªói b·ªánh nh√¢n s·∫Ω tr·ªü th√†nh observed outcome. V√¨ qu√° tr√¨nh can thi·ªáp di·ªÖn ra ng·∫´u nhi√™n m√† kh√¥ng ph·ª• thu·ªôc l√™n b·∫•t k·ª≥ m·ªôt confounders hay potential outcomes n√†o, n√™n $T \\indep Y(0), Y(1))$_.',color = "grey")`
:::
Tuy nhi√™n, ƒë·ªÉ gi·∫£i th√≠ch ch√≠nh x√°c v·ªÅ √Ω nghƒ©a c·ªßa _randomization (qu√° tr√¨nh ng·∫´u nhi√™n)_, th√¨ ta s·∫Ω m∆∞·ª£n v√≠ d·ª• c·ªßa @ros2010 nh∆∞ sau

v√≠ d·ª• ta c√≥ 5 b·ªánh nh√¢n, m·ªói b·ªánh nh√¢n  s·∫Ω c√≥ 2 potential outcomes, k√Ω hi·ªáu l√† $$\{Y_i(t):t=0 \lor t=1, i=1,\dots,n\},$$ t∆∞∆°ng ·ª©ng v·ªõi 2 nh√≥m treatments l√† active v√† control. Nh∆∞ v·∫≠y x·∫øp _ng·∫´u nhi√™n_ b·ªánh nh√¢n v√†o 1 trong 2 nh√≥m ƒëi·ªÅu tr·ªã t·ª©c l√† $T  = \{t_i:i = 1,\dots,5\}$ s·∫Ω ƒë∆∞·ª£c ch·ªçn ng·∫´u nhi√™n, m·ªói l·∫ßn ch·ªçn v·ªõi x√°c su·∫•t l√† $\frac{1}{2^5} = 0.03125$. X√°c su·∫•t ƒë∆∞·ª£c t√≠nh b·∫±ng c√°ch sau: c√≥ t·∫•t c·∫£ $5$ $T$'s m·ªói $T$ c√≥ 2 gi√° tr·ªã ƒë·ªÉ ch·ªçn l√† $0$ v√† $1$, n√™n c√≥ t·∫•t c·∫£ l√† $2^5 = 32$ c√°ch. L∆∞u √Ω khi ch·ªçn m·ªôt gi√° tr·ªã cho $T$ nghƒ©a l√† ta s·∫Ω ch·ªçn ng·∫´u nhi√™n c√πng l√∫c $5$ $t$'s. V√≠ d·ª• ta c√≥ th·ªÉ n√©m c√πng l√∫c 5 ƒë·ªìng xu ƒë·ªÉ t√¨m gi√° tr·ªã $T$. N√≥i m·ªôt c√°ch ƒë∆°n gi·∫£n th√¨ ta d√πng ƒë·ªìng xu ƒë·ªÉ thi·∫øt l·∫≠p ph√¢n b·ªë c·ªßa bi·∫øn ng·∫´u nhi√™n $T$. Th·∫≠t ra ƒëi·ªÅu n√†y ch∆∞a th·∫≠t s·ª± ƒë√∫ng. qu√° tr√¨nh ng·∫´u nhi√™n ph·∫£i ƒë∆∞·ª£c xem x√©t t·ª´ kh√≠a c·∫°nh ƒë·ªôc l·∫≠p c·ªßa c√°c th√¥ng tin li√™n quan. Nghƒ©a l√† th√¥ng tin $Y(T)$ hay $X$ mang l·∫°i v√¥ hi·ªáu ƒë·ªÉ d·ª± ƒëo√°n $T$, hay ng∆∞·ª£c l·∫°i. Nghƒ©a l√† ƒë·ªìng xu ƒë∆∞·ª£c s·ª≠ d·ª•ng kh√¥ng th·ªÉ nh·∫≠n di·ªán ƒë∆∞·ª£c c√°c th√¥ng tin kh√°c, ngay c·∫£ khi c√°c ƒë·∫∑c t√≠nh c·ªßa t·ª´ng b·ªánh nh√¢n nh∆∞ gi·ªõi t√≠nh, tu·ªïi t√°c, chi·ªÅu cao... c√≥ th·ªÉ x√°c ƒë·ªãnh, th·∫≠m ch√≠ ta bi·∫øt ƒë∆∞·ª£c k·∫øt qu·∫£ c·ªßa t·ª´ng b·ªánh nh√¢n, th√¨ ƒë·ªìng xu v·∫´n kh√¥ng th·ªÉ s·ª≠ d·ª•ng ngu·ªìn th√¥ng tin ƒë√≥, m√† n√≥ ch·ªâ l√†m m·ªôt vi·ªác ƒë∆°n gi·∫£n l√† "v√¥ t∆∞" x·∫øp 5 b·ªánh nh√¢n v√†o m·ªôt trong hai nh√≥m ƒëi·ªÅu tr·ªã. V√¨ th·∫ø ta c√≥ th·ªÉ vi·∫øt l√† 

$$
\P[T|Y(0),Y(1)] = \frac{1}{2^n}, ~~~\color{grey}{\text{(n·∫øu ƒë·ªìng xu ƒë·ªìng ch·∫•t)}} 
$$
v·ªõi $n$ l√† s·ªë b·ªánh nh√¢n tham gia nghi√™n c·ª©u. Nghƒ©a l√† d∆∞·ªõi ƒëi·ªÅu ki·ªán th√¥ng tin ƒë∆∞·ª£c cho tr∆∞·ªõc, $Y(0)$ v√† $Y(1)$, th√¨ t·∫•t c·∫£ $2^n$ l·ª±a ch·ªçn s·∫Ω c√≥ x√°c su·∫•t b·∫±ng nhau, t·ª©c l√† ta kh√¥ng s·ª≠ d·ª•ng th√¥ng tin t·ª´ $\big[Y(0),Y(1)\big]$ hay $X$ ƒë·ªÉ d·ª± ƒëo√°n $T$. Ch√∫ng ta c√≥ th·ªÉ vi·∫øt c√¥ng th·ª©c tr√™n ·ªü d·∫°ng t·ªïng qu√°t h∆°n khi ƒë·ªìng xu kh√¥ng ƒë·ªìng ch·∫•t, nghƒ©a l√† $p\ne 1/2$. Ta c√≥ 

$$
\P[T|Y(0),Y(1)] = p^{n_t}(1-p)^{n_c}
(\#eq:eq1001)
$$
trong ƒë√≥ $n_t+n_c=n$. `r lb(eq1001)` ƒë∆∞·ª£c g·ªçi l√† _Bernoulli trials_.

Nh√¨n v√†o c√¥ng th·ª©c tr√™n ta th·∫•y r·∫±ng x√°c su·∫•t c·ªßa $T$ ch·ªâ ph·ª• thu·ªôc v√†o s·ªë l∆∞·ª£ng b·ªánh nh√¢n trong 2 nh√≥m ƒëi·ªÅu tr·ªã ƒë√£ ƒë∆∞·ª£c x√°c ƒë·ªãnh tr∆∞·ªõc ƒë√≥ v√† ho√†n to√†n ƒë·ªôc l·∫≠p v·ªõi $Y(t)$ v·ªõi $t \in\{0,1\}$. Ta n√≥i r·∫±ng $T \indep Y(0),Y(1)$. B√¢y gi·ªù ta h√£y h√¨nh dung c√≥ 2 b·ªánh nh√¢n trong ƒë√≥ b·ªánh nh√¢n s·ªë 1 thu·ªôc kh√¥ng gian $head~(H)$, k·∫øt qu·∫£ ƒë∆∞·ª£c k√Ω hi·ªáu l√† $Y_H$ b·ªánh nh√¢n s·ªë 2 thu·ªôc kh√¥ng gian $tail~(T)$, k√Ω hi·ªáu l√† $Y_T$, c·∫£ hai kh√¥ng gian n√†y ƒë·ªÅu l√† kh√¥ng gian c·ªßa interventional t·ª©c l√† kh√¥ng gian ƒë∆∞·ª£c can thi·ªáp n√™n m·ªói kh√¥ng gian ch·ªâ ch·ª©a duy nh·∫•t m·ªôt thu·ªôc t√≠nh $T$ hay thu·ªôc t√≠nh $H$. Nh∆∞ v·∫≠y ƒë·∫∑c t√≠nh exchangeability s·∫Ω b·∫£o ƒë·∫£m r·∫±ng c·∫£ 2 b·ªánh nh√¢n thu·ªôc hai kh√¥ng gian n√†y ƒë·ªÅu c√≥ k·ª≥ v·ªçng $\E[Y|T=t]$ nh∆∞ nhau nghƒ©a l√† 
$$
\cases{
\E[Y_H|T=1] = \E[Y_T|T=1], \\ \E[Y_H|T=0] = \E[Y_T|T=0].}
$$
Quay l·∫°i v√≠ d·ª• v·ªÅ ƒë·ªìng xu, ta c√≥ th·ªÉ n√≥i r·∫±ng 

:::{.col-darkred}
> __ƒê·∫∑c t√≠nh exchangeability ƒë√£ b·∫£o ƒë·∫£m r·∫±ng d√π ƒë·ªìng xu t∆∞∆°ng ·ª©ng v·ªõi m·ªôt b·ªánh nh√¢n n√†o ƒë√≥ l√† _H_ hay _T_ th√¨ k·∫øt qu·∫£ k·ª≥ v·ªçng c·ªßa b·ªán nh√¢n ƒë√≥ `r colorize('_n·∫øu ƒë∆∞·ª£c ƒëi·ªÅu tr·ªã (n·∫øu kh√¥ng ƒë∆∞·ª£c ƒëi·ªÅu tr·ªã)_', color = 'darkred')` s·∫Ω kh√¥ng ƒë·ªïi, b·∫±ng k√Ω hi·ªáu c·ªßa x√°c su·∫•t ta c√≥ th·ªÉ tr√¨nh b√†y nh∆∞ trong `r lb(eq1)`.__ 
:::

ƒêi·ªÅu n√†y c≈©ng d·ªÖ hi·ªÉu v√¨ n·∫øu nh∆∞ m·ªôt b·ªánh nh√¢n n√†o ƒë√≥ m√† c√≥ bi·ªÉu hi·ªán kh√¥ng ƒë·ªìng nh·∫•t v·ªõi c√°c b·ªánh nh√¢n kh√°c th√¨ ta c√≥ th·ªÉ suy lu·∫≠n r·∫±ng ƒë√£ c√≥ m·ªôt ƒë·∫∑c t√≠nh n√†o ƒë√≥ ·∫£nh h∆∞·ªùng l√™n k·∫øt qu·∫£ m√† ta ƒë√£ b·ªè qua. 

X√©t m·ªôt v√≠ d·ª• kh√°c nh∆∞ sau, $A$ l√† m·ªôt ph∆∞∆°ng ph√°p ƒëi·ªÅu tr·ªã c√≥ hi·ªáu qu·∫£ v·ªõi b·ªánh $D$, nghƒ©a l√† $Y(A) =1$ v√† $Y(A^C) =0$ nh∆∞ v·∫≠y k·∫øt qu·∫£ ta mong mu·ªën ƒë√≥ l√† n·∫øu b·ªánh nh√¢n s·ªë 1 thu·ªôc nh√≥m ƒëi·ªÅu tr·ªã th√¨ b·ªánh nh√¢n 1 s·∫Ω cho k·∫øt qu·∫£ ph·ª•c h·ªìi $Y_1(A)=1$, c√≤n b·ªánh nh√¢n s·ªë 2 thu·ªôc nh√≥m kh√¥ng ƒëi·ªÅu tr·ªã s·∫Ω cho k·∫øt qu·∫£ kh√¥ng ph·ª•c h·ªìi $Y_2(A^C)=0$, ta c√≥ 
$$
Y_1(A) - Y_2(A^C) = 1.
$$
·ªû tr∆∞·ªùng h·ª£p ng∆∞·ª£c l·∫°i, n·∫øu b·ªánh nh√¢n s·ªë 1 thu·ªôc nh√≥m kh√¥ng ƒëi·ªÅu tr·ªã th√¨ k·∫øt qu·∫£ c≈©ng ph·∫£i l√† kh√¥ng ph·ª•c h·ªìi, $Y_1(A^C)=0$, v√† b·ªánh nh√¢n s·ªë 2 l·∫ßn n√†y thu·ªôc nh√≥m ƒëi·ªÅu tr·ªã ph·∫£i cho k·∫øt qu·∫£ ph·ª•c h·ªìi, $Y_2(A)=1$, ta c√≥ 
$$
Y_2(A) - Y_1(A^C) =1.
$$
N·∫øu ta thu ƒë∆∞·ª£c m·ªôt trong hai k·∫øt qu·∫£ tr√™n th√¨ ta k·∫øt lu·∫≠n thu·ªëc $A$ c√≥ hi·ªáu qu·∫£ v·ªõi b·ªánh $D$, gi·ªëng nh∆∞ nh·ªØng g√¨ ta mong ƒë·ª£i tr∆∞·ªõc ƒë√≥. Nh∆∞ng n·∫øu nh∆∞ b·ªánh nh√¢n s·ªë 1 trong tr∆∞·ªùng h·ª£p th·ª© 2 c≈©ng cho k·∫øt qu·∫£ ph·ª•c h·ªìi t·ª©c l√† $Y_1(A^C) =1$, th√¨ 
$$
Y_2(A) - Y_1(A^C) =0,
$$
K·∫øt qu·∫£ n√†y s·∫Ω ƒë∆∞a ƒë·∫øn k·∫øt lu·∫≠n r·∫±ng thu·ªëc $A$ kh√¥ng c√≥ hi·ªáu qu·∫£ v·ªõi b·ªánh $D$, v√† k·∫øt lu·∫≠n n√†y ng∆∞·ª£c l·∫°i v·ªõi k·∫øt qu·∫£ ƒë√∫ng ban ƒë·∫ßu. 
::::

Nh∆∞ v·∫≠y d·ª±a v√†o `r lb(eq1)` ta c√≥ th·ªÉ ch·ª©ng minh ƒë∆∞·ª£c `r lb(eq,'1')` nh∆∞ sau 

$$
\begin{split}
\E[Y_i(t)] &= \E[Y_i(t)|T=t] \\
&= \E[Y_i|T=t], ~~~ \small\text{(ƒë·∫∑c t√≠nh consistency)}
\end{split}
$$ 
_(tham kh·∫£o v·ªÅ consistency [t·∫°i ƒë√¢y](https://ngoitruocgioxuan.github.io/goctuhoc/02_causal-inference/01_potential-outcomes.html))._ 
`r rs("\\square")`

Nh∆∞ v·∫≠y $\E[Y|T=t]$ c≈©ng s·∫Ω kh√¥ng ƒë·ªïi khi ta tr√°o ƒë·ªïi h∆∞·ªõng ƒëi·ªÅu tr·ªã c·ªßa b·ªánh nh√¢n d·ª±a tr√™n hai m·∫∑t ƒë·ªìng xu. N√≥i m·ªôt c√°ch kh√°c, d∆∞·ªõi ƒëi·ªÅu ki·ªán c·ªßa randomization th√¨ _causation_ v√† _association_ l√† ƒë·ªìng nh·∫•t, nghƒ©a l√†  

$$
\P[Y(t)] = \P[Y|T=t].
(\#eq:eq2)
$$

ƒê·ªÉ ch·ª©ng minh `r lb(eq2)` tr∆∞·ªõc ti√™n ta ph·∫£i xem x√©t kh√°i ni·ªám g·ªçi l√† _covariate balance_, nghƒ©a l√† ph√¢n b·ªë c·ªßa c√°c bi·∫øn tr∆∞·ªõc khi can thi·ªáp c·ªßa hai nh√≥m ƒëi·ªÅu tr·ªã l√† gi·ªëng nhau. Nghƒ©a l√† 

$$
\P[X|T=1] \stackrel{d}{=} \P[X|T=0],
(\#eq:eq3)
$$
l√Ω do l√† v√¨ khi c√°c b·ªánh nh√¢n ƒë∆∞·ª£c l·ª±a ch·ªçn ng·∫´u nhi√™n v√†o m·ªôt trong hai nh√≥m ƒëi·ªÅu tr·ªã th√¨ ta kh√¥ng xem x√©t t·∫•t c·∫£ th√¥ng tin c·ªßa c√°c covariates $X$ ngo·∫°i tr·ª´ y·∫øu t·ªë can thi·ªáp $T$. V√≠ d·ª• ta d√πng m·ªôt ƒë·ªìng xu ƒë·ªÉ quy·∫øt ƒë·ªãnh nh√≥m ƒëi·ªÅu tr·ªã cho t·ª´ng b·ªánh nh√¢n th√¨ y·∫øu t·ªë duy nh·∫•t quy·∫øt ƒë·ªãnh m·ªôt b·ªánh nh√¢n $i$ n√†o ƒë√≥ ƒë∆∞·ª£c x·∫øp v√†o nh√≥m treatment hay control ch√≠nh l√† ƒë·ªìng xu ƒë√≥. D·ª±a v√†o `r lb(eq3)` ta c√≥ th·ªÉ ch·ª©ng minh ƒë∆∞·ª£c `r lb(eq2)` nh∆∞ sau 

$$
\begin{split}
\P[Y(t)] &= \P[Y(t)|T], ~~~ \textit{(Y(1) and Y(0) are independent of T)} \\
&= \sum_x\P[Y(t)|T,X]\P(X) \\
&= \sum_x\frac{\P[Y|T,X]\P(T|X)\P(x)}{\P[T|X]} ~~~\textit{(consistency)}\\
&=\sum_x \frac{\P(Y,T,X)}{\P(T)} ~~~ {(X \indep T \textit{ mentioned above})} \\
&= \sum_x\frac{\P(Y,X|T)\P(T)}{\P(T)} \\
&= \P(Y|T)
\end{split}
$$
`r rs("\\square")`

Nh∆∞ v·∫≠y, d∆∞·ªõi ƒëi·ªÅu ki·ªán randomization (ng·∫´u nhi√™n), $\E[Y_i(t)]$ c√≥ th·ªÉ ƒë∆∞·ª£c x√°c ƒë·ªãnh b·∫±ng c√°c ƒë·∫°i l∆∞·ª£ng c√≥ th·ªÉ quan s√°t c·ªßa m·ªói b·ªánh nh√¢n v√† ƒë·ªìng th·ªùi kh·∫≥ng ƒë·ªãnh t√≠nh ƒë·ªìng nh·∫•t c·ªßa causation v√† assiciation, ƒë√¢y ch√≠nh l√† ƒëi·ªÅu ki·ªán m·∫•u ch·ªët l√†m cho m·ªôt nghi√™n c·ª©u d·ª±a tr√™n randomized controlled trials (RCTs) tr·ªü th√†nh ch·ªçn l·ª±a ti√™u chu·∫©n ƒë·ªÉ ti·∫øn h√†nh th√≠ nghi·ªám. 

Tuy nhi√™n, hi·ªán nay ƒëi·ªÅu ki·ªán ti√™u chu·∫©n n√†y tr·ªü n√™n c·ª±c k·ª≥ khan hi·∫øm trong nh·ªØng nghi√™n c·ª©u v·ªÅ thu·ªëc, b·ªüi v√¨ ƒë·ªÉ c√≥ ƒë∆∞·ª£c m·ªôt data ƒë·∫°t ti√™u chu·∫©n nh∆∞ th·∫ø, ƒë√≤i h·ªèi r·∫•t nhi·ªÅu th·ªùi gian v√† t√†i ch√≠nh c≈©ng nh∆∞ c√°c v·∫•n ƒë·ªÅ v·ªÅ ƒë·∫°o ƒë·ª©c. Trong tr∆∞·ªùng h·ª£p kh√¥ng ƒë·∫°t ƒë∆∞·ª£c ƒëi·ªÅu ki·ªán ti√™u chu·∫©n nh∆∞ tr√™n, ta c·∫ßn ph·∫£i xem x√©t t·ªõi c√°c v·∫•n ƒë·ªÉ g√¢y nhi·ªÖu, v√† m·ªôt trong nh·ªØng ph∆∞∆°ng ph√°p ƒë√≥ l√† s·ª≠ d·ª•ng propensity scores, m·ªôt trong nh·ªØng c√¥ng c·ª• ƒë∆∞·ª£c d√πng ph·ªï bi·∫øn ƒë·ªÉ m·ª•c ti√™u n√†y. 

# ƒê·ªãnh nghƒ©a

S·ª≠ d·ª•ng c√πng m·ªôt k√Ω hi·ªáu nh∆∞ b√†i tr∆∞·ªõc, ta c√≥ $X$ ƒë·∫°i di·ªán cho ƒëi·ªÅu ki·ªán c·ªßa b·ªánh nh√¢n tr∆∞·ªõc khi can thi·ªáp (confounders), v√≠ d·ª• nh∆∞ tu·ªïi, gi·ªõi t√≠nh, d√¢n t·ªôc v.v... $T$ l√† ph∆∞∆°ng ph√°p ƒëi·ªÅu tr·ªã (treatments), th√¥ng th∆∞·ªùng th√¨ ch√∫ng ta ch·ªâ xem x√©t $T = \{0,1\}$. Ti·∫øp theo $Y$ ƒë·∫°i di·ªán cho k·∫øt qu·∫£ c·ªßa b·ªánh nh√¢n sau khi ƒë√£ can thi·ªáp. Ch√∫ng ta c≈©ng c·∫ßn nh·∫Øc l·∫°i s·ª± kh√°c nhau gi·ªØa $Y|T=t$ v√† $Y(t)$, trong khi c√°i ƒë·∫ßu ti√™n ch√≠nh l√† c√°i ta quan s√°t ƒë∆∞·ª£c, t·ª©c l√† th·ª±c ch·ª©ng (factual) th√¨ c√°i sau ch√≠nh l√† potential outcomes, v√† ta ch·ªâ c√≥ th·ªÉ quan s√°t ƒë∆∞·ª£c ho·∫∑c l√† $Y(0)$ ho·∫∑c l√† $Y(1)$. c√°i quan s√°t ƒë∆∞·ª£c l√† factual th√¨ c√°i kh√¥ng quan s√°t ƒë∆∞·ª£c ch√≠nh l√† counterfactual. 

D·ª±a tr√™n quy ∆∞·ªõc _unconfoundedness_ ta c√≥ 

$$
(Y_i(1),Y_i(0)) \indep T_i|\bf{X}_i
(\#eq:2)
$$
l∆∞u √Ω $\bf{X}_i = (X_{i1}, X_{i2},\dots,X_{ip})^{\top}$ ƒë·∫°i di·ªán cho c√°c ƒëi·ªÅu ki·ªán c·ªßa b·ªánh nh√¢n $i$, v√≠ d·ª• nh∆∞ $\bf{X}_i = (\text{tu·ªïi, gi·ªõi t√≠nh,d√¢n t·ªôc})^{\top}$, n·∫øu $p=3$. Nh∆∞ v·∫≠y ta c√≥ 

$$
\begin{split}
\E[Y_i(1)-Y_i(0)|\bf{X}_i] &= \E[Y_i(1)-Y_i(0)|T_i,\bf{X}_i] \\
&= \E[Y_i|T_i=1,\bf{X}_i] - \E[Y_i|T_i=0,\bf{X}_i] 
\end{split}
(\#eq:3)
$$

Nh∆∞ v·∫≠y m·∫∑c d√π vi·ªác ch·ªçn treatment $T$ cho t·ª´ng b·ªánh nh√¢n trong nghi√™n c·ª©u x·∫£y ra kh√¥ng ng·∫´u nhi√™n nh∆∞ng trong c√πng m·ªôt nh√≥m c√°c b·ªánh nh√¢n c√≥ ƒëi·ªÅu ki·ªán gi·ªëng nhau (ƒë∆∞·ª£c ph√¢n bi·ªát b·∫±ng c√°c confounders $\bf{X}$) th√¨ treatment l·∫°i ƒë∆∞·ª£c ch·ªçn ng·∫´u nhi√™n. V√¨ th·∫ø n·∫øu nh∆∞ sample size (k√≠ch c·ª° m·∫´u) c·ªßa m·ªói nh√≥m ƒë·ªß l·ªõn th√¨ ta ho√†n to√†n c√≥ th·ªÉ x√°c ƒë·ªãnh $\E[Y_i(1)]$ v√† $\E[Y_i(0)]$ b·∫±ng sample mean (trung b√¨nh m·∫´u) trong t·ª´ng nh√≥m. Nh∆∞ th·∫ø, hi·ªáu qu·∫£ t·ªïng h·ª£p c·ªßa treatments ƒë∆∞·ª£c t√≠nh b·∫±ng weighted mean (b√¨nh qu√¢n gia quy·ªÅn) c·ªßa nh·ªØng gi√° tr·ªã means trong t·ª´ng nh√≥m. k·∫øt qu·∫£ n√†y s·∫Ω kh√¥ng ch√≠nh x√°c n·∫øu nh∆∞ quy ∆∞·ªõc _positivity_ kh√¥ng th·ªèa, nghƒ©a l√† n·∫øu c√≥ b·∫•t k·ª≥ 1 nh√≥m n√†o ƒë√≥ ch·ªâ ƒë∆∞·ª£c ƒëi·ªÅu tr·ªã b·∫±ng m·ªôt ph∆∞∆°ng ph√°p duy nh·∫•t. C≈©ng nh∆∞ ƒë√£ ƒë·ªÅ c·∫≠p, nguy c∆° quy ∆∞·ªõc n√†y kh√¥ng th·ªèa s·∫Ω c√†ng cao n·∫øu nh∆∞ sample size c√†ng nh·ªè. 


:::: {.blackbox .important data-latex=""}
::: {.center data-latex=""}
**ƒê·ªãnh nghƒ©a**
:::

__*Propensity score (PS)*__ ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a nh∆∞ sau

$$
e(\bf{X}_i) = \P(T_i=1|\bf{X}_i)
(\#eq:4)
$$
x√°c su·∫•t m√† m·ªôt b·ªánh nh√¢n ƒë∆∞·ª£c x·∫øp v√†o nh√≥m treatment bi·∫øt r·∫±ng b·ªánh nh√¢n n√†y c√≥ ƒëi·ªÅu ki·ªán tr∆∞·ªõc can thi·ªáp l√† $\bf{X}$. 
::::

D·ª±a tr√™n quy ∆∞·ªõc _confoundedness_ th√¨ $\E[Y_i|T_i = 1,\bf{X}_i] = \E[Y_i|\bf{X}_i]$, v√† ta c≈©ng c√≥ th·ªÉ d·ª±a tr√™n $e(\bf{X}_i)$ ƒë·ªÉ k·∫øt lu·∫≠n t∆∞∆°ng t·ª± nh∆∞ sau

:::: {.blackbox .important data-latex=""}
::: {.center data-latex=""}
 
:::
$$
\E[Y_i|T_i = 1,e(\bf{X}_i)] = \E[Y_i|e(\bf{X}_i)]
(\#eq:5)
$$
::::

Th·∫≠t ra \@ref(eq:5) l√† h·ªá qu·∫£ n·∫øu nh∆∞ $T_i \indep Y_i(0),Y_i(1)|e(\bf{X}_i)$ ƒë√∫ng, v√† ƒë·ªÉ ch·ª©ng minh s·ª± ƒë·ªôc l·∫≠p gi·ªØa treatment assignment v√† potential outcomes d∆∞·ªõi ƒëi·ªÅu ki·ªán c·ªßa propensity score c·∫ßn ch·ª©ng minh ƒë∆∞·ª£c r·∫±ng $\P[T_i =1|Y_i(0),Y_i(1),e(\bf{X}_i)] = \P[T_i =1|e(\bf{X}_i)]$. Ta s·∫Ω ch·ª©ng minh qua 2 b∆∞·ªõc

:::: {.blackbox .mathematics data-latex=""}
::: {.center data-latex=""}
 mathy!!! (c√≥ th·ªÉ b·ªè qua)
:::
**Ch·ª©ng minh** 
$$
\P[T_i =1|Y_i(0),Y_i(1),e(\bf{X}_i)] = \P[T_i =1|e(\bf{X}_i)]
(\#eq:6)
$$

ƒê·∫ßu ti√™n ta c·∫ßn ch·ª©ng minh r·∫±ng 
$$
T_i \indep \bf{X}_i|e(\bf{X}_i)
$$
nghƒ©a l√† ta s·∫Ω ch·ª©ng minh $\P[T_i=1|\bf{X}_i,e(\bf{X}_i)] = \P[T_i=1|e(\bf{X}_i)]$. Ta c√≥ 

$$
VT = \P[T_i=1|\bf{X}_i,e(\bf{X}_i)] = \P[T_i=1|\bf{X}_i] = e(\bf{X}_i)
$$
d·∫•u b·∫±ng ƒë·∫ßu ti√™n x·∫£y ra v√¨ $e(\bf{X}_i)$ l√† m·ªôt h√†m s·ªë c·ªßa $\bf{X}_i$, d·∫•u b·∫±ng th·ª© hai l√† ƒë·ªãnh nghƒ©a c·ªßa propensity score. 

$$
\begin{split}
VP = \P[T_i=1|e(\bf{X}_i)] &\stackrel{(1)}{=} \E[T_i=1|e(\bf{X}_i)] \\
&\stackrel{(2)}{=} \E\big[\E\big(T_i=1|e(\bf{X}_i),\bf{X}_i\big)|e(\bf{X}_i)\big] \\
&\stackrel{(3)}{=} \E[e(\bf{X}_i)|e(\bf{X}_i)]\\
&= e(\bf{X}_i)
\end{split}
$$

- (1): $T_i$ l√† m·ªôt ph√¢n b·ªë nh·ªã ph√¢n, v√† n·∫øu $X \sim Bin(1,p)$, ta c√≥ $\E(X) = p$.
- (2): s·ª≠ d·ª•ng c√¥ng th·ª©c $\E(X) = \E[\E(X|Y)]$.
- (3): expectation b√™n trong ngo·∫∑c vu√¥ng ch√≠nh l√† ƒë·ªãnh nghƒ©a c·ªßa propensity score

Ti·∫øp theo ta s·∫Ω ch·ª©ng minh \@ref(eq:6):

::::{.scroll-w }
$$
\begin{split}
\P[T_i =1|Y_i(0),Y_i(1),e(\bf{X}_i)] &\stackrel{(1)}{=} \E[T_i =1|Y_i(0),Y_i(1),e(\bf{X}_i)] \\
&\stackrel{(2)}{=} \E\big[\E\big(T_i|Y_i(0),Y_i(1),\bf{X}_i,e(\bf{X}_i)\big)|Y_i(0),Y_i(1),e(\bf{X}_i)\big]\\
&\stackrel{(3)}{=}\E\big[\E\big(T_i|\bf{X}_i,e(\bf{X}_i)\big)|Y_i(0),Y_i(1),e(\bf{X}_i)\big] \\
&\stackrel{(4)}{=} \E\big[\E\big(T_i|e(\bf{X}_i))|Y_i(0),Y_i(1),e(\bf{X}_i) \big] \\
&\stackrel{(5)}{=} \E\big(T_i|e(\bf{X}_i)\big)\E\big[1|Y_i(0),Y_i(1),e(\bf{X}_i)\big] \\
&=  \E\big(T_i|e(\bf{X}_i)\big) \\
&= \P[T_i=1|e(\bf{X}_i)]
\end{split}
$$
::::

- (1): treatment $T$ thu·ªôc Bernoulli v·ªõi tham s·ªë $p = \P(T=1)$, nh·ªõ r·∫±ng n·∫øu $X\sim \mathcal{Ber}(p) \Rightarrow \P(X=1) = \E(X)$.
- (2): s·ª≠ d·ª•ng c√¥ng th·ª©c total expectation: $\E(X) = \E[\E(X|Y)]$.
- (3): s·ª≠ d·ª•ng quy ∆∞·ªõc confoundedness
- (4): s·ª≠ d·ª•ng k·∫øt qu·∫£ ch·ª©ng minh ·ªü b∆∞·ªõc 1.
- (5): v√¨ $\E(X|X=x) =x$
::::

# Suy lu·∫≠n nh√¢n qu·∫£ d·ª±a tr√™n Propensity score (PS)

Ph∆∞∆°ng tr√¨nh \@ref(eq:5) l√† n·ªÅn t·∫£ng ƒë·ªÉ ta c√≥ th·ªÉ √°p d·ª•ng PS trong suy lu·∫≠n nh√¢n qu·∫£, n√≥ cho ph√©p 2 treatments c√≥ th·ªÉ so s√°nh tr·ª±c ti·∫øp d∆∞·ªõi m·ªôt t·∫≠p PS. C√≥ nhi·ªÅu c√°ch s·ªØ d·ª•ng PS nh·∫±m l√†m gi·∫£m ƒë·ªô l·ªách c·ªßa 2 nh√≥m treatments, ta s·∫Ω l·∫ßn l∆∞·ª£t l√†m quen v·ªõi t·ª´ng ph∆∞∆°ng ph√°p. 

## C√¢n b·∫±ng hai nh√≥m ƒëi·ªÅu tr·ªã d·ª±a v√†o Propensity score

Trong r·∫•t nhi·ªÅu nghi√™n c·ª©u s·ª≠ d·ª•ng observational data, ta th∆∞·ªùng g·∫∑p s·ªë b·ªánh nh√¢n thu·ªôc nh√≥m ƒëi·ªÅu tr·ªã (nh√≥m active) √≠t h∆°n r·∫•t nhi·ªÅu so v·ªõi nh√≥m kh√¥ng ƒë∆∞·ª£c ƒëi·ªÅu tr·ªã (nh√≥m control). M·ªôt v√≠ d·ª• ƒëi·ªÉn h√¨nh l√† m·ªôt nh√† v·∫≠t l√Ω tr·ªã li·ªáu c√≥ m·ªôt data t·ª´ b·ªánh vi·ªán, trong t·∫≠p data n√†y ghi nh·∫≠n nh·ªØng b·ªánh nh√¢n ƒë∆∞·ª£c ƒëi·ªÅu tr·ªã b·ªánh nh∆∞ng l·∫°i kh√¥ng c√≥ b·∫•t k·ª≥ s·ªë li·ªáu n√†o c·ªßa nh·ªØng ng∆∞·ªùi thu·ªôc nh√≥m control. Trong tr∆∞·ªùng h·ª£p n√†y, h·ªç th∆∞·ªùng t√¨m ki·∫øm c√°c b·ªánh nh√¢n thu·ªôc nh√≥m control t·ª´ m·ªôt kh·∫£o s√°t v·ªõi quy m√¥ l·ªõn. Trong tr∆∞·ªùng h·ª£p m√† nh√≥m c√°c b·ªánh nh√¢n control nhi·ªÅu h∆°n nh√≥m active r·∫•t nhi·ªÅu th√¨ ta c√≥ th·ªÉ ch·ªçn ·ª©ng vi√™n trong nh√≥m control cho t·ª´ng b·ªánh nh√¢n trong nh√≥m ƒëi·ªÅu tr·ªã. qu√° tr√¨nh n√†y ƒë∆∞·ª£c th·ª±c hi·ªán qua 4 b∆∞·ªõc [@stu2010] nh∆∞ sau 

1. ch·ªçn ƒë·∫°i l∆∞·ª£ng ƒë·ªÉ t√≠nh kho·∫£ng c√°ch gi·ªØa c√°c units. 
2. sau khi ƒë√£ x√°c ƒë·ªãnh ƒë∆∞·ª£c ƒë·∫°i l∆∞·ª£ng kho·∫£ng c√°ch, ti·∫øn h√†nh matching 
3. ƒë√°nh gi√° k·∫øt qu·∫£, b∆∞·ªõc 1-2 c√≥ th·ªÉ th·ª±c hi·ªán l·∫°i nhi·ªÅu l·∫ßn ƒë·ªÉ t√¨m k·∫øt qu·∫£ t·ªët nh·∫•t
4. ti·∫øn h√†nh ph√¢n t√≠ch outcomes and estimate hi·ªáu qu·∫£ c·ªßa treatments

B∆∞·ªõc (1) chia l√†m 2 b∆∞·ªõc nh·ªè h∆°n l√† ch·ªçn bi·∫øn pretreatments v√† li√™n k·∫øt c√°c bi·∫øn ƒë∆∞·ª£c ch·ªçn th√†nh 1 ƒë·∫°i l∆∞·ª£ng duy nh·∫•t. T·∫°i sao ph·∫£i ch·ªçn pretreatments? trong nhi·ªÅu tr∆∞·ªùng h·ª£p data ƒë∆∞·ª£c s·ª≠ d·ª•ng ch·ª©a nhi·ªÅu bi·∫øn pretreatments h∆°n s·ªë units, nh∆∞ v·∫≠y ta kh√¥ng th·ªÉ ch·ªçn t·∫•t c·∫£ c√°c bi·∫øn ƒë√≥, m√† ch·ªâ ch·ªçn nh·ªØng bi·∫øt th·∫≠t s·ª± quan tr·ªçng. C√≥ nhi·ªÅu t√†i li·ªáu b√†n lu·∫≠n v·ªÅ ph∆∞∆°ng ph√°p ch·ªçn bi·∫øn, nh∆∞ng nh√¨n chung v·∫´n ch∆∞a ƒë∆∞a ra ƒë∆∞·ª£c m·ªôt ph∆∞∆°ng ph√°p n√†o thuy·∫øt ph·ª•c, v√† nh·ªØng ph∆∞∆°ng ph√°p ƒë√≥ c√≥ th·ªÉ cho ra nh·ªØng k·∫øt qu·∫£ r·∫•t kh√°c nhau. B√™n c·∫°nh ƒë√≥, vi·ªác ch·ªçn bi·∫øn ph√π h·ª£p ƒë·ªÉ ph√¢n t√≠ch c√≤n ph·ª• thu·ªôc r·∫•t nhi·ªÅu v√†o ki·∫øn th·ª©c n·ªÅn c·ªßa ng∆∞·ªùi nghi√™n c·ª©u, ta kh√¥ng th·ªÉ ch·ªâ d·ª±a v√†o c√°c hypothesis tests ƒë∆°n thu·∫ßn ƒë·ªÉ k·∫øt lu·∫≠n. Tuy nhi√™n ta c≈©ng n√≥i s∆° qua v·ªÅ ph∆∞∆°ng ph√°p _stepwise_ ƒë∆∞·ª£c ƒë·ªÅ c·∫≠p b·ªüi @vij2015. Trong t√†i li·ªáu n√†y, t√°c gi·∫£ ƒë√£ ƒë∆∞a ra 3 b∆∞·ªõc ti·∫øn h√†nh ch·ªçn bi·∫øn, th·ª© nh·∫•t l√† ch·ªçn ra c√°c bi·∫øn quan tr·ªçng d·ª±a v√†o ki·∫øn th·ª©c chuy√™n ng√†nh c·ªßa ng∆∞·ªùi nghi√™n c·ª©u. B∆∞·ªõc 2, s·ª≠ d·ª•ng stepwise ƒë·ªÉ ch·ªçn ra nh·ªØng bi·∫øn c√≤n l·∫°i trong s·ªë c√°c bi·∫øn ch∆∞a ƒë∆∞·ª£c ch·ªçn d·ª±a v√†o ƒë·∫°i l∆∞·ª£ng likelihood ratio v√† hypothesis test. B∆∞·ªõc 3, sau khi c√°c bi·∫øn b·∫≠c 1 ƒë√£ ƒë∆∞·ª£c ch·ªçn ta ti·∫øp t·ª•c ch·ªçn ra bi·∫øn b·∫≠c 2 v√† bi·∫øn t∆∞∆°ng t√°c, ph∆∞∆°ng ph√°p v·∫´n nh∆∞ b∆∞·ªõc 2. Qu√° tr√¨nh n√†y ƒë∆∞·ª£c th·ª±c hi·ªán ƒë·∫øn khi t√¨m ra ƒë∆∞·ª£c t·∫≠p bi·∫øn ph√π h·ª£p. Tuy v·∫≠y @stu2010 c≈©ng ƒë√£ kh·∫≥ng ƒë·ªãnh trong b√†i b√°o l√† ph∆∞∆°ng ph√°p stepwise kh√¥ng th·∫≠t s·ª± h·ªØu √≠ch v√¨ trong khi m·ª•c ti√™u c·ªßa ta l√† t√¨m ra PS sao cho ph√¢n b·ªë c·ªßa c√°c confounders gi·ªØa 2 nh√≥m ƒëi·ªÅu tr·ªã t∆∞∆°ng t·ª± nhau, th√¨ ph∆∞∆°ng ph√°p stepwise l·∫°i d·ª±a tr√™n treatments. T√¨m hi·ªÉu chi ti·∫øt t·∫°i @vij2015 v√† @stu2010.

B∆∞·ªõc (2) ta x√°c ƒë·ªãnh ƒë·∫°i l∆∞·ª£ng ƒë·ªÉ t√≠nh kho·∫£ng c√°ch gi·ªØa c√°c units, n√≥i c√°ch kh√°c l√† m·ª©c ƒë·ªô gi·ªëng nhau c·ªßa 2 units. Theo @stu2010 th√¨ c√≥ b·ªën ph∆∞∆°ng ph√°p cƒÉn b·∫£n ƒë·ªÉ ƒë·ªãnh nghƒ©a kho·∫£ng c√°ch $D_{ij}$ gi·ªØa b·ªánh nh√¢n $i$ v√† b·ªánh nh√¢n $j$ l√† 

1. Exact: 
$$
D_{ij} = \cases{0, \text{ if } X_i = X_j\\
\infty, \text{ if } X_i \ne X_j
}
$$
2. Mahalanobis: 
$$
D_{ij} = (X_i-X_j)^{\top}\Sigma^{-1}(X_i - X_j)
$$
trong ƒë√≥, $\Sigma$ ch√≠nh l√† covariance matrix c·ªßa $X$. 
3. Propensity score :
$$
D_{ij} = |e_i-e_j|
$$
trong ƒë√≥ $e_k$ ch√≠nh l√† PS c·ªßa b·ªánh nh√¢n th·ª© $k$. 
4. Linear PS:
$$
D_{ij} = |logit(e_i) - logit(e_j)|
$$

Tuy nhi√™n ta ch·ªâ t·∫≠p trung v√†o 2 ph∆∞∆°ng ph√°p cu·ªëi v√¨ n√≥ li√™n quan t·ªõi PS. ƒê√¥i khi ta c√≥ th·ªÉ k·∫øt h·ª£p gi·ªØa ph∆∞∆°ng ph√°p s·ªë (2) v√† s·ªë (3), nh∆∞ v·∫≠y ta c√≥
$$
D_{ij} \cases{(Z_i-Z_j)^{\top}\Sigma^{-1}(Z_i-Z_j), \text{ if } |logit(e_i)-logit(e_j)|\le c\\
\infty, \text{ if } |logit(e_i)-logit(e_j)| > c
}
$$
trong ƒë√≥ $c$ g·ªçi l√† caliper v√† $Z$ l√† t·∫≠p h·ª£p c√°c bi·∫øn pretreatment quan tr·ªçng. 

Sau khi ƒë√£ c√≥ t·∫≠p bi·∫øn pretreatment, ta ti·∫øn h√†nh estimate propensity score. B·ªüi v√¨ theo ƒë·ªãnh nghƒ©a th√¨ propensity score ch√≠nh l√† x√°c su·∫•t ƒë∆∞·ª£c x·∫øp v√†o nh√≥m treatment d∆∞·ªõi m·ªôt ƒëi·ªÅu ki·ªán cho tr∆∞·ªõc c·ªßa confounders $\P[T=1|X]$. Ta c≈©ng bi·∫øt r·∫±ng $T \sim \mathcal{Ber}(p)$, n√™n t·∫•t c·∫£ c√°c models ƒë∆∞·ª£c s·ª≠ d·ª•ng v·ªõi cho outcome d∆∞·ªõi ƒë·ªãnh d·∫°ng nh·ªã ph√¢n (binary) ƒë·ªÅu c√≥ th·ªÉ s·ª≠ d·ª•ng, ph·ªï bi·∫øn nh·∫•t l√† logistic. L∆∞u √Ω r·∫±ng khi ta x√¢y d·ª±ng logistic model, m·ª•c ti√™u c·ªßa ta kh√¥ng ph·∫£i suy lu·∫≠n v·ªÅ outcomes m√† ƒë·ªÉ x√°c ƒë·ªãnh propensity score , v√¨ th·∫ø v·∫•n ƒë·ªÅ ta quan t√¢m kh√¥ng n·∫±m ·ªü c√°c parameters c·ªßa model m√† l√† c√°c bi·∫øn pretreatment c√≥ c√¢n b·∫±ng hay kh√¥ng. 

Ti·∫øp theo l√† ta b·∫Øt ƒë·∫ßu matching sau khi ƒë√£ x√°c ƒë·ªãnh ƒë∆∞·ª£c c√°c PS. C≈©ng c√≥ r·∫•t nhi·ªÅu c√°c ph∆∞∆°ng ph√°p ƒë·ªÉ matching, ta s·∫Ω kh√°i qu√°t c√°c ph∆∞∆°ng ph√°p ƒë∆∞·ª£c ƒë·ªÅ c·∫≠p trong m·ªôt s·ªë t√†i li·ªáu v√† sau ƒë√≥ l√† ƒëi s√¢u v√†o 1 ph∆∞∆°ng ph√°p ƒëang ƒë∆∞·ª£c s·ª≠ d·ª•ng r·ªông r√£i. 

### Matching v·ªõi ƒë∆°n v·ªã g·∫ßn nh·∫•t

ƒê∆∞·ª£c bi·∫øt nh∆∞ l√† ph∆∞∆°ng ph√°p _matching ƒë∆°n v·ªã g·∫ßn nh·∫•t $k:1$_, d·∫°ng ƒë∆°n gi·∫£n nh·∫•t c·ªßa lo·∫°i matching n√†y l√† matching $1:1$, nghƒ©a l√† m·ªói m·ªôt ƒë∆°n v·ªã trong nh√≥m treatment s·∫Ω ƒë∆∞·ª£c match v·ªõi m·ªôt ƒë∆°n v·ªã trong nh√≥m control. M·ªôt v·∫•n ƒë·ªÅ c√≥ th·ªÉ ph√°t sinh l√† b·ªüi v√¨ c√≥ qu√° nhi·ªÅu ƒë∆°n v·ªã trong nh√≥m control b·ªã lo·∫°i b·ªè (v√¨ PS c·ªßa n√≥ qu√° xa v·ªõi c√°c ƒë∆°n v·ªã trong nh√≥m active), n√™n s·∫Ω l√†m gi·∫£m ƒë·ªô tin c·∫≠y khi ph√¢n t√≠ch. Tuy nhi√™n vi·ªác gi·∫£m ƒë·ªô tin c·∫≠y n√†y chi·∫øm t·ªâ l·ªá r·∫•t nh·ªè v√¨ 2 l√Ω do. Th·ª© nh·∫•t, Trong so s√°nh gi√° tr·ªã mean c·ªßa 2 samples, th√¨ ƒë·ªô tin c·∫≠y khi ph√¢n t√≠ch ƒë∆∞·ª£c quy·∫øt ƒë·ªãnh ph·∫ßn nhi·ªÅu b·ªüi sample c√≥ k√≠ch c·ª° nh·ªè h∆°n. V√¨ th·∫ø m·ªôt khi k√≠ch c·ª° nh√≥m active kh√¥ng ƒë·ªïi th√¨ s·∫Ω kh√¥ng c√≥ qu√° nhi·ªÅu th√¥ng tin b·ªã m·∫•t. Th·ª© hai, m·ªôt khi 2 nh√≥m treatments t∆∞∆°ng ƒë·ªìng nhau th√¨ ƒë·ªô tin c·∫≠y s·∫Ω tƒÉng. 

### Subclassification, Full matching v√† Weighting 

Ba ph∆∞∆°ng ph√°p n√†y c√≤ 1 ƒë·∫∑c t√≠nh v∆∞·ª£t tr·ªôi h∆°n so v·ªõi ph∆∞∆°ng ph√°p tr∆∞·ªõc ƒë√≥ l√† ta c√≥ th·ªÉ s·ª≠ d·ª•ng t·∫•t c·∫£ c√°c units c√≥ trong data m√† kh√¥ng ph·∫£i lo·∫°i b·ªè ƒëi b·∫•t c·ª© units n√†o n·∫øu nh∆∞ ƒë·∫°i l∆∞·ª£ng kho·∫£ng c√°ch kh√¥ng th·ªèa m√£n.

#### Subclassification

Nh∆∞ ƒë√£ tr√¨nh b√†y ·ªü tr√™n, v√¨ ph∆∞∆°ng ph√°p PS matching ch·ªâ ch·ªçn m·ªôt ph·∫ßn c·ªßa c√°c units n·∫±m trong nh√≥m control, ta c√≥ quy·ªÅn nghi ng·ªù v·ªÅ ƒë·ªô tin c·∫≠y trong ph√¢n t√≠ch. V√¨ th·∫ø, ƒë·ªÉ h·∫°n ch·∫ø ƒëi·ªÅu n√†y ta c√≥ th·ªÉ s·ª≠ d·ª•ng ph∆∞∆°ng ph√°p subclassification hay c√≤n g·ªçi l√† stratification. Nh∆∞ v·∫≠y c√°c units s·∫Ω ƒë∆∞·ª£c ph√¢n c·ª•m d·ª±a tr√™n gi√° tr·ªã PS t∆∞∆°ng ·ª©ng. V√≠ d·ª• ta k√Ω hi·ªáu $0 = c_0 < c_1 < \dots <c_m =1$ ƒë·∫°i di·ªán cho $m$ c·ª•m t∆∞∆°ng ·ª©ng v·ªõi $m$ kho·∫£ng tr√™n vector c√°c gi√° tr·ªã PS, nh∆∞ th·∫ø nh√≥m th·ª© $k$ s·∫Ω bao g·ªìm c√°c units m√† gi√° tr·ªã PS t∆∞∆°ng ·ª©ng c·ªßa n√≥ n·∫±m trong kho·∫£ng $I_k = (c_{k-1},c_k]$. Nh∆∞ v·∫≠y trong m·ªói m·ªôt nh√≥m ta c√≥ th·ªÉ t√≠nh ƒë∆∞·ª£c hi·ªáu qu·∫£ ƒëi·ªÅu tr·ªã c·ªßa treatments l√† $\E[Y_{i|1} - Y_{i|0}|e_i = e]$, b·ªüi v√¨ ƒë·∫°i l∆∞·ª£ng n√†y ph·ª• thu·ªôc tr√™n $e$, ta c√≥ th·ªÉ xem l√† m·ªôt h√†m s·ªë c·ªßa $e$. Theo l√Ω thuy·∫øt ta c≈©ng c√≥ 

$$
\E[Y_{i|j}|e_i \in I_k] \approx \E[Y_{i|j}|T_i=j,e_i \in I_k]
$$
v·ªõi $k = 1,2,\dots,m; j = 1,2$.

Nh∆∞ v·∫≠y, trong m·ªói m·ªôt c·ª•m t∆∞∆°ng ·ª©ng v·ªõi kho·∫£ng $I_k$, ta c√≥ th·ªÉ t√≠nh ƒë∆∞·ª£c 

$$
\hat{\E}(Y_{i|1}|e_i \in I_k) = 
\frac{\sum_{e_i\in I_k,T_i=1}Y_{i|1}}{n_{k|1}}; ~~~~
\hat{\E}(Y_{i|0}|e_i \in I_k) =  \frac{\sum_{e_i\in I_k,T_i=0}Y_{i|0}}{n_{k|0}}
$$
trong ƒë√≥ $n_{k|1}$ v√† $n_{k|0}$ l·∫ßn l∆∞·ª£t l√† k√≠ch c·ª° m·∫´u c·ªßa 2 nh√≥m ƒëi·ªÅu tr·ªã trong c·ª•m $k$. Nh∆∞ v·∫≠y ta c√≥ th·ªÉ ƒë√°nh gi√° ƒë∆∞·ª£c k·ª≥ v·ªçng hi·ªáu qu·∫£ ƒëi·ªÅu tr·ªã l√† 

$$
\hat{\E}[Y_{i|1}|e_i \in I_k] - \hat{\E}[Y_{i|0}|e_i \in I_k]
(\#eq:7)
$$

V√¨ ta c√≥ t·∫•t c·∫£ l√† $m$ c·ª•m ƒë∆∞·ª£c chia theo $m$ kho·∫£ng c·ªßa PS, ta c√≥ th·ªÉ t√≠nh t·ªïng h·ª£p hi·ªáu qu·∫£ ƒëi·ªÅu tr·ªã qua c√°c c·ª•m l√† 

$$
\sum_{k=1}^m\Big[\E(Y_{i|1}|e_i\in I_k) - \E(Y_{i_0}|e_i\in I_k)  \Big]\P(e_i \in I_k)
$$

v·ªõi 
$$
\P(e \in I_k) = \frac{n_{k|1}+n_{k|0}}{n}
$$ 
trong ƒë√≥ $n$ l√† k√≠ch c·ª° m·∫´u.

:::: {.blackbox .mathematics data-latex=""}
::: {.center data-latex=""}
a little mathy!!! (c√≥ th·ªÉ b·ªè)
:::
Ta c√≥ th·ªÉ vi·∫øt ph∆∞∆°ng tr√¨nh tr√™n ·ªü d·∫°ng t·ªïng qu√°t, nghƒ©a l√† ta c√≥ t·∫•t c·∫£ $n$ gi√° tr·ªã $e$ v√† $n \rightarrow \infty$. Nghƒ©a l√† t·ª´ \@ref(eq:7) ta suy ra 
$$
\int \Big[\E(Y_{i|1}|e_i=e) -  \E(Y_{i|0}|e_i=e)\Big]f(e)de
$$
trong ƒë√≥

:::: {.scroll-w}
$$\int_{c_{k-1}}^{c_k}\E(Y_{i|j}|e_i=e)f(e)de = \E(Y_{i|j}|e_i \in I_k)\int_{c_{k-1}}^{c_k}f(e)de = \E(Y_{i|j}|e_i \in I_k)\P(e_i \in I_k)$$
::::
::::

V·∫•n ƒë·ªÅ c√≤n l·∫°i l√† ta ph·∫£i chia kho·∫£ng cho c√°c gi√° tr·ªã c·ªßa PS $e_i$, $i=1,2,\dots,n$ nh∆∞ th·∫ø n√†o cho ph√π h·ª£p. ƒê·ªÉ ƒë∆°n gi·∫£n ta c√≥ th·ªÉ chia th√†nh $5-10$ c·ª•m l√† ph√π h·ª£p. Tuy nhi√™n ƒë·ªëi v·ªõi nh√≥m c√≥ k√≠ch c·ª° nh·ªè, ta c√≥ th·ªÉ d·ª±a v√†o ph√¢n v·ªã c·ªßa PS ƒë·ªÉ chia c·ª•m. 

Ngo√†i ra, @vij2015 ƒë√£ gi·ªõi thi·ªáu ƒë·∫øn m·ªôt ph∆∞∆°ng ph√°p s·ª≠ d·ª•ng m√°y ƒë·ªÉ ch·∫°y thu·∫≠t to√°n nh·∫±m ph√¢n chia c√°c c·ª•m sao cho ƒë·∫°t k·∫øt qu·∫£ t·ªët nh·∫•t. B√™n c·∫°nh ƒë√≥ t√°c gi·∫£ c≈©ng ƒë·ªÅ ngh·ªã ta ki·ªÉm tra t√≠nh ƒë·ªôc l·∫≠p gi·ªØa treatment v√† c√°c bi·∫øn pretretments trong m·ªói m·ªôt c·ª•m, nghƒ©a l√† $T_i \indep X_i|e(x_i)$. ƒê√¢y c≈©ng ch√≠nh l√† ph∆∞∆°ng ph√°p _full matching_. V√¨  nh·ªØng ph∆∞∆°ng ph√°p k·ªÉ tr√™n √≠t ƒë∆∞·ª£c s·ª≠ d·ª•ng n√™n ta ch·ªâ n√≥i s∆° qua ƒë·ªÉ ta c√≥ c√°i nh√¨n t·ªïng qu√°t v·ªÅ c√°c ph∆∞∆°ng ph√°p s·ª≠ d·ª•ng PS trong suy lu·∫≠n nh√¢n qu·∫£. Ph∆∞∆°ng ph√°p s·ª≠ d·ª•ng PS kh√° ph·ªï bi·∫øn hi·ªán nay l√† ph∆∞∆°ng ph√°p weighting, s·∫Ω ƒë∆∞·ª£c t√¨m hi·ªÉu ·ªü ph·∫ßn ti·∫øp theo. 

#### Ph∆∞∆°ng ph√°p weighting 

 ch√∫ng ta bi·∫øt b·∫±ng m·ªói m·ªôt PS ch√≠nh l√† x√°c su·∫•t b·ªánh nh√¢n ƒë∆∞·ª£c x·∫øp v√†o nh√≥m active, $e \in (0,1)$, nh∆∞ v·∫≠y n·∫øu nh∆∞ PS c·ªßa m·ªôt b·ªánh nh√¢n n√†o ƒë√≥ l√† $e = 0.1$ th√¨ gi√° tr·ªã n√†y cho ta bi·∫øt c√≥ t·∫•t c·∫£ $1/e = 10$ b·ªánh nh√¢n  thu·ªôc nh√≥m active c√≥ ƒëi·ªÅu ki·ªán gi·ªëng nhau. T∆∞∆°ng t·ª±, s·∫Ω c√≥ t·∫•t c·∫£ $1/(1-0.1) =1.1$ b·ªánh nh√¢n thu·ªôc nh√≥m control c√≥ c√πng ƒëi·ªÅu ki·ªán. V√¨ th·∫ø ta ch·ªâ c·∫ßn nh√¢n gi√° tr·ªã c·∫ßn t√≠nh cho $1/e$ hay $1/(1-e)$ t√πy thu·ªôc v√†o b·ªánh nh√¢n ƒë√≥ n·∫Øm trong nh√≥m ƒëi·ªÅu tr·ªã n√†o. $1/e$ v√† $1/(1-e)$ ƒë∆∞·ª£c g·ªçi _inverse probability weighting (IPW)_, ta c√≥ th·ªÉ bi·ªÉu di·ªÖn IPW ·ªü d·∫°ng t·ªïng qu√°t nh∆∞ sau 
$$
w_i  = \frac{T_i}{e_i} + \frac{1-T_i}{1-e_i}.
$$
ƒë√¢y c≈©ng ƒë∆∞·ª£c g·ªçi l√† ∆∞·ªõc l∆∞·ª£ng Horvitz-Thompson. D∆∞·ªõi quy ∆∞·ªõc _unconfoundedness_ ta c√≥ 

$$
\E\Big[\frac{T_iY_i}{e_i}\Big] = \E[Y_i(1)],~~~\text{and }~~~~ \E\Big[\frac{(1-T_i)Y_i}{1-e_i}\Big] = \E[Y_i(0)]
(\#eq:8)
$$

:::: {.blackbox .mathematics data-latex=""}
::: {.center data-latex=""}
(c√≥ th·ªÉ b·ªè qua)
:::
**Ch·ª©ng minh r·∫±ng:**
$$
\E\Big[\frac{T_iY_i}{e_i}\Big] = \E[Y_i(1)]
(\#eq:9)
$$
Ta ch·ªâ xem x√©t tr∆∞·ªùng h·ª£p khi $T_i=1$, v√¨ khi $T_i=0$ th√¨ \@ref(eq:8) s·∫Ω b·∫±ng $0$. Ta c√≥ $\Big[\frac{Y_i}{e_i}\Big|T_i=1\Big] = \Big[\frac{Y_i(1)}{e_i}\Big|T_i=1\Big]$, n√™n
$$
\E\Big[\frac{T_iY_i}{e_i}\Big] = \E\Big[\frac{T_iY_i(1)}{e_i}\Big].
(\#eq:10)
$$

S·ª≠ d·ª•ng _total of expectation_, ta c√≥
$$
\E\Big[\frac{T_iY_i(1)}{e_i}\Big] = \E\Big[\E\Big(\frac{T_iY_i(1)}{e_i}\Big|X_i\Big)\Big]
(\#eq:11)
$$
ta c≈©ng bi·∫øt r·∫±ng d∆∞·ªõi ƒëi·ªÅu ki·ªán  c·ªßa bi·∫øn pretreatment $X$ th√¨ can thi·ªáp $T$ v√† k·∫øt qu·∫£ $Y$ ƒë·ªôc l·∫≠p, v√¨ th·∫ø $\E(TY) = \E(T)\E(Y)$, s·ª≠ d·ª•ng t√≠nh ƒë·ªôc l·∫≠p n√†y ta c√≥ 

$$
\E\Big[\frac{T_iY_i(1)}{e_i}\Big|X_i\Big] = \frac{\E(T_i|X_i)\E(Y_i(1)|X_i)}{e_i} = \frac{e_i\E(Y_i(1)|X_i)}{e_i} = \E(Y_i(1)|X_i)
(\#eq:12)
$$
l∆∞u √Ω $e_i = e(X_i)$ l√† m·ªôt h√†m c·ªßa $X_i$, v√¨ th·∫ø $\E(e(X_i)|X_i=x_i) = e(x_i)$. Nh∆∞ v·∫≠y t·ª´ \@ref(eq:11) v√† \@ref(eq:12) ta c√≥ \@ref(eq:9). Ch·ª©ng minh t∆∞∆°ng t·ª± cho tr∆∞·ªùng h·ª£p c√≤n l·∫°i c·ªßa \@ref(eq:8).
::::

T·ª´ \@ref(eq:8) ta c√≥ th·ªÉ ∆∞·ªõc l∆∞·ª£ng t·ª´ s·ªë m·∫´u nh∆∞ sau 

$$
\hat{\E}(Y_i(1)) = \frac{1}{n}\sum_{i=1}^n\frac{T_iY_{i|T}}{e_i}~~~ and ~~~ \hat{\E}(Y_i(0)) = \frac{1}{n}\sum_{i=1}^n\frac{(1-T_i)Y_{i|T}}{1- e_i}
(\#eq:13)
$$
Nh∆∞ v·∫≠y ta c√≥ th·ªÉ ∆∞·ªõc l∆∞·ª£ng ƒë∆∞·ª£c gi√° tr·ªã c·ªßa ƒë·∫°i l∆∞·ª£ng ƒë·∫°i di·ªán cho hi·ªáu qu·∫£ c·ªßa hai nh√≥m b·ªánh nh√¢n l√† $\hat{\tau} = \E[Y_i(1)] - \E[Y_0(0)]$ t·ª´ \@ref(eq:13). 

Nh∆∞ ƒë√£ n√≥i, trong th·ª±c t·∫ø ta kh√¥ng bi·∫øt ƒë∆∞·ª£c gi√° tr·ªã ƒë√∫ng c·ªßa c√°c $e_i$ nh∆∞ng ta c√≥ th·ªÉ ∆∞·ªõc l∆∞·ª£ng ch√∫ng b·∫±ng c√°ch fit nh·ªØng models m√† bi·∫øn outcome thu·ªôc ƒë·ªãnh d·∫°ng nh·ªã ph√¢n (binary), v√≠ d·ª• ti√™u bi·ªÉu l√† logistic model. Nh∆∞ v·∫≠y, sau khi ƒë√£ t√¨m ƒë∆∞·ª£c ∆∞·ªõc l∆∞·ª£ng c·ªßa $e_i$ l√† $\hat{e}_i$ ta s·∫Ω s·ª≠ d·ª•ng $\hat{e}_i$ trong c√¥ng th·ª©c \@ref(eq:13) v√† sau ƒë√≥ t√≠nh $\hat{\tau} = \E[Y_i(1)] - \E[Y_0(0)]$. 

M·ªôt ƒëi·ªÉm n·ªØa c·∫ßn nh·∫Øc t·ªõi, N·∫øu nh∆∞ c·∫£ bi·∫øn k·∫øt qu·∫£ $Y$ c≈©ng l√† bi·∫øn binary, th√¨ ta s·∫Ω c√≥ m·ªôt s·ªë ƒë·∫°i l∆∞·ª£ng th∆∞·ªùng ƒë∆∞·ª£c s·ª≠ d·ª•ng ƒë·ªÉ th·ªÉ hi·ªán t√≠nh hi·ªáu qu·∫£ c·ªßa can thi·ªáp. ·ªû tr√™n ta nh·∫Øc t·ªõi $\tau = \E(Y(1) - Y(0))$, trong tr∆∞·ªùng h·ª£p nh·ªã ph√¢n, th√¨ c√¥ng th·ª©c n√†y ƒë∆∞·ª£c g·ªçi l√† _risk difference_, ngo√†i ra c√≥ 2 ƒë·∫°i l∆∞·ª£ng kh√°c c≈©ng ƒë∆∞·ª£c s·ª≠ d·ª•ng ph·ªï bi·∫øn l√† _risk ratio_ v√† _odd ratio_. Ta s·∫Ω c√≥ m·ªôt b√†i ri√™ng n√≥i v·ªÅ c√°c ƒë·∫°i l∆∞·ª£ng ph√¢n t√≠ch n√†y. Trong ph·∫°m vi b√†i n√†y, n·∫øu ta mu·ªën ƒë√°nh gi√° hi·ªáu qu·∫£ th√¥ng qua ƒë·∫°i l∆∞·ª£ng odd ratio, ta s·∫Ω fit model b·∫±ng c√¥ng th·ª©c 

$$
Y_{i|T} = \alpha+\tau T_i +\epsilon_i
$$
model n√†y ƒë∆∞·ª£c fit b·∫±ng weighted least squares. 

# Ki·ªÉm Tra ƒê·ªô C√¢n B·∫±ng c·ªßa PS

Tr∆∞·ªõc khi ∆∞·ªõc l∆∞·ª£ng $\{\hat{e}_i:i=1,2,\dots,n\}$ c·ªßa PS ƒë∆∞·ª£c s·ª≠ d·ª•ng trong qu√° tr√¨nh ph√¢n t√≠ch th√¨ ta c·∫ßn c√≥ m·ªôt ƒë·∫°i l∆∞·ª£ng ƒë·ªÉ ƒë√°nh gi√° s·ª± ƒë·ªô c√¢n b·∫±ng c·ªßa c√°c confounders $\bf{X}$. N√≥i c√°ch kh√°c ta mu·ªën xem x√©t ƒë·ªô kh√°c bi·ªát c·ªßa c√°c bi·∫øn confounders sau khi s·ª≠ d·ª•ng PS. Theo @aus2011 ta s·ª≠ d·ª•ng ƒë·∫°i l∆∞·ª£ng _standardized difference_ nh∆∞ b√™n d∆∞·ªõi ƒë·ªÉ ƒëo ƒë·ªô kh√°c bi·ªát

$$
d = \frac{\bar{x}_1 - \bar{x}_0 }{\sqrt{\frac{s^2_1 + s^2_0}{2}}}
(\#eq:14)
$$
s·ª≠ d·ª•ng cho bi·∫øn li√™n t·ª•c trong ƒë√≥ $\bar{x}_1, s^2_1$ v√† $\bar{x}_0,s^2_0$  l·∫ßn l∆∞·ª£t l√† weighted mean v√† weighted variance c·ªßa 2 nh√≥m treatment v√† control. V√† 

$$
d = \frac{\hat{p}_1 - \hat{p}_0}{\sqrt{\frac{\hat{p}_1(1-\hat{p}_1)+\hat{p}_0(1-\hat{p}_0)}{2}}}
$$
s·ª≠ d·ª•ng cho bi·∫øn r·ªùi r·∫°c, trong ƒë√≥ $\hat{p}_1$ v√† $\hat{p}_0$ l·∫ßn l∆∞·ª£t l√† t·ªâ l·ªá c·ªßa t·ª´ng s·ª± ki·ªán c·ªßa 1 bi·∫øn confounders. Hai tr·ªã s·ªë n√†y c≈©ng ƒë∆∞·ª£c t√≠nh b·∫±ng weighted proportion. 

Trong qu√° tr√¨nh b√°o c√°o, ta ph·∫£i s·ª≠ d·ª•ng 2 ƒë·∫°i l∆∞·ª£ng ƒë·ªÉ t√≠nh ƒë·ªô kh√°c bi·ªát c·ªßa c√°c bi·∫øn confounders tr∆∞·ªõc v√† sau khi s·ª≠ d·ª•ng PS ƒë·ªÉ th·∫•y ƒë∆∞·ª£c s·ª± thay ƒë·ªïi trong c·∫•u tr√∫c ph√¢n b·ªë c·ªßa t·ª´ng confounders trong m·ªói nh√≥m ƒëi·ªÅu tr·ªã. Ta s·∫Ω ƒë·ªÅ c·∫≠p ƒë·∫øn v·∫•n ƒë·ªÅ n√†y s√¢u h∆°n ·ªü c√°c ph·∫ßn sau. 

# V√≠ d·ª• minh h·ªça 

C√≥ 2 `R` packages ƒë∆∞·ª£c s·ª≠ d·ª•ng kh√° ph·ªï bi·∫øn hi·ªán nay ƒë√≥ ƒë√≥ `MatchIt` v√† `WeightIt`. Trong ƒë√≥ `MacthIt` cung c·∫•p nh·ªØng ph∆∞∆°ng ph√°p matching kh√≥ c·ªï ƒëi·ªÉn ƒë√£ ƒë∆∞·ª£c ƒë·ªÅ c·∫∑p nh∆∞ _exact_, _subclassification_, _nearest_, v.v... t√†i li·ªáu tham kh·∫£o c√≥ th·ªÉ t√¨m th·∫•y b·∫±ng link n√†y [MatchIt](https://cran.r-project.org/web/packages/MatchIt/MatchIt.pdf), v√† v√≠ d·ª• minh ho·∫° c√≥ th·ªÉ t√¨m th·∫•y ·ªü ƒë√¢y [V√≠ d·ª• minh ho·∫° cho MatchIt](https://sejdemyr.github.io/r-tutorials/statistics/tutorial8.html). 

package `WeightIt` offers nhi·ªÅu ph∆∞∆°ng ph√°p m·ªõi h∆°n, trong ƒë√≥ ph·∫ßn ∆∞·ªõc l∆∞·ª£ng PS c√≥ th·ªÉ th·ª±c hi·ªán b·∫±ng nhi·ªÅu ph∆∞∆°ng ph√°p trong machine learning. Trong khi `MatchIt` kh√¥ng cung c·∫•p ph∆∞∆°ng ph√°p weighting, th√¨ `WeightIt` cung c·∫•p kh√° ƒë·∫ßy ƒë·ªß c√°c h√†m ƒë·ªÉ th·ª±c hi·ªán  ph∆∞∆°ng ph√°p weighting. B·∫°n ƒë·ªçc c√≥ th·ªÉ t√¨m hi·ªÉu t·∫°i ƒë√¢y [WeightIt](https://cran.r-project.org/web/packages/WeightIt/WeightIt.pdf), v√≠ d·ª• minh ho·∫° t·∫°i ƒë√¢y [V√≠ d·ª• minh ho·∫° cho WeightIt](https://cran.r-project.org/web/packages/WeightIt/vignettes/WeightIt.html). 

Trong ph·∫ßn sau ta s·∫Ω ƒëi t√¨m hi·ªÉu k·ªπ h∆°n v·ªÅ package `WeightIt` c≈©ng nh∆∞ m·ªôt s·ªë ph∆∞∆°ng ph√°p thu·ªôc nh√≥m weighting b·∫±ng propensity score. Trong packages n√†y, nhi·ªÅu ph∆∞∆°ng ph√°p weighting mang t√≠nh ch·∫•t kh√°i qu√°t ƒë∆∞·ª£c ƒë·ªÅ c·∫≠p, v√¨ th·∫ø ƒë·ªÉ s·ª≠ d·ª•ng ta c·∫ßn hi·ªÉu m·ªôt v√†i kh√°i ni·ªám cƒÉn b·∫£n d·ª±a tr√™n @li2017.

<!-- ################################################################################################### -->
<!-- :::: {.blackbox data-latex=""} -->
<!-- ::: {.center data-latex=""} -->
<!-- **Proof:** -->
<!-- ::: -->
<!-- over here -->
<!-- :::: -->
# üìù _**References**_ {-}