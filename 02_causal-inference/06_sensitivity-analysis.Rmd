---
title: '&#128205; ÄÃ¡nh GiÃ¡ TÃ­nh á»”n Äá»‹nh Cá»§a Propensity Score'
author: ğŸ‘¦ğŸ» $\mathcal{An}$
date: "&#x1F4C5; _`r {
if(!file.exists('date_list.rds')){saveRDS(list(), file = 'date_list.rds')}
update=FALSE
filename=knitr::current_input(dir = FALSE)
mylist <- readRDS(file ='date_list.rds')
if(update|!(filename%in%names(mylist))){
mylist[[filename]]<- format(Sys.Date(),format = '%d-%m-%Y')
saveRDS(mylist, file = 'date_list.rds')}
readRDS(file ='date_list.rds')[[filename]]  }`_"
abstract: |
output: 
    bookdown::html_document2:
      fig_caption: yes
      theme: default
      toc: true
      toc_float: 
        collapsed: false
      toc_depth: 3
      code_folding: hide
      css: "../00_supp/style.css"
      number_sections: true
      includes:
        in_header: ["../00_supp/header.html"]
        before_body: "test.html"
        after_body: "../00_supp/mycomment.html"
fontsize: 12pt
bibliography: ["citation.bib"]
csl: "../00_supp/apa.csl"
link-citations: true
editor_options: 
  chunk_output_type: console
---

\def\emp{\varnothing}
\usepackage{extarrows}
 
```{css, echo = F}
/*----------LOGO above TOC---------*/

#TOC::before {
  content: "";
  display: block;
  height: 200px;
  margin: 2.75em 20px 40px 20px;
  background-image: url("casual.jpg");
  background-size: contain;
  background-position: center center;
  background-repeat: no-repeat;
}
```



::: {.watermark} 
_DRAFT_
:::


```{r child="../00_supp/general_rmd.Rmd"}
```

BÃ i nÃ y dá»±a trÃªn bÃ i bÃ¡o cá»§a @pan2016.

# Recap 

Giáº£ sá»­ $T$ lÃ  má»™t biáº¿n nhá»‹ phÃ¢n nháº­n hai giÃ¡ trá»‹ $\{0,1\}$, trong Ä‘Ã³ $1$ lÃ  khi bá»‡nh nhÃ¢n thuá»™c nhÃ³m Ä‘iá»u trá»‹ active vÃ  $0$ thuá»™c nhÃ³m control. Má»—i bá»‡nh nhÃ¢n cÃ³ má»™t nhÃ³m bao gá»“m cÃ¡c biáº¿n Ä‘Æ°á»£c quy Ä‘á»‹nh trÆ°á»›c Ä‘iá»u trá»‹, táº¡m gá»i táº­p há»£p cÃ¡c biáº¿n nÃ y lÃ  vector $\bf{X}_i = (X_{i1},X_{i2}, \dots, X_{ik})$ trong Ä‘Ã³ $i$ Ä‘áº¡i diá»‡n cho bá»‡nh nhÃ¢n thá»© $i$, cÃ²n $k$ lÃ  sá»‘ biáº¿n quy Ä‘á»‹nh trÆ°á»›c Ä‘iá»u trá»‹. Propensity score sáº½ Ä‘Æ°á»£c Ä‘á»‹nh nghÄ©a lÃ  má»™t xÃ¡c suáº¥t Ä‘iá»u kiá»‡n khi bá»‡nh nhÃ¢n thuá»™c nhÃ³m active biáº¿t ráº±ng bá»‡nh nhÃ¢n Ä‘Ã³ thá»a cÃ¡c thÃ´n tin Ä‘Æ°á»£c cung cáº¥p bá»Ÿi cÃ¡c biáº¿n trÆ°á»›c Ä‘iá»u trá»‹ $\bf{X}$. NghÄ©a lÃ  
$$
e(\bf{X}_i) = \P(T_i =1|\bf{X}_i),
$$
Ä‘á»ƒ xáº¥p xá»‰ phÃ¢n bá»‘ chuáº©n, ta thÆ°á»ng khÃ´ng sá»­ dá»¥ng trá»±c tiáº¿p $e(\bf{X})$ mÃ  sáº½ biáº¿n Ä‘á»•i nÃ³ báº±ng hÃ m log, $\ln\Big(\frac{e(\bf{X})}{1-e(\bf{X})}\Big)$.

# Giá»›i thiá»‡u 

NhÆ° Ä‘Ã£ Ä‘á»‹nh nghÄ©a á»Ÿ pháº§n recap, $\bf{X}$ chÃ­nh lÃ  má»™t vector gá»“m cÃ¡c biáº¿n trÆ°á»›c Ä‘iá»u trá»‹, nhá»¯ng biáº¿n nÃ y chÃ­nh lÃ  cÃ¡c thÃ´ng tin ta cÃ³ thá»ƒ quan sÃ¡t. NgoÃ i ra, sáº½ tá»“n táº¡i nhá»¯ng biáº¿n khÃ´ng thá»ƒ quan sÃ¡t (nghÄ©a lÃ  cÃ¡c biáº¿n khÃ´ng cÃ³ trong data), táº¡m gá»i lÃ  $\bf{U} = (u_1,u_2,\dots,u_N)^{\top}$. NhÆ° váº­y $\bf{X}^{(+u)} = (\bf{X},\bf{U})$ chÃ­nh lÃ  táº­p há»£p Ä‘áº§y Ä‘á»§ cá»§a cÃ¡c biáº¿n trÆ°á»›c Ä‘iá»u trá»‹. NhÆ° váº­y Ä‘á»™ nháº¡y hay tÃ­nh á»•n Ä‘á»‹nh cá»§a Æ°á»›c lÆ°á»£ng cá»§a propensity score Ä‘Æ°á»£c Ä‘á»‹nh nghÄ©a lÃ  sá»± khÃ¡c biá»‡t (hay thay Ä‘á»•i) giá»¯a hai Æ°á»›c lÆ°á»£ng cá»§a propensity score Ä‘Æ°á»£c tÃ­nh báº±ng $\bf{X}$ vÃ  $\bf{X}^{(+u)}$. NghÄ©a lÃ  
$$
\Delta_i = e(\bf{X}_i^{(+u)}) - e(\bf{X}_i)
(\#eq:eq21)
$$
Tuy nhiÃªn vÃ¬ $\bf{U}$ khÃ´ng Ä‘Æ°á»£c quan sÃ¡t nÃªn $\Delta$ sáº½ khÃ´ng thá»ƒ tÃ­nh Ä‘Æ°á»£c theo lÃ½ thuyáº¿t. NhÆ°ng ta cÃ³ thá»ƒ "mÆ°á»£n" thÃ´ng tin tá»« cÃ¡c biáº¿n cÃ³ thá»ƒ quan sÃ¡t Ä‘á»ƒ xÃ¡c Ä‘á»‹nh $\Delta$ dÆ°á»›i Ä‘iá»u kiá»‡n giáº£ thuyáº¿t thÃ¬ cÃ¡c biáº¿n $\bf{X}$ vÃ  $\bf{U}$ cÃ³ áº£nh hÆ°á»Ÿng lÃªn Æ°á»›c lÆ°á»£ng cá»§a cÃ¡c PS lÃ  tÆ°Æ¡ng tá»± nhau. Báº±ng cÃ¡ch nÃ y ta cÃ³ thá»ƒ Æ°á»›c lÆ°á»£ng tÃ­nh á»•n Ä‘á»‹nh báº±ng cÃ¡ch xem má»—i biáº¿n trÆ°á»›c thÃ­ nghiá»‡m cÃ³ thá»ƒ quan sÃ¡t nhÆ° lÃ  cÃ¡c biáº¿n khÃ´ng thá»ƒ quan sÃ¡t, nghÄ©a lÃ  
$$
\hat{\Delta}_{ij} = e(\bf{X}_i) - e(\bf{X}_i^{(-j)}), i  =1,\dots,N; j =1, \dots, K
(\#eq:eq22)
$$
trong Ä‘Ã³ $\bf{X}^{(-j)}$ lÃ  vector cá»§a cÃ¡c biáº¿n trÆ°á»›c thÃ­ nghiá»‡m loáº¡i Ä‘i biáº¿n thá»© $j$. NhÆ° váº­y Ä‘á»‘i vá»›i má»—i bá»‡nh nhÃ¢n $i$ ta sáº½ láº§n lÆ°á»£t tÃ­nh $K$ giÃ¡ trá»‹ $\{\hat{\Delta}_{ij}\}_{j=1,\dots,K}$. NhÆ° váº­y, má»—i bá»‡nh nhÃ¢n sáº½ cÃ³ $K$ giÃ¡ trá»‹ vÃ  táº¡o thÃ nh má»™t phÃ¢n bá»‘, táº¡m kÃ­ hiá»‡u phÃ¢n bá»‘ nÃ y lÃ  $\Delta^*_i$. Cho má»—i bá»‡nh nhÃ¢n ta Ä‘á»‹nh nghÄ©a xÃ¡c suáº¥t sau 
$$
R_i = \P(\min_{1\le j \le K}\hat{\Delta}_{ij} \le \Delta^*_i \le \max_{1 \le j \le K}\hat{\Delta}_{ij})
(\#eq:eq23)
$$
Cho má»—i bá»‡nh nhÃ¢n náº¿u $R_i \ge 0.95$, thÃ¬ ta káº¿t luáº­n Æ°á»›c lÆ°á»£ng cá»§a PS lÃ  á»•n Ä‘á»‹nh dÆ°á»›i sá»± áº£nh hÆ°á»Ÿng cá»§a $\bf{U}$. Náº¿u nhÆ° khoáº£ng $80%$ sá»‘ bá»‡nh nhÃ¢n cÃ³ $R \ge 0.95$ thÃ¬ tÃ­nh á»•n Ä‘á»‹nh Ä‘Æ°á»£c kháº³ng Ä‘á»‹nh trÃªn toÃ n máº«u. NghÄ©a lÃ  
$$
\P(R) =  \frac{1}{N}\sum_{i=1}^N \I(R_i\ge0.95) \ge 0.8,
$$

Náº¿u $0.5 \le \P(R) \le 0.8$ thÃ¬ tÃ­nh á»•n Ä‘á»‹nh sáº½ Ä‘Æ°á»£c cáº£nh bÃ¡o, vÃ  náº¿u lÃ  dÆ°á»›i $50%$ thÃ¬ Æ°á»›c lÆ°á»£ng cá»§a PS sáº½ khÃ´ng á»•n Ä‘á»‹nh. 

Pháº§n cÃ²n láº¡i ta cáº§n giáº£i quyáº¿t lÃ  lÃ m sao tÃ­nh Ä‘Æ°á»£c $R_i$, bá»Ÿi vÃ¬ ta khÃ´ng biáº¿t phÃ¢n bá»‘ tháº­t sá»± cá»§a $\Delta^*_i$. PhÆ°Æ¡ng phÃ¡p cho váº¥n Ä‘á» nÃ y lÃ  ta sáº½ xáº¥p xá»‰ hÃ m máº­t Ä‘á»™ cá»§a nÃ³ báº±ng má»™t trong nhá»¯ng phÃ¢n bá»‘ Pearson dá»±a vÃ o bá»‘n moment Ä‘áº§u tiÃªn cá»§a $\Delta^*$, nghÄ©a lÃ  $\E({\Delta^*}^{m})$ vá»›i $m = 1,\dots,4$. Bá»‘n moment nÃ y sáº½ Ä‘Æ°á»£c Æ°á»›c lÆ°á»£ng báº±ng cÃ´ng thá»©c cá»§a ká»³ vá»ng (mean), phÆ°Æ¡ng sai(variance), Ä‘á»™ xiÃªn(skewness) vÃ  Ä‘á»™ nhá»n(kurtosis). NhÆ° váº­y ta sáº½ cÃ³ 
$$
\begin{split}
&\hat{\mu}_{i1} = \frac{1}{K}\sum_{j=1}^K\hat{\Delta}_{ij},~~~~\text{vÃ } \\
&\hat{\mu}_{im} = \frac{1}{K}\sum(\hat{\Delta}_{ij} - \hat{\mu}_{i1})^m,~~~~m=2,3,4.
\end{split}
(\#eq:eq24)
$$

Tá»« 4 giÃ¡ trá»‹ $\{\hat{\mu}_{im}\}_{m=1,2,3,4.}$ ta sáº½ láº­p há»‡ phÆ°Æ¡ng trÃ¬nh vÃ  tÃ¬m cÃ¡c parameters cá»§a phÃ¢n bá»‘ Pearson. Má»™t khi Ä‘Ã£ cÃ³ cÃ¡c parameters ta cÃ³ thá»ƒ dá»… dÃ ng tÃ­nh cÃ¡c $R_i$. 

# Thá»±c hÃ nh

Trong pháº§n nÃ y ta sáº½ sá»­ dá»¥ng R vÃ  tá»«ng bÆ°á»›c thá»±c hiá»‡n cÃ¡c bÆ°á»›c Ä‘Ã£ giáº£i thÃ­ch á»Ÿ pháº§n trÆ°á»›c. Trong pháº§n nÃ y ta sáº½ sá»­ dá»¥ng package `PearsonDS`Ä‘á»ƒ xÃ¡c Ä‘á»‹nh cÃ¡c moments, parameters vÃ  xÃ¡c suáº¥t $R$ trong `r lb('eq23')`. NgoÃ i ra, ta cÅ©ng cÃ³ thá»ƒ dá»±a vÃ o @yang2019 Ä‘á»ƒ thiáº¿t láº­p cÃ¡c cÃ´ng thá»©c cho phÃ¢n bá»‘ Pearson. LÆ°u Ã½ ráº±ng cÃ³ 7 loáº¡i phÃ¢n bá»‘ Pearson khÃ¡c nhau, tÃ¹y thuá»™c vÃ o moments ta cÃ³ mÃ  sáº½ cÃ³ nhá»¯ng phÃ¢n bá»‘ cÃ³ thá»ƒ xÃ¡c Ä‘á»‹nh vÃ  nhá»¯ng phÃ¢n bá»‘ khÃ´ng thá»ƒ xÃ¡c Ä‘á»‹nh. Tuy nhiÃªn, phÆ°Æ¡ng phÃ¡p nÃ y sá»­ dá»¥ng xáº¥p xá»‰ cÃ¡c phÃ¢n bá»‘ Pearson chá»© khÃ´ng hoÃ n toÃ n chÃ­nh xÃ¡c, nÃªn káº¿t quáº£ khÃ´ng hoÃ n toÃ n thuyáº¿t phá»¥c.  

```{r}
data("lalonde", package = "cobalt")

param = c("age","educ","race","married","nodegree", "re74","re75")

ex = WeightIt::weightit(treat ~ age+ educ+ race+ married+ nodegree+ re74+ re75, 
                        data = lalonde, estimand = "ATO")$ps

delta<-
map(1:7,~{
  
  p = param[-.]
  f = as.formula( paste("treat~", paste(p, collapse = "+")))
  out = WeightIt::weightit(formula = f, data = lalonde, estimand = "ATO")
  ex - out$ps
  
})%>% `names<-`(paste0("remove_",param))%>%
  bind_cols()

p = delta[1,]%>% unlist()

R = 
pmap_dbl(delta,~{
  p = c(...)
  moment = PearsonDS::empMoments(p)
  parameters = PearsonDS::pearsonFitM(moments = moment)[2:5]
  purrr::lift_dl(PearsonDS::ppearsonI, q = c(min(p),max(p)))(parameters)%>% diff()
})
mean(R>0.95)
```

NhÆ° váº­y vá»›i tá»‰ lá»‡ pháº§n trÄƒm á»•n Ä‘á»‹nh dÆ°á»›i $10%$, ta cÃ³ thá»ƒ káº¿t luáº­n ráº±ng propensity score khÃ´ng á»•n Ä‘á»‹nh vá»›i cÃ¡c biáº¿n chÆ°a quan sÃ¡t.  









<!-- ################################################################################################### -->
***
# ğŸ“ _References_ {-}
<!-- :::: {.blackbox data-latex=""} -->
<!-- ::: {.center data-latex=""} -->
<!-- **Proof:** -->
<!-- ::: -->
<!-- over here -->
<!-- :::: -->
