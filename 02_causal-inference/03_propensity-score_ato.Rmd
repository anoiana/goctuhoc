---
title: "&#128205;Propensity Score I"
subtitle: '&#128205;The Average Treatment Effect for The Overlap Population (ATO) _(R)_'
author: ğŸ‘¦ğŸ» $\mathcal{An}$
date: "&#x1F4C5; _`r {
if(!file.exists('date_list.rds')){saveRDS(list(), file = 'date_list.rds')}
update=FALSE
filename=knitr::current_input(dir = FALSE)
mylist <- readRDS(file ='date_list.rds')
if(update|!(filename%in%names(mylist))){
mylist[[filename]]<- format(Sys.Date(),format = '%d-%m-%Y')
saveRDS(mylist, file = 'date_list.rds')}
readRDS(file ='date_list.rds')[[filename]]  }`_"
abstract: |
header-includes:
   - \usepackage{amsmath}
   - \usepackage{titling}
   - \pretitle{\begin{flushleft}}
   - \posttitle{\end{flushleft}}
   - \usepackage{eso-pic,graphicx,transparent}
output: 
    bookdown::html_document2:
      fig_caption: yes
      theme: default
      highlight: tango
      toc: true
      toc_float: 
        collapsed: false
      toc_depth: 3
      code_folding: hide
      css: "../00_supp/style.css"
      number_sections: true
      includes:
        in_header: "../00_supp/header.html"
        before_body: "test.html"
        after_body: "../00_supp/mycomment.html"
fontsize: 12pt
bibliography: ["citation.bib"]
csl: "../00_supp/apa.csl"
link-citations: true
editor_options: 
  chunk_output_type: console
---
 
```{css, echo = F}
/*----------LOGO above TOC---------*/

#TOC::before {
  content: "";
  display: block;
  height: 200px;
  margin: 2.75em 20px 40px 20px;
  background-image: url("casual.jpg");
  background-size: contain;
  background-position: center center;
  background-repeat: no-repeat;
}
```
::: {.watermark} 
_DRAFT_
:::

```{r child="../00_supp/general_rmd.Rmd"}
```

# Balancing Weight 

VÃ­ dá»¥ data cÃ³ ba biáº¿n $\{(Y(t),X,T): t = 0 \lor 1 \}$, trong Ä‘Ã³ $Y(t)$ lÃ  potential outcome cá»§a treatment $t$, $T$ lÃ  biáº¿n binary nháº­n duy nháº¥t 2 giÃ¡ trá»‹ $0$ vÃ  $1$ Ä‘áº¡i diá»‡n cho nhÃ³m control vÃ  treatment, cuá»‘i cÃ¹ng $X$ lÃ  confounders (giáº£ sá»­ cÃ³ duy nháº¥t 1 confouder), Ä‘á»ƒ dá»… hÃ¬nh dung ta cho $X$ thuá»™c biáº¿n rá»i ráº¡c. Äáº¡i lÆ°á»£ng ta muá»‘n Æ°á»›c lÆ°á»£ng lÃ  
$$
\tau(x) = \E[Y(1) - Y(0)|X=x],
(\#eq:eq1)
$$
gá»i lÃ  the _average treatment effect_ (ATE). 

DÆ°á»›i quy Æ°á»›c _unconfoundedness_ ta cÃ³ $Y(0), Y(1) \indep T|X$, vÃ¬ tháº¿ ta cÃ³ thá»ƒ viáº¿t láº¡i `r lb(eq1)` nhÆ° sau 
$$
\tau(x) = \E[Y(1)|T=1,X] - \E[Y(0)|T=0,X],
(\#eq:eq2)
$$
cÃ²n gá»i lÃ  _conditional average controlled difference_ (ACD).

Má»™t khÃ¡i niá»‡m ná»¯a ta cáº§n lÃ m quen lÃ  _quáº§n thá»ƒ má»¥c tiÃªu (target population)_ Ä‘á»ƒ chá»‰ quáº§n thá»ƒ ta muá»‘n Æ°á»›c lÆ°á»£ng. Náº¿u ta gá»i $\P(X=x)$ lÃ  probability mass function (PMF) cá»§a $X$ (lÆ°u Ã½ náº¿u X lÃ  liÃªn tá»¥c ta sáº½ cÃ³ probability density function (PDF) $f_X(x)$). Gá»i $h(x)$ lÃ  má»™t hÃ m sá»‘ cho trÆ°á»›c Ä‘á»ƒ quy Ä‘á»‹nh quáº§n thá»ƒ má»¥c tiÃªu. NghÄ©a lÃ  ta cÃ³ $P(X=x)h(x)$ chÃ­nh lÃ  PMF cá»§a quáº§n thá»ƒ má»¥c tiÃªu, tÃ¹y vÃ o Ä‘á»‹nh nghÄ©a cá»§a $h(x)$ ta sáº½ cÃ³ cÃ¡c quáº§n thá»ƒ má»¥c tiÃªu khÃ¡c nhau. Khi Ä‘Ã³ á»©ng vá»›i má»—i má»™t giÃ¡ trá»‹ cá»§a $x$ ta sáº½ tÃ­nh Ä‘Æ°á»£c má»™t giÃ¡ trá»‹ cá»§a $\tau(x)$. Ta cÃ³ ká»³ vá»ng cá»§a $\tau(x)$ lÃ  
$$
\begin{split}
\tau_h =  \frac{\sum_{i=1}^n \tau(x_i)\P(X=x_i)h(x_i)}{\sum_{i=1}^n\P(X=x_i)h(x_i)},~~~\textrm{(rá»i ráº¡c)};~~~
\tau_h = \frac{\int\tau(dx)f_X(x)h(x)\mu(dx)}{\int f_X(x)h(x)\mu(dx)},~~~ \textrm{(liÃªn tá»¥c)}
\end{split}
(\#eq:eq3)
$$
trong trÆ°á»ng há»£p rá»i ráº¡c ta cÃ³ thá»ƒ xem $\P(X=x)h(x) = w_i$ nhÆ° váº­y ta cÃ³ thá»ƒ viáº¿t láº¡i lÃ  $\tau_h = \frac{\sum \tau(x_i)w_i}{\sum w_i}$. 

CÃ¢u há»i Ä‘áº·c ra lÃ  lÃ m cÃ¡ch nÃ o Ä‘á»ƒ xÃ¡c Ä‘á»‹nh $\{w_i: i = 1,2,\dots,n\}$. Ta cÃ³ 

$$
\begin{split}
\P(X=x|T=1) &=  \frac{\P[T=1|X=x]\P(X=x)}{\P(T=1)}, ~~~~~\text{(cÃ´ng thá»©c Bayes)} \\
&\propto \P[T=1|X=x]\P(X=x) \\
&= e(x)\P(X=x)
\end{split}
(\#eq:eq4)
$$
tÆ°Æ¡ng tá»± 
$$
\P[X=x|T=0] \propto [1-e(x)]\P(X=x)
(\#eq:eq5)
$$

NhÆ° váº­y ta cÃ³ thá»ƒ xáº¥p xá»‰ Ä‘Æ°á»£c weight cá»§a cÃ¡c units nhÆ° sau 

$$
\begin{split}
&w_1(x) = \frac{1}{e(x)} = \frac{\P(X=x)h(x)}{\P(X=x)e(x)} = \frac{h(x)}{e(x)} \\
&w_0(x) = \frac{1}{e(x)} = \frac{\P(X=x)h(x)}{\P(X=x)(1-e(x))} = \frac{h(x)}{1-e(x)}
\end{split}
(\#eq:eq6)
$$

`r lb(eq6)` gá»i lÃ  _balancing weights_ vÃ¬ náº¿u ta weighting phÃ¢n bá»‘ cá»§a covariate $X$ báº±ng $w_1$ vÃ  $w_0$ thÃ¬ ta sáº½ cÃ³ phÆ°Æ¡ng trÃ¬nh sau 

$$
\P(X=x|T=1)w_1(x) = \P(X=x|T=0)w_0(x) = P(X=x)h(x),
$$
cÃ³ thá»ƒ nÃ³i ráº±ng phÃ¢n bá»‘ cá»§a covariate $X$ giá»¯a hai nhÃ³m Ä‘iá»u trá»‹ sáº½ cÃ¢n báº±ng sau khi  Ä‘Æ°á»£c Ä‘iá»u chá»‰nh láº¡i báº±ng $w_0$ vÃ  $w_1$.

NhÆ° Ä‘Ã£ nÃ³i lÃºc Ä‘áº§u báº±ng cÃ¡ch Ä‘á»‹nh nghÄ©a $h(x)$ ta cÃ³ thá»ƒ xÃ¡c Ä‘á»‹nh Ä‘Æ°á»£c target population. VÃ­ dá»¥ 

1. Náº¿u $h(x) = 1$ thÃ¬ target population chÃ­nh lÃ  population pha trá»™n giá»¯a treatment vÃ  control. NhÆ° váº­y ta cÃ³ weights vÃ  Ä‘áº¡i lÆ°á»£ng cá»§a hiá»‡u quáº£ Ä‘iá»u trá»‹ lÃ  
$$
\begin{split}
&\big[w_0,w_1\big] = \big[1/e(x), 1/1-e(x)\big] \\
&\tau^{ATE}= \E[Y(1) - Y(0)]
\end{split}
(\#eq:eq7)
$$ 
2. Trong khi Ä‘Ã³ náº¿u $h(x) = e(x)$ ta cÃ³ 
$$
\begin{split}
&\big[w_0,w_1\big] = \big[1, e(x)/1-e(x)\big], \\
&\tau^{ATT} = \E[Y(1) - Y(0)|T=1]
\end{split}
(\#eq:eq8)
$$
3. TÆ°Æ¡ng tá»± náº¿u $h(x) = 1- e(x)$ ta sáº½ cÃ³ target population lÃ  population cá»§a control ($T=0$). 
4. NgoÃ i ra $h(x)$ cÃ²n cÃ³ 1 sá»‘ dáº¡ng khÃ¡c, vÃ­ dá»¥ ta cÃ³ $h(x) = \I(q < e(x) < 1 -q), 0 < q < 1/2$, thÃ¬ ta cÃ³ subpopulation vá»›i Ä‘á»™ giá»‘ng nhau kháº£ thi cá»§a 2 nhÃ³m Ä‘iá»u trá»‹ á»Ÿ má»™t biáº¿n nÃ o Ä‘Ã³. 

Ta cÃ³ báº£ng sau [@li2017]

```{r fig1, fig.cap="$h(x)$ _vÃ  target population_", echo=FALSE}
d = tibble(
  `target population` = c("combined","treated","control","overlap","truncated combined","matching"),
  `h(x)` = c("$$1$$","$$e(x)$$", "$$1-e(x)$$", "$$e(x)(1-e(x))$$","$$\\mathbb{I}(q < e(x) < 1-q)$$", "$$\\min(e(x), 1-e(x))$$"),
  `estimand` = c("ATE","ATT","ATC","ATO","",""),
  `weight` = c("$$\\bigg(\\frac{1}{e(x)}, \\frac{1}{1-e(x)}\\bigg)$$",
               "$$\\bigg(1, \\frac{e(x)}{1-e(x)}\\bigg)$$",
               "$$\\bigg(\\frac{1-e(x)}{e(x)},1\\bigg)$$", 
               "$$(1-e(x),e(x))$$",
               "$$\\bigg(\\frac{\\mathbb{I}(q < e(x) < 1-q)}{e(x)}, \\frac{\\mathbb{I}(q < e(x) < 1-q)}{1-e(x)}\\bigg)$$",
               "$$\\bigg(\\frac{\\min(e(x),1-e(x))}{e(x)},\\frac{\\min(e(x),1-e(x))}{1-e(x)}\\bigg)$$")
)
draw_table(d, resizable = T,columns = list(
  `target population`= colDef(minWidth = 200), `h(x)` = colDef(minWidth = 200), 
  `estimand` = colDef(minWidth = 100), `weight` = colDef(minWidth = 400)
           )) 
```
Ä‘á»ƒ hiá»ƒu thÃªm vá» ATO, tham kháº£o @li2017.

# VÃ­ dá»¥ minh há»a

## Nháº¯c láº¡i má»™t sá»‘ Ä‘iá»ƒm quan trá»ng

Náº¿u má»—i bá»‡nh nhÃ¢n Ä‘Æ°á»£c chá»n `r colorize('_ngáº«u nhiÃªn_', color = 'red')` vÃ o má»™t trong hai nhÃ³m Ä‘iá»u trá»‹, active and control treatments, thÃ¬ ta sáº½ cÃ³ 
$$
Y(1),Y(0) \indep T
(\#eq:eq8001)
$$
vÃ¬ tháº¿ Ä‘áº¡i lÆ°á»£ng so sÃ¡nh mong muá»‘n lÃ  $\E[Y_i(1) - Y_i(0)]$ tÆ°Æ¡ng Ä‘Æ°Æ¡ng vá»›i 
$$
ATE = \E[Y|T=1] - \E[Y|T=0]
(\#eq:eq8002)
$$

Äá»‘i vá»›i nhá»¯ng observational data. khÃ´ng cÃ³ yáº¿u tá»‘ ngáº«u nhiÃªn, thÃ¬ `r lb(eq8001)` khÃ´ng cÃ²n Ä‘Ãºng, nÃªn `r lb(eq8002)` khÃ´ng thá»ƒ sá»­ dá»¥ng. 

PhÆ°Æ¡ng phÃ¡p giáº£i quyáº¿t lÃ   máº·c dÃ¹ `r lb(eq8001)` khÃ´ng Ä‘Ãºng,  nhÆ°ng ta cÃ³ thá»ƒ giáº£ sá»­ ráº±ng trong má»—i subpopulation Ä‘Æ°á»£c chia bá»Ÿi cÃ¡c confounders thÃ¬ `r lb(eq8001)` cÃ³ thá»ƒ Ä‘Ãºng, nghÄ©a lÃ  
$$
Y(1), Y(0) \indep T|X
(\#eq:eq8003)
$$

Ta Ä‘á»‹nh nghÄ©a $e(x_i) = \P[T_i=1|X_i=x_i]$, xÃ¡c suáº¥t má»™t bá»‡nh nhÃ¢n Ä‘Æ°á»£c xáº¿p vÃ o nhÃ³m active treatment dÆ°á»›i Ä‘iá»u kiá»‡n cá»§a confounder $X$, thÃ¬ bá»Ÿi vÃ¬ ta cÃ³ thá»ƒ chá»©ng minh Ä‘Æ°á»£c ráº±ng $e(X)$ lÃ  Æ°á»›c lÆ°á»£ng Ä‘áº§y Ä‘á»§ (sufficient statistic) cá»§a $X$, nghÄ©a lÃ  $\E[Y(t)|X,e(X)] = \E[Y(t)|e(X)]$, nÃªn ta sá»­ dá»¥ng $e(X)$ Ä‘á»ƒ tÃ­nh ATE. NhÆ° váº­y, ta cÃ³ thá»ƒ Æ°á»›c lÆ°á»£ng ATE nhÆ° sau 

$$
\hat{ATE} = \frac{1}{n}\sum_{i=1}^n \frac{T_iY_i}{e(X_i)} - \frac{1}{n}\sum_{i=1}^n \frac{(1-T_i)Y_i}{1-e(X_i)}
(\#eq:eq8004)
$$
hoáº·c lÃ  

$$
\hat{ATE} = \bigg[\sum_{i=1}^n\frac{T_i}{e(X_i)}\bigg]^{-1}\sum_{i=1}^n \frac{T_iY_i}{e(X_i)} - \bigg[\sum_{i=1}^n\frac{1-T_i}{1-e(X_i)}\bigg]^{-1}\sum_{i=1}^n \frac{(1-T_i)Y_i}{1-e(X_i)}
(\#eq:eq8005)
$$
`r lb(eq8004)` tÆ°Æ¡ng á»©ng vá»›i combined target population trong `r lb(fig1)`.

Tiáº¿p theo ta cáº§n Æ°á»›c lÆ°á»£ng $\hat{e}(X)$, á»©ng viÃªn Ä‘áº§u tiÃªn lÃ  sá»­ dá»¥ng logistic model vá»›i biáº¿n phá»¥ thuá»™c chÃ­nh lÃ  treatment $T$. NhÆ° váº­y, cÃ¢u há»i cÃ²n láº¡i lÃ  model sáº½ bao gá»“m bao nhiÃªu biáº¿n Ä‘á»™c láº­p?! BÆ°á»›c nÃ y khÃ¡ quan trá»ng vÃ¬ náº¿u model ta chá»n khÃ´ng tá»‘t lÃ  Æ°á»›c lÆ°á»£ng $\hat{e}(X)$ sáº½ biased, vÃ  nhÆ° tháº¿ Æ°á»›ng lÆ°á»£ng $\hat{ATE}$ cÅ©ng sáº½ biased. Ta cÃ³ thá»ƒ sá»­ dá»¥ng nhá»¯ng phÆ°Æ¡ng phÃ¡p trong model selection thÃ´ng qua cÃ¡c thuáº­t toÃ¡n cá»§a machine learning nhÆ° decision trees, boosting, random forest... Ä‘á»ƒ tÃ¬m ra nhá»¯ng biáº¿n Ä‘á»™c láº­p nÃ o tháº­t sá»± quan trá»ng Ä‘á»‘i vá»›i treatment $T$.  NgoÃ i ra ta cÅ©ng cÃ³ thá»ƒ sá»­ dá»¥ng cÃ¡c phÆ°Æ¡ng phÃ¡p trong bayes model selection. 

BÃªn cáº¡nh Ä‘Ã³ ta cáº§n nhá»¯ng Ä‘áº¡i lÆ°á»£ng Ä‘á»ƒ Ä‘Ã¡nh giÃ¡ Ä‘á»™ cÃ¢n báº±ng cá»§a hai nhÃ³m treatments trÆ°á»›c vÃ o sau khi weighting. TÃ¹y vÃ o biáº¿n liÃªn tá»¥c hay rá»i ráº¡c mÃ  ta láº§n lÆ°á»£t cÃ³ cÃ´ng thá»©c sau

$$
\begin{split}
&d = 100\times\frac{\bar{X}_t - \bar{X}_c}{\sqrt{\frac{s^2_t + s^2_c}{2}}} \\
&d = 100\times\frac{\hat{p}_t - \hat{p}_c}{\sqrt{\frac{\hat{p}_t(1-\hat{p}_t)+\hat{p}_c(1-\hat{p}_c)}{2}}}
\end{split}
(\#eq:eq8006)
$$
Ä‘á»‘i vá»›i cÃ¡c confounders trÆ°á»›c khi weighting ta tÃ­nh $\bar{X}$ vÃ  $\hat{p}$ nhÆ° bÃ¬nh thÆ°á»ng, nhÆ°ng sau khi weighting vÃ  cÃ³ $\hat{e}(X)$ thÃ¬ ta pháº£i sá»­ dá»¥ng weighted mean vÃ  weighted proportion. LÆ°u Ã½ 2 cÃ´ng thá»©c trÃªn khÃ¡c vá»›i t-statistic lÃ  khÃ´ng phá»¥ thuá»™c vÃ o kÃ­ch cá»¡ máº«u. Khi code ta chá»‰ cáº§n Ä‘á»‹nh nghÄ©a hÃ m tÃ­nh weighted mean, weighted variance vÃ  weighted proportion, Ä‘á»‘i vá»›i trÆ°á»ng há»£p trÆ°á»›c weighting, ta chá»n $w_i=1$ vá»›i $i = 1,2,\dots,n$. 

## R codes

Data sá»­ dá»¥ng trong pháº§n minh há»a nÃ y chÃ­nh lÃ  `lalonde` trong package `cobalt`. Táº¥t cáº£ nhá»¯ng thao tÃ¡c vÃ  káº¿t quáº£ Ä‘á»u cÃ³ thá»ƒ dá»ƒ dÃ ng tÃ­nh toÃ¡n báº±ng cÃ¡ch sá»­ dá»¥ng packages, tuy nhiÃªn Ä‘á»ƒ hiá»ƒu rÃµ cÆ¡ cáº¥u cá»§a tá»«ng thao tÃ¡c ta sáº½ tiáº¿n hÃ nh viáº¿t code, sau Ä‘Ã³ thÃ¬ sáº½ so sÃ¡nh káº¿t quáº£ vá»›i cÃ¡c hÃ m trong packages. 

```{r fig2, fig.cap="_data `lalonde` vá»›i outcome `re78`, treatment `treat` vÃ  7 covariates trong Ä‘Ã³ 3 discrete vÃ  4 continuous types_"}
# installing required packages
if(!require(pacman)) install.packages("pacman");pacman::p_load(
cobalt, tidyverse, magrittr, reactable
)
# loading data
data('lalonde', package = 'cobalt')
# modify used set and assign to 'dat'
dat = tibble(lalonde)%>%
  mutate(across(race, ~as.numeric(.)-1))
# draw table to show complete dataset
draw_table(lalonde) # (from helper function list)
```

Dá»±a vÃ o `r lb(fig2)` ta cÃ³  7 covariates trong Ä‘Ã³ 3 categorical variables lÃ  race, married vÃ  nodegree, cÃ²n 4 continuous variables lÃ  age, educ, re74 vÃ  re75. Äá»ƒ Ä‘Æ¡n giáº£n ta sáº½ chia ra lÃ m 2 dataset dá»±a vÃ o tá»«ng loáº¡i biáº¿n.

```{r}
results = list() # all results will be stored here
x.cont = dplyr::select(dat, age,educ,re74,re75, treat) # continuous variables
x.disc = dplyr::select(dat,race,married,nodegree, treat) # discrete variables
```

Äáº§u tiÃªn ta kiá»ƒm tra cÃ¡c covariates báº±ng cÃ¡c Ä‘áº¡i lÆ°á»£ng thá»‘ng kÃª bao gá»“m ká»³ vá»ng, phÆ°Æ¡ng sai cá»§a biáº¿n liÃªn tá»¥c vÃ  tá»‰ lá»‡ phÃ¢n nhÃ³m cá»§a biáº¿n rá»i ráº¡c. 

```{r fig3, fig.cap = "_Ä‘Ã¡nh giÃ¡ cÃ¡c biáº¿n pretreatment_"}

# eval pretrt cont vars
d_cont<-
group_nest(x.cont, treat)%>%
  mutate(stat = map(data, ~summarise_all(., list(mean =mean,sd = sd))%>% modify(round, digits =2)%>%
                      {map2_df(.[,1:4],.[5:8], ~ str_c(.x," (",.y,")"))}%>%
                      pivot_longer(everything(), names_to = "var", values_to = "stat")%>%
                      mutate(var = str_remove_all(var,"_mean"))
  ))%$%{`names<-`(stat, treat)}
  

# eval pretrt disc vars
f = function(x, name = NULL){
  lift_dv(tibble)(table(x, useNA = "ifany"))%>% 
    pivot_longer(everything(),names_to = "group", values_to = "n")%>%
    mutate(p = round(n*100/sum(n),2) )%>%
    mutate(stat = paste0(n," (",p,"%",")"), .keep= 'unused')%>%
    mutate(var = str_c(' \u00a0 \u00a0',group), .keep = "unused", .before =1)%>%
    add_row(var = name, .before = 1)
}
d_disc<-
  group_nest(x.disc,treat)%>%
  mutate(data = `names<-`(data, treat))%>%
  mutate(data = map(data, ~ imap_dfr(., ~f(.x,.y)) ))%$% data

# combine both cont & disc cases
d = map2(d_cont,d_disc, bind_rows)%>%
  imap(~rename(.x, !!{{str_c("stat of treatment ",.y)}} := stat))%>%
  {bind_cols(.[[1]],.[[2]][,-1])}%>%
  mutate_all(~ ifelse(is.na(.),"",.) )

# draw table
draw_table(d, defaultPageSize = nrow(d))
```

Tiáº¿p theo ta tÃ­nh Ä‘á»™ giá»‘ng nhau giá»¯a 2 nhÃ³m Ä‘iá»u trá»‹. Ta cÃ³ thá»ƒ báº¯t Ä‘áº§u tá»« raw-data nhÆ° trong `r lb(fig2)` Ä‘á»ƒ tÃ­nh. Tuy nhiÃªn á»Ÿ Ä‘Ã¢y ta sáº½ sá»­ dá»¥ng sá»‘ liá»‡u tá»« `r lb(fig3)` Ä‘á»ƒ tÃ­nh, lÆ°u Ã½ data nÃ y bao gá»“m cÃ¡c biáº¿n dáº¡ng character, Ä‘á»ƒ tÃ­nh toÃ¡n ta cáº§n trÃ­ch lá»c sá»‘ liá»‡u cáº§n thiáº¿t vÃ  biáº¿n Ä‘á»•i thÃ nh numeric. 

```{r fig4, fig.cap="_ÄÃ¡nh giÃ¡ Ä‘á»™ khÃ¡c biá»‡t giá»¯a hai nhÃ³m Ä‘iá»u trá»‹_"}

f1<- function(x){
map_if(x, ~str_detect(.,"%"),
       ~(str_extract_all(., "(?<=\\().+(?=%)")[[1]])%>% {as.numeric(.)/100},
       .else =~(str_extract_all(., "[:digit:]+\\.*[:digit:]+(?= )")[[1]])%>%
         as.numeric()
       )%>%
  map_dbl(~ifelse(identical(.,numeric(0)),NA,. ))
}

f2 = function(x){
  map_if(x, ~str_detect(.,"%"),
       ~(str_extract_all(., "(?<=\\().+(?=%)")[[1]])%>% {as.numeric(.)/100}%>%{.*(1-.)/429},
       .else =~(str_extract_all(., "(?<=\\().+(?=\\))")[[1]])%>%
         {as.numeric(.)^2/2}
       )%>%
  map_dbl(~ifelse(identical(.,numeric(0)),NA,. ))
}

d2<-
mutate(d, m1 = f1(`stat of treatment 0`), m2 = f1(`stat of treatment 1`),
       v1 = f2(`stat of treatment 0`), v2 = f2(`stat of treatment 1`)
       )%>%
  mutate(difference = (m1-m2)/sqrt(v1+v2)  )


draw_table(d2[,c(1,2,3,8)]%>% modify_if(is.numeric, round, digits = 3), defaultPageSize = nrow(d2),
           defaultColDef = colDef(
    style = function(value) {
      if (!is.numeric(value)) return()
      list(color = "red")
    })
           )
```

Cá»™t mÃ u Ä‘á» trong `r lb(fig4)` cÅ©ng Ä‘Æ°á»£c hiá»ƒu lÃ  Ä‘Ã¡nh giÃ¡ Ä‘á»™ cÃ¢n báº±ng táº¡i first moment ($\E(X)$), ta cung cÃ³ thá»ƒ Ä‘Ã¡nh giÃ¡ Ä‘á»™ cÃ¢n báº±ng á»Ÿ má»©c second moment $(\E(X^2))$ thÃ´ng qua phÆ°Æ¡ng sai báº±ng cÃ´ng thá»©c sau 

$$
\hat{\Gamma} = \ln(\hat{\sigma}_t) - \ln(\hat{\sigma}_c)
$$
nhÆ° váº­y ta cÃ³ 


```{r fig5, fig.cap="_ÄÃ¡nh giÃ¡ cÃ¢n báº±ng á»Ÿ má»©c first vÃ  second moment_"}

d3<- mutate(d2, "$$\\hat{\\Gamma}$$" = log(v1/v2))
draw_table(modify_if(d3[,c(1,2,3,8,9)],is.numeric,round, digits =3), defaultPageSize = nrow(d2), defaultColDef = colDef(
    style = function(value) {
      if (!is.numeric(value)) return()
      list(color = "red")
    }))
```

BÃ¢y giá» ta sáº½ tiáº¿n hÃ nh Æ°á»›c lÆ°á»£ng PS báº±ng logistic model, vÃ  sá»­ dá»¥ng cÃ´ng thá»©c tÃ­nh _weight_ cá»§a ATO trong `r lb(fig1)` (cÃ¡c dáº¡ng weight khÃ¡c cÃ³ thá»ƒ láº§n lÆ°á»£t sá»­ dá»¥ng vÃ  so sÃ¡nh káº¿t quáº£. Nhá»› ráº±ng má»¥c tiÃªu cá»§a ta lÃ  lÃ m sao Ä‘á»ƒ phÃ¢n bá»‘ cá»§a cÃ¡c biáº¿n trong hai nhÃ³m Ä‘iá»u trá»‹ pháº£i Ã­t khÃ¡c biá»‡t nháº¥t cÃ³ thá»ƒ. NhÆ° váº­y phÆ°Æ¡ng phÃ¡p nÃ o Ä‘Æ°a Ä‘áº¿n sá»± cÃ¢n báº±ng tá»‘i Ä‘a giá»¯a hai nhÃ³m Ä‘iá»u trá»‹ thÃ¬ Ä‘Ã³ lÃ  phÆ°Æ¡ng phÃ¡ phiá»‡u quáº£.). Ta sáº½ thá»±c hiá»‡n bÆ°á»›c nÃ y báº±ng hai cÃ¡ch, thá»© nháº¥t ta thá»±c hiá»‡n báº±ng cÃ¡ch fit logistic model vÃ  thá»© hai ta sáº½ sá»­ dá»¥ng packages `WeightIt`. 

```{r fig6, fig.cap="_káº¿t quáº£ cá»§a weight Ä‘Æ°á»£c tÃ­nh báº±ng hai cÃ¡ch_"}
#using package
dat = mutate(dat,across(.cols = c(treat,race,married,nodegree),factor))
ps = WeightIt::weightit(treat~age+educ+race+married+nodegree+re74+re75, data = dat,
                        estimand = "ATO", method = "ps")

# manual
fit = glm(treat~age+educ+race+married+nodegree+re74+re75, data = dat, family = binomial())
mytreat = as.numeric(dat$treat)-1
#w= mytreat/fit$fitted.values + (1-mytreat)/(1-fit$fitted.values)
w = mytreat*(1-fit$fitted.values) + (1-mytreat)*fit$fitted.values
draw_table(
  tibble(`khÃ´ng sá»­ dá»¥ng package` = w,`sá»­ dá»¥ng package` = ps$weights)%>% modify(round, digits = 2)
             )
```

Dá»±a vÃ o `r lb(fig6)` ta tháº¥y ráº±ng weights Ä‘Æ°á»£c tÃ­nh báº±ng hai cÃ¡ch lÃ  giá»‘ng nhau. Tiáº¿p theo ta sáº½ tÃ­nh láº¡i cÃ¡c Ä‘Ã¡nh giÃ¡ cÃ¢n báº±ng dá»±a trÃªn PS vá»«a tÃ­nh Ä‘Æ°á»£c. Tuy nhiÃªn Ä‘á»ƒ tiá»‡n so sÃ¡nh cÃ¡c há»‡ sá»‘ cÃ¢n báº±ng dá»±a trÃªn cÃ¡c PS khÃ¡c nhau ta sáº½ viáº¿t má»™t generic function nhÆ° sau 

```{r fig7, fig.cap="_ÄÃ¡nh giÃ¡ Ä‘á»™ khÃ¡c biá»‡t sau khi bá»• sung PS_"}
balancing = function(x.cont, x.disc,w){
  
  ess = round(sum(w)^2/sum(w^2))
  w = w*ess/sum(w)
  
  # continuous 
  x.cont1<- bind_cols(x.cont, w = w)
d_cont<-
group_nest(x.cont1, treat)%>%
  mutate(stat = map(data, ~summarise_all(., list(mean =~weighted.mean(.,w),sd = ~sqrt(Hmisc::wtd.var(.,w)))) %>% modify(round, digits =2)%>%
                      {map2_df(dplyr::select(., contains("mean")),dplyr::select(.,contains("sd")), ~ str_c(.x," (",.y,")"))}%>%
                      pivot_longer(everything(), names_to = "var", values_to = "stat")%>%
                      mutate(var = str_remove_all(var,"_mean"))
  ))%$%{`names<-`(stat, treat)}


# discrete
f = function(x, name = NULL,w){
  
  tibble(group = x, w = w)%>%
    group_by(group)%>%
    summarise(n = round(sum(w)))%>%
    mutate(p = round(n*100/sum(n),2) )%>%
    mutate(stat = paste0(n," (",p,"%",")"), .keep= 'unused')%>%
    mutate(var = str_c(' \u00a0 \u00a0',group), .keep = "unused", .before =1)%>%
    add_row(var = name, .before = 1)
}
x.disc1<- bind_cols(x.disc, w= w)
d_disc<-
  group_nest(x.disc1,treat)%>%
  mutate(data = `names<-`(data, treat))%>%
  mutate(data = map(data, ~{
    x = .
    imap(dplyr::select(x,-w), ~f(.x,.y,w = x$w))%>% bind_rows()
    })) %$% data

d = map2(d_cont,d_disc, bind_rows)%>%
  imap(~rename(.x, !!{{str_c("stat of treatment ",.y)}} := stat))%>%
  {bind_cols(.[[1]],.[[2]][,-1])}%>%
  mutate_all(~ ifelse(is.na(.),"",.) )
#--------------------------------------------
f1<- function(x){
map_if(x, ~str_detect(.,"%"),
       ~(str_extract_all(., "(?<=\\().+(?=%)")[[1]])%>% {as.numeric(.)/100},
       .else =~(str_extract_all(., "[:digit:]+\\.*[:digit:]+(?= )")[[1]])%>%
         as.numeric()
       )%>%
  map_dbl(~ifelse(identical(.,numeric(0)),NA,. ))
}

f2 = function(x){
  map_if(x, ~str_detect(.,"%"),
       ~(str_extract_all(., "(?<=\\().+(?=%)")[[1]])%>% {as.numeric(.)/100}%>%{.*(1-.)/429},
       .else =~(str_extract_all(., "(?<=\\().+(?=\\))")[[1]])%>%
         {as.numeric(.)^2/2}
       )%>%
  map_dbl(~ifelse(identical(.,numeric(0)),NA,. ))
}
d2<-
mutate(d, m1 = f1(`stat of treatment 0`), m2 = f1(`stat of treatment 1`),
       v1 = f2(`stat of treatment 0`), v2 = f2(`stat of treatment 1`)
       )%>%
  mutate(difference = (m1-m2)/sqrt(v1+v2)  )

d3<- mutate(d2, "$$\\hat{\\Gamma}$$" = log(v1/v2))
return(filter(d3, var!= "w"))
}

d3<-balancing(x.cont, x.disc, w = w)

draw_table(modify_if(d3[,c(1,2,3,8,9)],is.numeric,round, digits =3), defaultPageSize = nrow(d2), defaultColDef = colDef(
    style = function(value) {
      if (!is.numeric(value)) return()
      list(color = "red")
    }))
```

Dá»±a vÃ o `r lb('fig7')` ta tháº¥y ráº±ng dÆ°á»›i áº£nh hÆ°á»Ÿng cá»§a PS, phÃ¢n bá»‘ cá»§a cÃ¡c biáº¿n trÆ°á»›c thÃ­ nghiá»‡m cá»§a hai nhÃ³m Ä‘iá»u trá»‹ hoÃ n toÃ n giá»‘ng nhau á»Ÿ moment Ä‘áº§u tiÃªn. Ta cÅ©ng cÃ³ thá»ƒ sá»­ dá»¥ng package `cobalt` Ä‘á»ƒ Ä‘Ã¡nh giÃ¡ Ä‘á»™ cÃ¢n báº±ng

```{r}
bal.tab(treat ~ age+ educ+ race+ married+ nodegree+ re75+ re75, data = dat, weights = w)
```

Trong káº¿t quáº£ trÃªn ta cÃ³ thÃªm má»™t Ä‘áº¡i lÆ°á»£ng ná»¯a lÃ  effective sample size (ESS), Ä‘áº¡i lÆ°á»£ng nÃ y cho ta biáº¿t kÃ­ch cá»¡ máº«u tÆ°Æ¡ng Ä‘Æ°Æ¡ng trong thá»±c táº¿ khi mÃ  phÃ¢n bá»‘ cá»§a cÃ¡c covariates giá»¯a hai nhÃ³m Ä‘iá»u trá»‹ Ä‘Æ°á»£c cÃ¢n báº±ng. RÃµ rÃ ng Ä‘á»ƒ cÃ¢n ráº±ng, thÃ¬ kÃ­ch cá»¡ máº«u Ä‘Ã£ giáº£m tá»« $614$ xuá»‘ng $311$.
Äiá»u nÃ y cÃ³ thá»ƒ hiá»ƒu lÃ  sau khi cÃ¢n báº±ng, má»™t sá»‘ cÃ¡c bá»‡nh nhÃ¢n cÃ³ khÃ¡c biá»‡t quÃ¡ lá»›n giá»¯a hai nhÃ³m Ä‘iá»u trá»‹ Ä‘Ã£ Ä‘Æ°á»£c loáº¡i bá». CÃ´ng thá»©c cá»§a ESS lÃ  
$$
ESS = \frac{\Big(\sum_{i=1}^n w_i\Big)^2}{\sum_{i=1}^n w_i^2}.
$$

NhÆ° váº­y, bÆ°á»›c cÃ²n láº¡i chÃ­nh lÃ  phÃ¢n tÃ­ch Ä‘á»ƒ so sÃ¡nh hai nhÃ³m Ä‘iá»u trá»‹. Sá»­ dá»¥ng `r lb('eq8004')` hoáº·c `r lb('eq8005')` Ä‘á»ƒ Æ°á»›c lÆ°á»£ng hiá»‡u quáº£ Ä‘iá»u trá»‹ vÃ  Ä‘Æ°a ra káº¿t luáº­n.  

# Káº¿t Luáº­n 

TrÃªn Ä‘Ã¢y ta chá»‰ sá»­ dá»¥ng cÃ¡c bÆ°á»›c Ä‘Æ¡n giáº£n vÃ  phá»• biáº¿n nháº¥t Ä‘á»ƒ tÃ¬m propensity score. Trong thá»±c táº¿ viá»‡c xÃ¡c Ä‘á»‹nh model Ä‘á»ƒ Æ°á»›c lÆ°á»£ng PS Ä‘Ã²i há»i nhiá»u ká»¹ nÄƒng hÆ¡n trong model selection vÃ  model evaluation. NgoÃ i ra cÅ©ng cÃ³ nhiá»u nghiÃªn cá»©u Ä‘Ã£ chá»‰ ra cÃ¡c Æ°u tháº¿ khi sá»­ dá»¥ng cÃ¡c phÆ°Æ¡ng phÃ¡p trong machine learning Ä‘á»ƒ Æ°á»›c lÆ°á»£ng PS, tuy nhiÃªn ta sáº½ khÃ´ng Ä‘i sÃ¢u vÃ o cÃ¡c phÆ°Æ¡ng phÃ¡p cá»¥ thá»ƒ nÃ y. NgoÃ i ra cÃ¡c bÆ°á»›c phÃ¢n tÃ­ch sensitivity sau khi Ä‘Ã£ cÃ³ Æ°á»›c lÆ°á»£ng cá»§a PS cÅ©ng ráº¥t quan trá»ng, ta sáº½ tÃ¬m hiá»ƒu má»™t vÃ i phÆ°Æ¡ng phÃ¡p cá»¥ thá»ƒ á»Ÿ nhá»¯ng bÃ i sau. 
































<!-- ################################################################################################### -->
<!-- \stackrel{}{} -->

# ğŸ“ __*Reference & Appendix*__ { - .tabset .tabset-pills}

## References {-}

`r bring_rf_here()`

## Appendix {-}

Trong pháº§n nÃ y ta sáº½ cÃ³ hai Ä‘iá»ƒm cáº§n chá»©ng minh nhÆ° sau 

1. Æ°á»›c lÆ°á»£ng $\hat{\tau}_h$ cá»§a $\tau_h$ lÃ  má»™t Æ°á»›c lÆ°á»£ng vá»¯ng, nghÄ©a lÃ  $\E(\hat{\tau}_h) = \tau_h$.
2. Khi kÃ­ch cá»¡ máº«u Ä‘áº¡t tá»›i lÃ½ tÆ°á»Ÿng $(n \to \infty)$ thÃ¬ ká»³ vá»ng cá»§a phÆ°Æ¡ng sai cá»§a Æ°á»›c lÆ°á»£ng $\hat{\tau}_t$ lÃ  má»™t giÃ¡ trá»‹ xÃ¡c Ä‘á»‹nh, nghÄ©a lÃ  $\lim_{n \to \infty}\E[\V(\hat{\tau}_h)] < \infty$. 

:::: {.blackbox}
__Chá»©ng minh ráº±ng $\E(\hat{\tau}_h) = \tau_h$__

Tá»« `r lb(eq3)` ta cÃ³  
$$
\begin{split}
\tau_h 
&=  \frac{\sum_{i=1}^n \tau(x_i)\P(X=x_i)h(x_i)}{\sum_{i=1}^n\P(X=x_i)h(x_i)} \\
&= \frac{\sum_{i=1}^n\Big[\E[Y(1)|X] - \E[Y(0)|X]\Big]\P(X=x_i)h(x_i)}{\sum_{i=1}^n\P(X=x_i)h(x_i)}
\end{split}
$$

Äáº§u tiÃªn ta xÃ©t pháº§n tá»­ sá»‘ 
$$
\begin{split}
&\sum_{i=1}^n\Big[\E[Y(1)|X] - \E[Y(0)|X]\Big]\P(X=x_i)h(x_i) \\
&\stackrel{(1)}{=} \sum_{i=1}^n \Big[\E[Y(1)|T=1,X] - \E[Y(0)|T=0,X]\Big]\P(X=x_i)h(x_i) \\ 
&\stackrel{(2)}{=}  \sum_{i=1}^n \Bigg[ \frac{\E[Y(1)T|X]\P(X=x_i)h(x_i)}{e(x_i)} - \frac{\E[Y(0)(1-T)|X]\P(X=x_i)h(x_i)}{1-e(x_i)}\Bigg]
\end{split}
$$
trong Ä‘Ã³ 

- (1): sá»­ dá»¥ng quy Æ°á»›c unconfoundedness.
- (2): Ta cÃ³ $\E(Y|T,X) = \frac{\E(YT|X)}{\P(T|X)} = \frac{\E(YT|X)}{e(X)}$

Tiáº¿p theo xÃ©t pháº§n máº«u sá»‘. Ta biáº¿n Ä‘á»•i giá»‘ng nhÆ° pháº§n tá»­ sá»‘ vá»›i $Y(1) = 1$, ta cÃ³ 

$$
\begin{split}
&\sum_{i=1}^n\P(X=x_i)h(x_i) = \sum_{i=1}^n \frac{\E[T|X]\P(X=x_i)h(x_i)}{e(x_i)}, ~~~\text{(treatment)} \\
&\sum_{i=1}^n\P(X=x_i)h(x_i) = \sum_{i=1}^n \frac{\E[1-T|X]\P(X=x_i)h(x_i)}{1-e(x_i)}, ~~~\text{(control)}
\end{split}
$$

NhÆ° váº­y ta cÃ³ thá»ƒ ghi láº¡i lÃ  

$$
\tau_h = \frac{\sum_{i=1}^n \frac{\E[Y(1)T|X]\P(X=x_i)h(x_i)}{e(x_i)}}{\sum_{i=1}^n \frac{\E[T|X]\P(X=x_i)h(x_i)}{e(x_i)}} - \frac{\sum_{i=1}^n \frac{\E[Y(1)(1-T)|X]\P(X=x_i)h(x_i)}{1-e(x_i)}}{\sum_{i=1}^n \frac{\E[1-T|X]\P(X=x_i)h(x_i)}{1-e(x_i)}}
(\#eq:eq9)
$$
Ta sáº½ viáº¿t cÃ¡c ká»³ vá»ng á»Ÿ dáº¡ng trá»‹ sá»‘ trung bÃ¬nh vÃ  thay $\frac{h(x)}{e(x)} = w_1(x)$ vÃ  $\frac{h(x)}{1-e(x)} = w_0(x)$, ta cÃ³ 

$$
\begin{split}
&\bullet \sum_{i=1}^n \frac{\E[Y(1)T|X]\P(X=x_i)h(x_i)}{e(x_i)} &&= \sum_{i=1}^n \E[Y(1)Tw_1(x_i)|X]\P(X=x_i) = \E\Big[\E[Y(1)Tw_1(x_i)|X]\Big] \\
&&& = \E(Y(1)Tw_1(x_i))  = n\sum_{i=1}^n Y(1)Tw_1(x_i) \\
&\bullet \sum_{i=1}^n \frac{\E[T|X]\P(X=x_i)h(x_i)}{e(x_i)} &&= n\sum_{i=1}^nTw_1(x_i) \\
&\bullet\sum_{i=1}^n \frac{\E[Y(0)T|X]\P(X=x_i)h(x_i)}{1-e(x_i)} &&= \sum_{i=1}^n \E[Y(0)Tw_0(x_i)|X]\P(X=x_i) = \E\Big[\E[Y(0)Tw_0(x_i)|X]\Big] \\
&&& = \E(Y(0)Tw_0(x_i))  = n\sum_{i=1}^n Y(0)Tw_0(x_i) \\
&\bullet \sum_{i=1}^n \frac{\E[T|X]\P(X=x_i)h(x_i)}{1-e(x_i)} &&= n\sum_{i=1}^nTw_0(x_i) \\
\end{split}
$$
nhÆ° váº­y 
$$
\hat{\tau}_h = \frac{\sum_{i=1}^n Y_i(1)T_iw_1(x_i)}{\sum_{i=1}^n T_iw_1(x_i)} - \frac{\sum_{i=1}^n Y_i(0)T_iw_0(x_i)}{\sum_{i=1}^n T_iw_0(x_i)}
(\#eq:eq10)
$$
`r rs('\\square')`
::::

:::: {.blackbox}

__Chá»©ng minh ráº±ng $\lim_{n \to \infty}\E[\V(\hat{\tau}_h|X)] < \infty$__

Ta sáº½ báº¯t Ä‘áº§u tá»« `r lb(eq10)` báº±ng cÃ¡ch tÃ­nh phÆ°Æ¡ng sai cá»§a $\hat{\tau}_h|T,X$, ta cÃ³ 
$$
\begin{split}
\V[\hat{\tau}_h|X,T] &= \frac{\sum_{i=1}^n\vartheta_1(x_i)T_iw^2_1(x_i)}{\Big[\sum_{i=1}^nT_iw_1(x_i)\Big]^2} - \frac{\sum_{i=1}^n\vartheta_0(x_i)T_iw^2_0(x_i)}{\Big[\sum_{i=1}^nT_iw_0(x_i)\Big]^2}
\end{split}
(\#eq:eq11)
$$

Ta sáº½ xem xÃ©t phÃ¢n thá»©c thá»© nháº¥t á»Ÿ váº¿ pháº£i cá»§a `r lb(eq11)`, phÃ¢n thá»©c cÃ²n láº¡i Ä‘Æ°á»£c biáº¿n Ä‘á»•i tÆ°Æ¡ng tá»±, ta cÃ³ 

$$
\begin{split}
\frac{\sum_{i=1}^n\vartheta_1(x_i)T_iw^2_1(x_i)}{\Big[\sum_{i=1}^nT_iw_1(x_i)\Big]^2} &= \frac{\sum_{i=1}^n\vartheta_1(x_i)T_iw^2_1(x_i)\Big/n}{n\Big[\frac{1}{n}\sum_{i=1}^nT_iw_1(x_i)\Big]^2} 
\end{split}
$$

Äáº§u tiÃªn ta xem xÃ©t pháº§n tá»­ sá»‘ 
$$
\begin{split}
\sum_{i=1}^n\vartheta_1(x_i)T_iw^2_1(x_i)\Big/n &\rightarrow
\E\big[\vartheta_1(x_i)T_iw^2_1(x_i)\big] \\ &= \E\Big[\E\big[\frac{\vartheta_1(x_i)}{e(x_i)}\frac{T_i}{e(x_i)}h^2(x_i)\big|X \big]\Big]\\ &= 
\E\Big[\frac{\vartheta_1(x_i)}{e(x_i)}h^2(x_i)\E\big[T_i/e(x_i)\big]\Big] \\ &=
\E\Big[\frac{\vartheta_1(x_i)}{e(x_i)}h^2(x_i)\Big] \\ &=
\int\frac{\vartheta_1(x)}{e(x)}h^2(x)f(x)\mu(dx).
\end{split}
$$

Tiáº¿p theo xem xÃ©t máº«u sá»‘, ta cÃ³ 
$$
\begin{split}
\Big[\frac{1}{n}\sum_{i=1}^nT_iw_1(x_i)\Big]^2 &\rightarrow 
\big\{\E[T_iw_1(x_i)]\big\}^2\\ &= 
\Bigg\{\E\Big[\E\Big(\frac{T_i}{e(x_i)}h(x_i)\Big|X\Big)\Big]\Bigg\}^2 \\ &=
\Bigg\{\E\Big[h(x_i)\E\Big(\frac{T_i}{e(x_i)}\Big)    \Big]  \Bigg\}^2 \\ &=
\Big\{\E[h(x_i)]  \Big\}^2 \\ &=
\Big\{\int h(x)f(x)\mu(dx)\Big\}^2 \\ &=
C_h^2
\end{split}
$$

NhÆ° váº­y theo Slutsky's theorem ta cÃ³:

$$
\frac{\sum_{i=1}^n\vartheta_1(x_i)T_iw^2_1(x_i)}{\Big[\sum_{i=1}^nT_iw_1(x_i)\Big]^2} \rightarrow
\frac{\int\frac{\vartheta_1(x)}{e(x)}h^2(x)f(x)\mu(dx)}{\Big\{\int h(x)f(x)\mu(dx)\Big\}^2}
$$

TÆ°Æ¡ng tá»± ta cÃ³ thá»ƒ tÃ­nh Ä‘Æ°á»£c phÃ¢n tá»©c thá»© 2 trong váº¿ pháº£i cá»§a `r lb(eq11)` lÃ  

$$
\frac{\sum_{i=1}^n\vartheta_0(x_i)T_iw^2_1(x_i)}{\Big[\sum_{i=1}^nT_iw_1(x_i)\Big]^2} \rightarrow
\frac{\int\frac{\vartheta_0(x)}{1-e(x)}h^2(x)f(x)\mu(dx)}{\Big\{\int h(x)f(x)\mu(dx)\Big\}^2}
$$

NhÆ° váº­y

$$
n\V[\hat{\tau}_h] \rightarrow
\frac{\int\Big(\frac{\vartheta_1(x)}{e(x)}+\frac{\vartheta_0(x)}{1-e(x)}\Big)h^2(x)f(x)\mu(dx)}{\Big\{\int h(x)f(x)\mu(dx)\Big\}^2}
$$
`r rs('\\square')`

Náº¿u $\vartheta_1(x) = \vartheta_0(x) = \vartheta$, ta cÃ³ 

$$
n\V[\hat{\tau}_h] = \frac{\vartheta}{C^2_h}\frac{\int h^2(x)f(x)\mu(dx)}{e(x)[1-e(x)]}
(\#eq:eq12)
$$
`r rs('\\square')`
::::




