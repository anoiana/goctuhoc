---
title: "üìçPh∆∞∆°ng Ph√°p MAIC"
subtitle: "_(Evidence Synthesis for Decision Making in Healthcare)_"
author: üë¶ $\mathcal{Anh.T}$; üë¶ $\mathcal{Cong.N}$
date: "üìÖ`r format(Sys.Date(), format = '%B %d, %Y')`"
output_dir: "docs"
header-includes:
   - \usepackage{amsmath}
   - \usepackage{titling}
   - \pretitle{\begin{flushleft}}
   - \posttitle{\end{flushleft}}
   - \usepackage{eso-pic,graphicx,transparent}
output: 
    bookdown::html_document2:
      fig_caption: yes
      theme: default
      highlight: tango
      toc: true
      toc_float: 
        collapsed: false
      toc_depth: 3
      code_folding: hide
      css: "../00_supp/style.css"
      includes:
        in_header: "../00_supp/header.html"
        before_body: "test.html"
      number_sections: true
fontsize: 12pt
bibliography: ["citation.bib"]
csl: ["../00_supp/apa.csl"]
link-citations: true
editor_options: 
  chunk_output_type: console
---

```{r child="../00_supp/general_rmd.Rmd"}
```



# Gi·ªõi thi·ªáu  

 _Matching-adjusted indirect comparison (MAIC)_ l√† m·ªôt ph∆∞∆°ng ph√°p so s√°nh gi√°n ti·∫øp hai nh√≥m ƒëi·ªÅu tr·ªã m√† ta kh√¥ng c√≥ s·ªë li·ªáu tr·ª±c ti·∫øp. V√≠ d·ª• kh√°ch h√†ng c·ªßa ta l√† h√£ng thu·ªëc A, c√≥ data c·ªßa 2 nh√≥m b·ªánh nh√¢n ƒë∆∞·ª£c ƒëi·ªÅu tr·ªã b·∫±ng thu·ªëc A v√† thu·ªëc B (B c≈©ng c√≥ th·ªÉ xem l√† placebo [gi·∫£ d∆∞·ª£c]). M·ª•c ti√™u c·ªßa h·ªç l√† so s√°nh hi·ªáu qu·∫£ c·ªßa thu·ªëc A v√† thu·ªëc C (thu·ªôc c√¥ng ty ƒë·ªëi th·ªß). M·∫∑c d√π ta kh√¥ng c√≥ s·ªë li·ªáu n√†o v·ªÅ thu·ªëc C nh∆∞ng ta c√≥ th·ªÉ t√¨m th·∫•y nh·ªØng b√†i b√°o cho k·∫øt qu·∫£ so s√°nh c·ªßa thu·ªëc C v√† 1 lo·∫°i kh√°c. N·∫øu nh∆∞ lo·∫°i thu·ªëc ƒë∆∞·ª£c s·ª≠ d·ª•ng ƒë·ªÉ so s√°nh v·ªõi thu·ªëc C l√† B th√¨ ƒë∆∞∆°c xem l√† ƒëi·ªÅu ki·ªán l√Ω t∆∞·ªüng ƒë·ªÉ th·ª±c hi·ªán ph∆∞∆°ng ph√°p so s√°nh gi√°n ti·∫øp, so s√°nh n√†y ƒë∆∞·ª£c g·ªçi l√† _so s√°nh t∆∞∆°ng x·ª©ng (anchored comparison)_ . Trong tr∆∞·ªùng h·ª£p lo·∫°i thu·ªëc ƒë∆∞·ª£c ch·ªçn l√† D, ta th·∫•y r·∫±ng gi·ªØa 2 nghi√™n c·ª©u n√†y kh√¥ng s·ª≠ d·ª•ng c√πng m·ªôt lo·∫°i thu·ªëc so s√°nh (l√† B), th√¨ so s√°nh n√†y ƒë∆∞·ª£c g·ªçi l√† _so s√°nh b·∫•t t∆∞∆°ng x·ª©ng (unanchored comparison)_, xem h√¨nh \@ref(fig:diagram). H√¨nh th·ª©c so s√°nh th·ª© hai ƒë√≤i h·ªèi nhi·ªÅu gi·∫£ thuy·∫øt h∆°n lo·∫°i th·ª© nh·∫•t, v√¨ th·∫ø ch·ªâ trong tr∆∞·ªùng h·ª£p so s√°nh ƒë·ªëi x·ª©ng kh√¥ng th·ªÉ th·ª±c hi·ªán ƒë∆∞·ª£c th√¨ ta m·ªõi xem x√©t ƒë·∫øn lo·∫°i so s√°nh b·∫•t ƒë·ªëi x·ª©ng. Trong b√†i hi·ªán t·∫°i, ta s·∫Ω l√†m quen v·ªõi ph∆∞∆°ng ph√°p so s√°nh ƒë·ªëi x·ª©ng, lo·∫°i so s√°nh th·ª© hai c√≥ th·ªÉ s·∫Ω ƒë∆∞·ª£c gi·ªõi thi·ªáu trong nh·ªØng ph·∫ßn ti·∫øp theo.  
 
```{r diagram, fig.cap="_(tr√°i) so s√°nh ƒë·ªëi x·ª©ng; (ph·∫£i) so s√°nh b·∫•t ƒë·ªëi x·ª©ng_"}
node = tibble(x = c(0.1,0.3,0.5), y = c(0.2,0.5,0.2), name = c("A","B","C"))
from = c("A","B","C")
to = c("B","C","A")
edge = tibble(from,to,
   x.from = node$x[match(from,node$name)],
   y.from = node$y[match(from,node$name)],
   x.to = node$x[match(to,node$name)],
   y.to = node$y[match(to, node$name)],
   lt = c("dashed","dashed","dotted")
)

add_text = tibble(
   x = c(0.15,0.3,0.4), y = c(0.35,0.25,0.35),
   lab = c("so s√°nh tr·ª±c ti·∫øp\n c√≥ IPD\n(ƒë√£ th·ª±c hi·ªán)","so s√°nh gi√°n ti·∫øp\n(ƒëang th·ª±c hi·ªán)","so s√°nh tr·ª±c ti·∫øp\nch·ªâ c√≥ SLD\n(ƒë√£ th·ª±c hi·ªán)")
)

g1<- ggplot()+
   geom_segment(data = edge, aes(x = x.from, y = y.from, xend = x.to, yend = y.to,linetype = lt),show.legend = F, color = "grey")+
   geom_point(data = node, aes(x = x,y),size = 25, color = "pink")+
   geom_text(data = node, aes(x = x,y = y, label=name), size = 8)+
   geom_text(data = add_text, aes(x,y,label = lab), size = 4)+
   theme_void()+
   xlim(c(0,0.6))+ ylim(c(0,0.6))
####
####
####

node = tibble(x = c(0.1,0.3,0.5, 0.7), y = c(0.2,0.5,0.2,0.5), name = c("A","B","C","D"))
from = c("A","C","C")
to = c("B","D","A")
edge = tibble(from,to,
   x.from = node$x[match(from,node$name)],
   y.from = node$y[match(from,node$name)],
   x.to = node$x[match(to,node$name)],
   y.to = node$y[match(to, node$name)],
   lt = c("dashed","dashed","dotted")
)

add_text = tibble(
   x = c(0.2,0.3,0.6), y = c(0.35,0.25,0.35),
   lab = c("so s√°nh tr·ª±c ti·∫øp\n c√≥ IPD\n(ƒë√£ th·ª±c hi·ªán)","so s√°nh gi√°n ti·∫øp\n(ƒëang th·ª±c hi·ªán)","so s√°nh tr·ª±c ti·∫øp\nch·ªâ c√≥ SLD\n(ƒë√£ th·ª±c hi·ªán)")
)

g2<- ggplot()+
   geom_segment(data = edge, aes(x = x.from, y = y.from, xend = x.to, yend = y.to,linetype = lt),show.legend = F, color = "grey")+
   geom_point(data = node, aes(x = x,y),size = 25, color = "violet")+
   geom_text(data = node, aes(x = x,y = y, label=name), size = 8)+
   geom_text(data = add_text, aes(x,y,label = lab), size = 4)+
   theme_void()+
   xlim(c(0,0.8))+ ylim(c(0,0.6))
  
gridExtra::grid.arrange(g1,g2, ncol = 2)

```

Khi th·ª±c hi·ªán c√°c ph∆∞∆°ng ph√°p so s√°nh th·ªëng k√™, ƒë·ªÉ gi·∫£m ƒë·ªô l·ªách (biasedness) ta th∆∞·ªùng mong mu·ªën c√¢n b·∫±ng c√°c ƒë∆°n v·ªã (units) sao cho m·ªôt s·ªë ƒë·∫°i l∆∞·ª£ng th·ªëng k√™ gi·ªØa hai nh√≥m ƒëi·ªÅu tr·ªã x·∫•p x·ªâ nhau. N√≥i c√°ch kh√°c ta gi·∫£m t√≠nh kh√°c bi·ªát gi·ªØa hai nh√≥m b·ªánh nh√¢n tr√™n c√°c bi·∫øn ƒë∆∞·ª£c quy ƒë·ªãnh tr∆∞·ªõc ƒëi·ªÅu tr·ªã (pretreatment hay baseline). V√≠ d·ª• ta th∆∞·ªùng b·∫Øt g·∫∑p c√°c th√¥ng tin nh∆∞ tu·ªïi, gi·ªõi t√≠nh, d√¢n t·ªôc... c·ªßa b·ªánh nh√¢n thu·ªôc hai nh√≥m ƒëi·ªÅu tr·ªã kh√°c nhau, nh∆∞ th·∫ø ƒë·ªÉ tƒÉng ƒë·ªô ch√≠nh x√°c khi so s√°nh, c√°c b·ªánh nh√¢n thu·ªôc 2 nh√≥m ƒëi·ªÅu tr·ªã ph·∫£i c√≥ c√°c tr·ªã s·ªë v·ªÅ tu·ªïi, gi·ªõi t√≠nh, d√¢n t·ªôc t∆∞∆°ng ƒë·ªìng nhau (ƒëi·ªÅu n√†y tu√¢n th·ªß theo c√°c gi·∫£ thuy·∫øt trong l√Ω thuy·∫øt v·ªÅ _suy lu·∫≠n nguy√™n nh√¢n (casual inference)_. Th√¥ng th∆∞·ªùng, ta s·∫Ω g·∫∑p 2 lo·∫°i bi·∫øn c∆° b·∫£n l√† bi·∫øn li√™n t·ª•c v√† bi·∫øn r·ªùi r·∫°c. Bi·∫øn li√™n t·ª•c ƒë∆∞·ª£c s·ª≠ d·ª•ng cho tu·ªïi, c√°c tr·ªã s·ªë b·ªánh l√Ω, trong khi bi·∫øn r·ªùi r·∫°c l·∫°i ƒë∆∞·ª£c s·ª≠ d·ª•ng cho gi·ªõi t√≠nh, d√¢n t·ªôc, v√πng mi·ªÅn. ƒê·ªëi v·ªõi bi·∫øn li√™n t·ª•c ta th∆∞·ªùng quan t√¢m t·ªõi 2 tr·ªã s·ªë th·ªëng k√™ l√† _k·ª≥ v·ªçng_ v√† _ph∆∞∆°ng sai_, c√≤n bi·∫øn r·ªùi r·∫°c l√† _t·ªâ l·ªá nh√≥m_, v√≠ d·ª• t·ªâ l·ªá nam, t·ªâ l·ªá n·ªØ.

ƒê·ªëi v·ªõi data bao g·ªìm lo·∫°i thu·ªëc A v√† thu·ªëc B (data c·ªßa kh√°c h√†ng), ta s·∫Ω c√≥ th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ c√°c bi·∫øn li√™n t·ª•c v√† r·ªùi r·∫°c c·ªßa t·ª´ng b·ªánh nh√¢n, data lo·∫°i n√†y g·ªçi l√† _data chi ti·∫øt [individual paticipant data (IPD)]_. Trong khi c√°c th√¥ng tin c·ªßa thu·ªëc C v√† B m√† ta thu th·∫≠p ƒë∆∞·ª£c t·ª´ m·ªôt b√†i b√°o khoa h·ªçc n√†o ƒë√≥ th√¨ ch·ªâ c√≥ c√°c ƒë·∫°i l∆∞·ª£ng th·ªëng k√™ nh∆∞ k·ª≥ v·ªçng, trung v·ªã v√† ph∆∞∆°ng sai c·ªßa bi·∫øn li√™n t·ª•c, v√† c√°c t·ªâ l·ªá c·ªßa bi·∫øn r·ªùi r·∫°c, ƒë∆∞·ª£c g·ªçi l√† _data t·ªïng h·ª£p [summarized level data (SLD) or aggregate data]_. H√¨nh (\@ref(fig:sample-SLD)) l√† m·ªôt v√≠ d·ª• c·ªßa SLD.

```{r sample-SLD, echo=FALSE, out.width = '90%', fig.cap="_m·ªôt v√≠ d·ª• c·ªßa c√°c bi·∫øn tr∆∞·ªõc ƒëi·ªÅu tr·ªã trong m·ªôt b√†i b√°o khoa h·ªçc_"}
 knitr::include_graphics("sample_sld.PNG")
```

ƒê·ªÉ minh h·ªça cho IPD, ta h√£y xem x√©t h√¨nh (\@ref(fig:IPD))

```{r IPD, echo=FALSE, fig.cap="_m·ªôt v√≠ d·ª• c·ªßa individual participant data_"}
df = read.csv("dataset.csv")%>%
   mutate(time = anh$help_nice_form(time, digits = 4))

draw_table(df)
```

·ªü ƒë√¢y ta th·∫•y r·∫±ng m·ªói b·ªánh nh√¢n thu·ªôc nh√≥m ƒëi·ªÅu tr·ªã A v√† B ƒë·ªÅu c√≥ th√¥ng tin ƒë·∫ßy ƒë·ªß ·ªü c·∫£ 2 bi·∫øn _age_ v√† _gender_. Ta c√≥ th·ªÉ t√≥m t·∫Øc 2 bi·∫øn n√†y nh∆∞ trong h√¨nh (\@ref(fig:sum-IPD)) 


```{r sum-IPD, echo=FALSE, fig.cap= "_B·∫£ng t√≥m t·∫Øc c√°c ƒë·∫°i l∆∞·ª£ng th·ªëng k√™ c·ªßa hai bi·∫øn age v√† gender c·ªßa IPD_"}
l = list(
   vars = c("age", "gender (male)")
)

l$mean<- c(mean(df$age), NA)
l$p<- c(NA, mean(df$gender=="Male"))
l$variance = c(var(df$age), l$p[2]%>%{.*(1-.)*nrow(df)})

as_tibble(l)%>%
   mutate(across(where(is.numeric), anh$help_nice_form))%>%
   mutate(across(.fns = ~ifelse(is.na(.),"",anh$help_nice_form(.))))%>%
   draw_table()
```

Ngo√†i ra, d·ª±a v√†o h√¨nh (\@ref(fig:sample-SLD)) ta c√≥ th·ªÉ d·ªÖ d√†ng t√≠nh ƒë∆∞·ª£c s·ªë tu·ªïi trung b√¨nh v√† t·ªâ l·ªá nam nh∆∞ trong h√¨nh (\@ref(fig:sum-SLD))


```{r sum-SLD, echo=FALSE, fig.cap= "_B·∫£ng t√≥m t·∫Øc c√°c ƒë·∫°i l∆∞·ª£ng th·ªëng k√™ c·ªßa hai bi·∫øn age v√† gender c·ªßa SLD_"}
l = list(
   vars = c("age", "gender (male)")
)

l$mean<- c((73.3*1072+72.7*1057)/(1072+1057), NA)
l$p<- c(NA, (1072-631 + 1057-600)/(1072+1057))
l$variance = c(NA, l$p[2]%>%{.*(1-.)*nrow(df)})

as_tibble(l)%>%
   mutate(across(where(is.numeric), anh$help_nice_form))%>%
   mutate(across(.fns = ~ifelse(is.na(.),"",anh$help_nice_form(.))))%>%
   draw_table()
```

Nh∆∞ v·∫≠y, ta th·∫•y r·∫±ng k·ª≥ v·ªçng c·ªßa bi·∫øn _age_  v√† t·ªâ l·ªá _male_ gi·ªØa IPD v√† SLD kh√¥ng b·∫±ng nhau, n·∫øu ta ti·∫øn h√†nh so s√°nh th√¨ k·∫øt qu·∫£ c√≥ kh·∫£ nƒÉng l·ªách r·∫•t cao. V√¨ th·∫ø m·ª•c ti√™u ch√∫ng ta l√† l√†m c√°ch n√†o ƒë·ªÉ nh·ªØng bi·∫øn tr√™n s·∫Ω x·∫•p x·ªâ nhau gi·ªØa IPD v√† SLD. 

M·ªôt l∆∞u √Ω nh·ªè l√† trong SLD hi·ªán t·∫°i, th√¥ng tin v·ªÅ ph∆∞∆°ng sai c·ªßa bi·∫øn _age_ kh√¥ng ƒë∆∞·ª£c cung c·∫•p n√™n ta s·∫Ω b·ªè qua ƒë·∫°i l∆∞·ª£ng n√†y. Ngo√†i ra, ƒë·ªëi v·ªõi bi·∫øn r·ªùi r·∫°c, ta kh√¥ng c·∫ßn quan t√¢m t·ªõi variance, b·ªüi v√¨ ta s·∫Ω gi·∫£ s·ª≠ bi·∫øn n√†y tu√¢n th·ªß ph√¢n ph·ªëi ƒëa th·ª©c (multinomial) n·∫øu c√≥ nhi·ªÅu h∆°n 2 nh√≥m, trong v√≠ d·ª• hi·ªán t·∫°i s·∫Ω l√† ph√¢n ph·ªëi nh·ªã th·ª©c (binomial). V√† ta bi·∫øt r·∫±ng k·ª≥ v·ªçng v√† ph∆∞∆°ng sai c·ªßa ph√¢n ph·ªëi nh·ªã th·ª©c ƒë·ªÅu l√† h√†m s·ªë c·ªßa tham s·ªë $p$ \@ref(eq:1), nghƒ©a l√† n·∫øu m·ªôt trong hai ƒë·∫°i l∆∞·ª£ng ƒë∆∞·ª£c c√¢n b·∫±ng, th√¨ ƒë·∫°i l∆∞·ª£ng c√≤n l·∫°i c≈©ng s·∫Ω ƒë∆∞·ª£c c√¢n b·∫±ng. ƒê·ªÉ hi·ªÉu th√™m ta c√≥ th·ªÉ tham kh·∫£o t·∫°i c√°c ngu·ªìn @jam2012, @phil2017 v√† @sig2010.

$$
\begin{aligned}
X &\sim \mathcal{Bin}(n,p) \\
&\Rightarrow \E(X) = np \\
&\Rightarrow \V(X) = np(1-p) ~~~~\textit{(n is fixed)}
\end{aligned}
(\#eq:1)
$$
 
# Ph∆∞∆°ng ph√°p

ƒê·ªÉ ti·∫øn h√†nh so s√°nh ta th·ª±c hi·ªán qua 3 b∆∞·ªõc 

1. So s√°nh kh√¥ng c√¢n x·ª©ng kh√¥ng ƒëi·ªÅu ch·ªânh (unmatched & unadjusted comparison hay c√≤n g·ªçi l√† naive comparison ho·∫∑c Bucher comparison)
2. So s√°nh c√¢n x·ª©ng kh√¥ng ƒëi·ªÅu ch·ªânh (matched & unadjusted comparison)
3. So s√°nh c√¢n x·ª©ng c√≥ ƒëi·ªÅu ch·ªânh (matched and adjusted comparison)

## So s√°nh kh√¥ng c√¢n x·ª©ng kh√¥ng ƒëi·ªÅu ch·ªânh

ƒê·ªëi v·ªõi lo·∫°i so s√°nh n√†y, ta s·∫Ω so s√°nh tr·ª±c ti·∫øp c√°c ƒë·∫°i l∆∞·ª£ng ƒë√°nh gi√° hi·ªáu qu·∫£ c·ªßa c·∫£ hai nghi√™n c·ª©u. V√≠ d·ª• ƒë·∫°i l∆∞·ª£ng ta mu·ªën so s√°nh l√† _odd ratio_ ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a nh∆∞ sau 

$$
OR = \frac{odd_1}{odd_2} =\frac{p_1/(1-p_1)}{p_2/(1-p_2)}
$$
ƒê·ªëi v·ªõi lo·∫°i so s√°nh ƒë·ªëi x·ª©ng ƒëi·ªÅu n√†y c√≥ th·ªÉ d·ªÖ d√†ng nh·∫≠n th·∫•y, v√≠ d·ª• ƒë·ªëi v·ªõi SLD, ta c√≥ $\ln(OR_{CB}) = \ln(odd_C) - \ln(odd_B)$, v·ªõi IPD s·∫Ω l√† $\ln(OR_{AB}) = \ln(odd_A) - \ln(odd_B)$. Nh∆∞ v·∫≠y  

$$
\begin{aligned}
\ln(OR_{AC}) &= \ln(OR_{AB}) - \ln(OR_{CB}) \\
&= \ln(odd_A) - \ln(odd_B) - \ln(odd_C) + \ln(odd_B) \\
&= \ln(odd_A) -  \ln(odd_C)
\end{aligned}
$$

trong ƒë√≥ $\ln(OR_{AC})$ ch√≠nh l√† _odd ratio_ c·ªßa A v√† C, c≈©ng ch√≠nh l√† ƒë·∫°i l∆∞·ª£ng ta mu·ªën t√¨m. Trong lo·∫°i so s√°nh n√†y r√µ r√†ng ta ƒë√£ kh√¥ng xem x√©t c√°c bi·∫øn tr∆∞·ªõc ƒëi·ªÅu tr·ªã.

## So s√°nh c√¢n x·ª©ng kh√¥ng ƒëi·ªÅu ch·ªânh

Lo·∫°i so s√°nh n√†y c≈©ng t∆∞∆°ng t·ª± nh∆∞ lo·∫°i m·ªôt, nh∆∞ng ta c·∫ßn ch·ªçn l·ªçc v√† lo·∫°i b·ªè ƒëi nh·ªØng b·ªánh nh√¢n n·∫±m ngo√†i ph·∫°m vi xem x√©t c·ªßa SLD. V√≠ d·ª• trong b√†i b√°o khoa h·ªçc ta thu th·∫≠p ƒë∆∞·ª£c c√≥ ƒë·ªÅ c·∫≠p v·ªÅ gi·ªõi h·∫°n ƒë·ªô tu·ªïi c·ªßa b·ªánh nh√¢n tham gia v√†o nghi√™n c·ª©u l√† t·ª´ $50$ t·ªõi $80$, trong khi ƒë√≥ c√°c b·ªánh nh√¢n tham gia trong IPD l√† t·ª´ $40$ t·ªõi $80$, nh∆∞ v·∫≠y ta c·∫ßn lo·∫°i b·ªè ƒëi t·∫•t c·∫£ c√°c b·ªánh nh·∫≠n d∆∞·ªõi $50$ tu·ªïi. M·ªôt l∆∞u √Ω ta c·∫ßn xem x√©t l√† ph·∫°m vi c·ªßa SLD ph·∫£i lu√¥n nh·ªè h∆°n ph·∫°m vi c·ªßa IPD, ƒëi·ªÅu n√†y cho ph√©p ta c·∫Øt b·ªõt c√°c quan s√°t t·ª´ IPD ƒë·ªÉ l√†m cho hai data c√¢n ƒë·ªëi. Trong tr∆∞·ªùng h·ª£p ng∆∞·ª£c l·∫°i, v√≠ d·ª• s·ªë tu·ªïi c·ªßa c√°c b·ªánh nh√¢n trong IPD l√† t·ª´ $50$ t·ªõi $70$, ta s·∫Ω kh√¥ng th·ªÉ n√†o c√¢n x·ª©ng ƒë∆∞·ª£c gi·ªØa 2 data, v√¨ ta kh√¥ng c√≥ d·ªØ ki·ªán c·ªßa t·ª´ng b·ªánh nh√¢n trong SLD.

Sau khi 2 data ƒë√£ ƒë∆∞·ª£c c√¢n x·ª©ng, ta ti·∫øn h√†nh t√≠nh $OR_{AB}$ v√† so s√°nh v·ªõi $OR_{CB}$ nh∆∞ so s√°nh lo·∫°i I. 

## So s√°nh c√¢n x·ª©ng c√≥ ƒëi·ªÅu ch·ªânh

·ªû lo·∫°i so s√°nh n√†y, ta s·∫Ω s·ª≠ d·ª•ng IPD ƒë√£ ƒë∆∞·ª£c c√¢n x·ª©ng v·ªõi SLD v√† ti·∫øn h√†nh ƒëi·ªÅu ch·ªânh c√°c bi·∫øn tr∆∞·ªõc ƒëi·ªÅu tr·ªã. Tr∆∞·ªõc ti√™n ta c·∫ßn x·ª≠ l√Ω c√°c bi·∫øn r·ªùi r·∫°c b·∫±ng c√°ch t·∫°o ra c√°c bi·∫øn nh·ªã th·ª©c. V√≠ d·ª• n·∫øu  bi·∫øn r·ªùi r·∫°c $X$ c√≥ $4$ nh√≥m $A,B,C$ v√† $D$ th√¨ ta s·∫Ω t·∫°o th√†nh 3 bi·∫øn nh·ªã th·ª©c $\{X_i\}_{i=1}^3$ mang gi√° tr·ªã $0$ ho·∫∑c $1$. Nh∆∞ v·∫≠y 

- B·ªánh nh√¢n thu·ªôc nh√≥m $A$ s·∫Ω c√≥ gi√° tr·ªã $(1,0,0)$
- B·ªánh nh√¢n nh√≥m $B$ c√≥ gi√° tr·ªã $(0,1,0)$
- B·ªánh nh√¢n nh√≥m $C$ c√≥ gi√° tr·ªã $(0,0,1)$

nh√≥m $D$ ƒë∆∞·ª£c xem l√† nh√≥m li√™n ƒë·ªõi (reference), nghƒ©a l√† n·∫øu gi√° tr·ªã c·ªßa 3 bi·∫øn $\{X_i\}_{i=1}^3$ ƒë·ªÅu l√† $0$ th√¨ b·ªánh nh√¢n ƒë√≥ thu·ªôc nh√≥m $D$. Quy ∆∞·ªõc t∆∞∆°ng t·ª± n·∫øu ta ch·ªçn nh√≥m reference l√† m·ªôt trong ba nh√≥m $A,B,C$. 

Trong v√≠ d·ª• v·ªÅ bi·∫øn _gender_, v√¨ ch·ªâ c√≥ 2 nh√≥m _Male_ v√† _Female_ n√™n ta ch·ªâ c·∫ßn m·ªôt bi·∫øn nh·ªã th·ª©c ƒë·ªÉ bi·ªÉu di·ªÖn nh∆∞ h√¨nh (\@ref(fig:codehot))

```{r codehot, fig.cap="_IPD sau khi x·ª≠ l√Ω bi·∫øn r·ªùi r·∫°c_"}
df = mutate(df, gender = ifelse(gender == "Male",1,0))
draw_table(df)
```

Ta xem l·∫°i 2 b·∫£ng (\@ref(fig:sum-IPD)) v√† (\@ref(fig:sum-SLD)), li·ªáu gi√° tr·ªã _k·ª≥ v·ªçng_ v√† _t·ªâ l·ªá nh√≥m_ c·ªßa hai data n√†y c√≥ kh·∫£ nƒÉng ƒëi·ªÅu ch·ªânh ƒë∆∞·ª£c kh√¥ng? ƒë·ªÉ tr·∫£ l·ªùi c√¢u h·ªèi n√†y ta c·∫ßn xem x√©t c√°c gi√° tr·ªã c·ª±c ƒë·∫°i v√† c·ª±c ti·ªÉu c·ªßa 2 bi·∫øn trong IPD. 

```{r}
df[,c("age","gender")]%>% summary()
```

Ta th·∫•y r·∫±ng gi√° tr·ªã c·ª±c ti·ªÉu v√† c·ª±c ƒë·∫°i c·ªßa _age_ l·∫ßn l∆∞·ª£t l√† $50$ v√† $65$, trong khi ƒë√≥ k·ª≥ v·ªçng c·ªßa _age_ trong SLD l√† $73$, n·∫±m ngo√†i t·∫≠p gi√° tr·ªã c·ªßa bi·∫øn n√†y trong IPD. Trong tr∆∞·ªùng h·ª£p n√†y, ta kh√¥ng th·ªÉ n√†o c√¢n b·∫±ng ƒë∆∞·ª£c. ƒë·ªÉ hi·ªÉu t·∫°i sao kh√¥ng th·ªÉ ta h√£y xem x√©t c√¥ng th·ª©c t√≠nh k·ª≥ v·ªçng nh∆∞ sau 

$$
\mu = \frac{\sum_{i=1}^n x_i}{n} = \sum_{i=1}^n\frac{1}{n}x_i = \sum_{i=1}^n p_ix_i
(\#eq:2)
$$
d·ª±a theo c√¥ng th·ª©c \@ref(eq:2) ta th·∫•y r·∫±ng m·ªói m·ªôt gi√° tr·ªã $x_i$ ƒë·ªÅu c√≥ 1 t·ªâ tr·ªçng ƒë√≥ng g√≥p l√† $p_i$, th√¥ng th∆∞·ªùng th√¨ t·ªâ tr·ªçng ƒë√≥ng g√≥p n√†y c·ªßa c√°c gi√° tr·ªã trong c√πng m·ªôt m·∫´u l√† nh∆∞ nhau, nghƒ©a l√† $1/n$. Nh∆∞ v·∫≠y ƒë·ªÉ ƒëi·ªÅu ch·ªânh gi√° tr·ªã $\mu_{IPD}$ trong SLD b·∫±ng v·ªõi $\mu_{SLD}$, ta c·∫ßn ph·∫£i ƒëi·ªÅu ch·ªânh c√°c gi√° tr·ªã $p_i$. V√≠ d·ª•, xem x√©t d√£y s·ªë $\{1,3,5,8,9\}$, ta t√≠nh ƒë∆∞·ª£c trung v·ªã c·ªßa d√£y s·ªë n√†y l√† 

$$
\mu = 0.2(1+3+5+8+9)= 5.2
$$

N·∫øu ta mu·ªën l·∫•y $\mu = 7.7$ ta c·∫ßn ph·∫£i ƒëi·ªÉu ch·ªânh $\{p_i|i=1,\dots,n\}$ sao cho _b√¨nh qu√¢n gia quy·ªÅn (weighted mean)_ $\sum p_ix_i$ b·∫±ng gi√° tr·ªã m√† ta mong mu·ªën. Nh∆∞ v·∫≠y n·∫øu c√°c $p_i$ l·∫ßn l∆∞·ª£t l√† $\{0.05, 0.05, 0.1, 0.2, 0.6\}$ th√¨ ta s·∫Ω c√≥ 

$$
\mu = 0.05*(1) + 0.05*(3)+ 0.1*(5)+0.2*(8)+ 0.6*(9) = 7.7
$$
 Ta nh·∫≠n th·∫•y r·∫±ng, $p_i$ c·ªßa c√°c gi√° tr·ªã c√†ng xa gi√° tr·ªã $7.7$ th√¨ c√†ng nh·ªè, ng∆∞·ª£c l·∫°i c√°c $p_i$ c·ªßa c√°c gi√° tr·ªã c√†ng g·∫ßn $7.7$ s·∫Ω c√†ng l·ªõn, ta c√≥ th·ªÉ hi·ªÉu n√¥m na l√† c√°c gi√° tr·ªã c√†ng xa th√¨ ƒë√≥ng g√≥p c√†ng √≠t v√† c√°c gi√° tr·ªã c√†ng g·∫ßn s·∫Ω ƒë√≥ng g√≥p c√†ng nhi·ªÅu. Nh∆∞ v·∫≠y r√µ r√†ng n·∫øu nh∆∞ k·ª≥ v·ªçng ta mong mu·ªën n·∫±m ngo√†i c√°c gi√° tr·ªã hi·ªán h·ªØu trong m·∫´u (t·ª©c t·ªâ tr·ªçng ƒë√≥ng g√≥p l√† 0) th√¨ kh√¥ng m·ªôt gi√° tr·ªã n√†o c√≥ th·ªÉ ƒë√≥ng g√≥p ƒë·ªÉ th·ªèa m√£n ƒëi·ªÅu ki·ªán mong mu·ªën. Ta gi·∫£i th√≠ch t∆∞∆°ng t·ª± cho tr∆∞·ªùng h·ª£p bi·∫øn nh·ªã th·ª©c _sex_.
 
Trong tr∆∞·ªùng h·ª£p ta mu·ªën ƒëi·ªÅu ch·ªânh ph∆∞∆°ng sai $\V(X)$ ta c≈©ng l√†m t∆∞∆°ng t·ª±. Ta bi·∫øt r·∫±ng c√¥ng th·ª©c c·ªßa ph∆∞∆°ng sai l√† 

$$
\begin{aligned}
\V(X) &= \E(X^2) - [\E(X)]^2 \\
\Rightarrow \E(X^2) &= \V(X) + [\E(X)]^2
\end{aligned}
$$

Nh∆∞ v·∫≠y ƒë·ªÉ c√¢n b·∫±ng c·∫£ k·ª≥ v·ªçng v√† ph∆∞∆°ng sai c·ªßa m·ªôt bi·∫øn li√™n t·ª•c, ta c·∫ßn c√¢n b·∫±ng c·∫£ bi·∫øn $X$ v√† $X^2$. ƒê·ªÉ th·ª±c hi·ªán b∆∞·ªõc n√†y ta ch·ªâ c·∫ßn th√™m v√†o 1 c·ªôt $X^2$ cho bi·∫øn c·∫ßn t√≠nh. Song song ƒë√≥, ta d·ª±a v√†o 2 ƒë·∫°i l∆∞·ª£ng k·ª≥ v·ªçng v√† ph∆∞∆°ng sai trong SLD, r·ªìi s·ª≠ d·ª•ng c√¥ng th·ª©c $\E(X^2) = \V(X) + [\E(X)]^2$ ƒë·ªÉ t√≠nh gi√° tr·ªã c·∫ßn ƒë∆∞·ª£c ƒëi·ªÅu ch·ªânh. 

:::: {.infobox .question data-latex="question"}
::: {.center data-latex=""}
**QUESTION:**
:::
Trong nhi·ªÅu tr∆∞·ªùng h·ª£p, SLD ch·ªâ cung c·∫•p gi√° tr·ªã trung v·ªã (median) c·ªßa m·ªôt bi·∫øn li√™n t·ª•c ch·ª© kh√¥ng c√≥ k·ª≥ v·ªçng. Trong tr∆∞·ªùng h·ª£p n√†y ta ph·∫£i l√†m sao? 
::::


# V√≠ d·ª• minh h·ªça cho qu√° tr√¨nh ƒëi·ªÅu ch·ªânh c√°c bi·∫øn tr∆∞·ªõc ƒëi·ªÅu tr·ªã

> _(Data s·ª≠ d·ª•ng ƒë·ªÉ minh h·ªça trong ph·∫ßn n√†y c√≥ th·ªÉ t√¨m th·∫•y t·∫°i [link data](https://datahub.io/machine-learning/haberman))_

Ta h√£y xem x√©t data nh∆∞ trong h√¨nh \@ref(fig:dataminhhoa), √Ω nghƒ©a t·ª´ng bi·∫øn ƒë∆∞·ª£c ch·ªâ ra trong h√¨nh \@ref(fig:label). Trong data n√†y ta th·∫•y c√≥ 3 bi·∫øn ƒë·ªôc l·∫≠p ƒë·ªÅu l√† bi·∫øn li√™n t·ª•c v√† 1 bi·∫øn ph·ª• thu·ªôc c√≥ d·∫°ng r·ªùi r·∫°c. V·ªõi m·ª•c ƒë√≠ch minh h·ªça, bi·∫øn `NOPAND` s·∫Ω ƒë∆∞·ª£c g·ªçp l·∫°i th√†nh bi·∫øn r·ªùi r·∫°c, nh∆∞ v·∫≠y ta s·∫Ω c√≥ 3 bi·∫øn trong ƒë√≥ c√≥ 2 bi·∫øn li√™n t·ª•c v√† 1 bi·∫øn r·ªùi r·∫°c. Ta s·∫Ω g·ªçp bi·∫øn `NOPAND` th√†nh 1 bi·∫øn nh·ªã ph√¢n theo quy t·∫Øc $NOPAND = I(NOPAND>0)$, trong ƒë√≥ $I(.)$ l√† h√†m ch·ªâ th·ªã (indicator function).


```{r dataminhhoa, fig.cap="_The dataset contains cases from a study that was conducted between 1958 and 1970 at the University of Chicago‚Äôs Billings Hospital on the survival of patients who had undergone surgery for breast cancer._"}
dat = read_csv("haberman_csv.csv")
lab = names(dat)%>% str_replace_all("_"," ")

name<-
str_split(lab," ")%>% 
   map_chr(~ str_sub(.,1,1)%>% str_c(collapse = "")%>% str_to_upper())

dat<-map2_df(dat,lab, ~ `label<-`(.x, value = .y))%>%
   `names<-`(name)

draw_table(dat)
```


```{r label, fig.cap="_ch√∫ th√≠ch √Ω nghƒ©a c·ªßa t·ª´ng bi·∫øn trong h√¨nh \\@ref(fig:dataminhhoa)_"}
label(dat)%>%
   {tibble(code = names(.), name = . )}%>%
   draw_table()

dat%<>% mutate(NOPAND = ifelse(NOPAND>0,1L,0L))%>%
   modify2(lab, ~`label<-`(.x,value = .y))
```

C√°c bi·∫øn trong data ƒë∆∞·ª£c t√≥m t·∫Øc nh∆∞ sau 

```{r}
dat%>%
   mutate(across(.cols = c(NOPAND,SS), as.factor))%>%
   summary()

```

Nh∆∞ v·∫≠y gi√° tr·ªã k·ª≥ v·ªçng c·ªßa `AOPATOO` v√† `PYOO` l·∫ßn l∆∞·ª£t l√† $52.5$ v√† $62.9$, t·ªâ l·ªá nh√≥m c·ªßa `NOPAND` c√≥ gi√° tr·ªã kh√°c $0$ l√† $0.55$. Ta mu·ªën ƒëi·ªÅu ch·ªânh sau cho 3 gi√° tr·ªã v·ª´a ƒë∆∞·ª£c n√™u th√†nh $55,59$ v√† $0.4$. C√°c b∆∞·ªõc ƒë∆∞·ª£c th·ª±c hi·ªán nh∆∞ sau

1. tr·ª´ m·ªói c·ªôt cho c√°c gi√° tr·ªã t∆∞∆°ng ·ª©ng t·ª´ SLD.
2. ƒë·ªãnh nghƒ©a h√†m s·ªë m·∫•t m√°t 
$$
L = \sum_{i=1}^n \exp\{\bf{X\alpha}\}
$$
3. t√¨m c·ª±c ti·ªÉu c·ªßa h√†m m·∫•t m√°t b·∫±ng h√†m `optim`
4. t√¨m t·ªâ tr·ªçng ƒë√≥ng g√≥p c·ªßa m·ªói ƒë∆°n v·ªã b·∫±ng c√¥ng th·ª©c 
$$
\exp\{\bf{X\alpha}\}
$$
5. t√≠nh _effective sample size_ b·∫±ng c√¥ng th·ª©c 
$$
n_{eff} = \frac{\Big[\sum_{i=1}^nx_i\Big]^2}{\sum_{i=1}^nx_i^2}
$$
ta c√≥ th·ªÉ xem ƒë·∫°i l∆∞·ª£ng n√†y l√† k√≠ch c·ª° m·∫´u sau khi ƒë√£ ƒëi·ªÅu ch·ªânh. Nghƒ©a l√† t∆∞∆°ng ·ª©ng v·ªõi s·ªë l∆∞·ª£ng b·ªánh nh√¢n s·ª≠ d·ª•ng thu·ªëc A t·ª´ qu·∫ßn th·ªÉ c·ªßa SLD. 

Sau khi t√≠nh to√°n qua 5 b∆∞·ªõc ta s·∫Ω thu ƒë∆∞·ª£c k·∫øt qu·∫£ nh∆∞ sau 

```{r ketqua, fig.cap="_k·∫øt qu·∫£ c√°c gi√° tr·ªã c·∫ßn c·∫ßn b·∫±ng sau khi ƒëi·ªÅu ch·ªânh_", echo=TRUE}

# select patient's characteristic
x = dat[,-4]%>%
   as.matrix() # convert to matrix form

# calculate mean and proportion before adjusted 
bef.adj = apply(x,2,mean) 

# minus relative measures in SLD
x1 = sweep(x, 2, c(55,59,0.4),`-`)

# define object function 
fun = function(a){
   sum(exp(x1%*%a))
}

# optimize obj function by optim
a1 = optim(par = c(0,0,0), fn = fun)$par

#obtain weights of each observation
w = c(exp(x%*%a1))

# calculate mean and proportion after adjusted
d<-
tibble(adjustment = c("no","yes"), wt = list(rep(1,nrow(x)), w))%>%
   mutate(result = map(wt, ~ map_df(dat[,-4], function(i) weighted.mean(i,.) )))%>%
   unnest(cols = result)

# calculate ESS 
ess = ceil(sum(w)^2/sum(w^2))

mutate(d, ESS = map_dbl(wt, ~ ceil(sum(.)^2/sum(.^2) )))%>%
   select(-wt)%>%
   modify_if(is.double, round, digits = 4)%>%
   draw_table()

```

m·ªói ƒë∆°n v·ªã trong IPD ƒë√£ c√≥ t·ªâ tr·ªçng ƒë√≥ng g√≥p nh∆∞ h√¨nh \@ref(fig:datawt)

```{r datawt, fig.cap="_IPD ƒë√£ ƒë∆∞·ª£c th√™m t·ªâ tr·ªçng ƒë√≥ng g√≥p_"}
mutate(dat, weight = w*ess/sum(w))%>%
   mutate(weight = round(weight,4))%>%
   draw_table()
```

Sau khi ƒë√£ c√≥ t·ªâ tr·ªçng ƒë√≥ng g√≥p c·ªßa t·ª´ng ƒë∆°n v·ªã, ta s·∫Ω ti·∫øn h√†nh t√≠nh c√°c ƒë·∫°i l∆∞·ª£ng ƒë·∫∑c tr∆∞ng nh∆∞ _odd ratio_, _proportion_ c·ªßa bi·∫øn ph·ª• thu·ªôc t·ª´ c√°c ƒë∆°n v·ªã trong IPD __s·ª≠ d·ª•ng t·ªâ tr·ªçng ƒë√≥ng g√≥p__. C√°c ƒë·∫°i l∆∞·ª£ng  ƒë∆∞·ª£c t√≠nh k√®m theo t·ªâ tr·ªçng ƒë√≥ng g√≥p n√†y mang √Ω nghƒ©a l√† c√°c ƒë·∫°i l∆∞·ª£ng ƒë∆∞·ª£c t√≠nh trong qu·∫ßn th·ªÉ c·ªßa SLD. Nh∆∞ v·∫≠y b·∫±ng c√°ch thay ƒë·ªïi t·ªâ tr·ªçng ƒë√≥ng g√≥p c·ªßa c√°c ƒë∆°n v·ªã trong IPD, ta ƒë√£ c√≥ th·ªÉ t√≠nh ƒë∆∞·ª£c c√°c gi√° tr·ªã th·ªëng k√™ trong qu·∫ßn th·ªÉ c√°c b·ªánh nh√¢n c·ªßa SLD. Sau ƒë√≥ ta b·∫Øt ƒë·∫ßu so s√°nh v·ªõi c√°c ƒë·∫°i l∆∞·ª£ng ƒë∆∞·ª£c t√¨m th·∫•y trong SLD. Th√¥ng th∆∞·ªùng b∆∞·ªõc ƒëi·ªÅu ch·ªânh bi·∫øn s·∫Ω ƒë∆∞·ª£c chia th√†nh 2 b∆∞·ªõc nh·ªè, g·ªçi l√† _ph√¢n t√≠ch ƒë·ªô nh·∫°y (sensitivity analysis)_. ƒê·∫ßu ti√™n l√† ta s·∫Ω ƒëi·ªÅu ch·ªânh t·ª´ng bi·∫øn, ti·∫øn h√†nh so s√°nh b√°o c√°o k·∫øt qu·∫£ th·ªëng k√™ (bao g·ªìm point estimation v√† interval estimation) v√† k√®m theo h·ªá s·ªë $ESS$. Ti·∫øp theo l√† ta s·∫Ω ƒëi·ªÅu ch·ªânh theo t·ª´ng scenario, theo v√≠ d·ª• ·ªü tr√™n v·ªõi IPD c√≥ t·∫•t c·∫£ l√† 3 bi·∫øn c·∫ßu ƒëi·ªÅu ch·ªânh, ta s·∫Ω l·∫ßn l∆∞·ª£t ƒëi·ªÅu ch·ªânh bi·∫øn th·ª© nh·∫•t, r·ªìi bi·∫øn th·ª© nh·∫•t v√† bi·∫øn th·ª© hai, r·ªìi cu·ªëi c√πng l√† c·∫£ 3 bi·∫øn, sau m·ªói l·∫ßn ƒëi·ªÅu ch·ªânh ta c≈©ng l·∫°i ti·∫øn h√†nh so s√°nh b√°o c√°o k·∫øt qu·∫£ th·ªëng k√™ c√πng v·ªõi h·ªá s·ªë $ESS$. V·ªÅ ph·∫ßn bi·ªÉu ƒë·ªì minh h·ªça, ta s·∫Ω s·ª≠ d·ª•ng forestplot ƒë·ªÉ th·ªÉ hi·ªán c√°c ph√©p so s√°nh qua m·ªói l·∫ßn ƒëi·ªÅu ch·ªânh. Chi ti·∫øt c·ª• th·ªÉ v√† `R code` s·∫Ω ƒë∆∞·ª£c tr√¨nh b√†y r√µ r√†ng ·ªü ph·∫ßn sau. 

# T·ªïng k·∫øt

M·ª•c ti√™u b√†i n√†y gi√∫p ta hi·ªÉu v·ªÅ ph∆∞∆°ng ph√°p so s√°nh MAIC, m·ªôt trong nh·ªØng ph∆∞∆°ng ph√°p ƒë∆∞·ª£c s·ª≠ d·ª•ng trong Evidence Synthesis. b√†i n√†y t·∫≠p trung gi·∫£i th√≠ch √Ω nghƒ©a, m·ª•c ti√™u v√† c√°c k·ªπ thu·∫≠t ƒë∆∞·ª£c d√πng ƒë·ªÉ ti·∫øn h√†nh ph∆∞∆°ng ph√°p so s√°nh n√†y. Trong b√†i ti·∫øp theo, ch√∫ng ta s·∫Ω ƒëi chi ti·∫øt c√°c b∆∞·ªõc t·ª´ l√∫c ti·∫øp nh·∫≠n raw data, cho t·ªõi l√∫c ho√†n th√†nh v√† b√°o c√°o k·∫øt qu·∫£. C√°c b·∫°n c√≥ th·ªÉ t√¨m th·∫•y `R package` gi√∫p ch·∫°y ph√¢n t√≠ch v√† cho k·∫øt qu·∫£ tr·ª±c ti·∫øp, nh∆∞ng m·ªõi m·ª•c ƒë√≠ch hi·ªÉu v√† n·∫Øm r√µ c√°c b∆∞·ªõc k·ªπ thu·∫≠t th·ªëng k√™, m√¨nh s·∫Ω h·∫°n ch·∫ø s·ª≠ d·ª•ng package m√† s·∫Ω cung c·∫•p c√°c codes t·ª± vi·∫øt ƒë·ªÉ c√°c b·∫°n n·∫Øm r√µ h∆°n. N·∫øu c√°c b·∫°n h·ª©ng th√∫ v·ªõi l√Ω thuy·∫øt ch·ª©ng minh b·∫°n c√≥ th·ªÉ tham kh·∫£o t·∫°i [proof of MAIC](https://ngoitruocgioxuan.github.io/goctuhoc/01_maic/01_maic-proof.html). Cu·ªëi c√πng, b√†i vi·∫øt c√≥ nhi·ªÅu l·ªói ƒë√°nh m√°y, v√† c√°ch tr√¨nh b√†y ƒë√¥i khi g√¢y kh√≥ hi·ªÉu, m√¨nh mong nh·∫≠n ƒë∆∞·ª£c s·ª± ƒë√≥ng g√≥p c·ªßa m·ªçi ng∆∞·ªùi ƒë·ªÉ m√¨nh kh·∫Øc ph·ª•c t·ªët h∆°n cho nh·ªØng n·ªôi dung chia s·∫Ω l·∫ßn sau. C·∫£m ∆°n m·ªçi ng∆∞·ªùi. 


<!-- ################################################################################################### -->
<!-- :::: {.blackbox data-latex=""} -->
<!-- ::: {.center data-latex=""} -->
<!-- **Proof:** -->
<!-- ::: -->
<!-- over here -->
<!-- :::: -->

# ‚ú® $\mathcal{References}$ {-}
